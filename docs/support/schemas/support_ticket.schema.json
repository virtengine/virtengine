{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://virtengine.network/schemas/support/ticket.schema.json",
  "title": "VirtEngine Support Ticket",
  "description": "Schema for VirtEngine support tickets with encryption and retention policies",
  "type": "object",
  "required": [
    "ticket_id",
    "version",
    "category",
    "priority",
    "status",
    "created_at",
    "updated_at",
    "customer_address",
    "subject",
    "description_envelope",
    "retention_policy",
    "jurisdiction_code"
  ],
  "properties": {
    "ticket_id": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Unique ticket identifier (UUID v7)"
    },
    "version": {
      "type": "integer",
      "minimum": 1,
      "maximum": 1,
      "description": "Schema version number"
    },
    "category": {
      "$ref": "#/$defs/ticketCategory"
    },
    "priority": {
      "$ref": "#/$defs/ticketPriority"
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1,
        "maxLength": 50
      },
      "maxItems": 10,
      "uniqueItems": true,
      "description": "Optional tags for categorization"
    },
    "status": {
      "$ref": "#/$defs/ticketStatus"
    },
    "created_at": {
      "type": "integer",
      "minimum": 0,
      "description": "Unix timestamp (seconds) when ticket was created"
    },
    "updated_at": {
      "type": "integer",
      "minimum": 0,
      "description": "Unix timestamp (seconds) of last update"
    },
    "closed_at": {
      "type": "integer",
      "minimum": 0,
      "description": "Unix timestamp (seconds) when ticket was closed"
    },
    "customer_address": {
      "$ref": "#/$defs/virtengineAddress"
    },
    "assigned_agent_addr": {
      "$ref": "#/$defs/virtengineAddress"
    },
    "order_ref": {
      "$ref": "#/$defs/orderReference"
    },
    "provider_ref": {
      "$ref": "#/$defs/providerReference"
    },
    "deployment_ref": {
      "$ref": "#/$defs/deploymentReference"
    },
    "related_tickets": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
      },
      "maxItems": 20,
      "uniqueItems": true,
      "description": "Related ticket IDs"
    },
    "subject": {
      "type": "string",
      "minLength": 5,
      "maxLength": 200,
      "description": "Ticket subject line (not encrypted)"
    },
    "description_envelope": {
      "$ref": "#/$defs/encryptedPayloadEnvelope"
    },
    "messages": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/ticketMessage"
      },
      "maxItems": 500,
      "description": "Thread of messages"
    },
    "attachments": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/attachmentRef"
      },
      "maxItems": 50,
      "description": "Attached files"
    },
    "contact_envelope": {
      "$ref": "#/$defs/encryptedPayloadEnvelope"
    },
    "retention_policy": {
      "$ref": "#/$defs/retentionPolicyRef"
    },
    "jurisdiction_code": {
      "type": "string",
      "pattern": "^[A-Z]{2}(-[A-Z0-9]{1,3})?$",
      "description": "ISO 3166-1 alpha-2 country code with optional subdivision"
    },
    "consent_record_id": {
      "type": "string",
      "description": "Reference to consent record for PII processing"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": {
        "type": "string",
        "maxLength": 1000
      },
      "maxProperties": 20,
      "description": "Additional key-value metadata"
    }
  },
  "$defs": {
    "ticketStatus": {
      "type": "string",
      "enum": [
        "OPEN",
        "ASSIGNED",
        "IN_PROGRESS",
        "AWAITING_CUSTOMER",
        "AWAITING_PROVIDER",
        "ESCALATED",
        "ON_HOLD",
        "RESOLVED",
        "CLOSED",
        "CANCELLED"
      ],
      "description": "Current ticket status"
    },
    "ticketCategory": {
      "type": "string",
      "enum": [
        "billing",
        "technical",
        "identity",
        "marketplace",
        "security",
        "other"
      ],
      "description": "Ticket category"
    },
    "ticketPriority": {
      "type": "string",
      "enum": [
        "low",
        "medium",
        "high",
        "critical"
      ],
      "description": "Ticket priority level"
    },
    "virtengineAddress": {
      "type": "string",
      "pattern": "^virtengine1[a-z0-9]{32,58}$",
      "description": "VirtEngine bech32 address"
    },
    "orderReference": {
      "type": "object",
      "required": ["order_id", "owner_addr", "dseq", "gseq", "oseq"],
      "properties": {
        "order_id": {
          "type": "string",
          "description": "Unique order identifier"
        },
        "owner_addr": {
          "$ref": "#/$defs/virtengineAddress"
        },
        "dseq": {
          "type": "integer",
          "minimum": 0,
          "description": "Deployment sequence"
        },
        "gseq": {
          "type": "integer",
          "minimum": 0,
          "description": "Group sequence"
        },
        "oseq": {
          "type": "integer",
          "minimum": 0,
          "description": "Order sequence"
        }
      },
      "additionalProperties": false
    },
    "providerReference": {
      "type": "object",
      "required": ["provider_addr"],
      "properties": {
        "provider_addr": {
          "$ref": "#/$defs/virtengineAddress"
        },
        "provider_name": {
          "type": "string",
          "maxLength": 100
        },
        "lease_id": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "deploymentReference": {
      "type": "object",
      "required": ["deployment_id", "owner_addr", "dseq"],
      "properties": {
        "deployment_id": {
          "type": "string"
        },
        "owner_addr": {
          "$ref": "#/$defs/virtengineAddress"
        },
        "dseq": {
          "type": "integer",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "encryptedPayloadEnvelope": {
      "type": "object",
      "required": [
        "version",
        "algorithm_id",
        "algorithm_version",
        "recipient_key_ids",
        "nonce",
        "ciphertext",
        "sender_signature",
        "sender_pub_key"
      ],
      "properties": {
        "version": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1,
          "description": "Envelope format version"
        },
        "algorithm_id": {
          "type": "string",
          "enum": [
            "X25519-XSALSA20-POLY1305",
            "AGE-X25519"
          ],
          "description": "Encryption algorithm identifier"
        },
        "algorithm_version": {
          "type": "integer",
          "minimum": 1,
          "description": "Algorithm version"
        },
        "recipient_key_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-f0-9]{40}$"
          },
          "minItems": 1,
          "maxItems": 10,
          "uniqueItems": true,
          "description": "Key fingerprints of recipients"
        },
        "recipient_public_keys": {
          "type": "array",
          "items": {
            "type": "string",
            "contentEncoding": "base64"
          },
          "description": "Optional recipient public keys"
        },
        "encrypted_keys": {
          "type": "array",
          "items": {
            "type": "string",
            "contentEncoding": "base64"
          },
          "description": "Per-recipient encrypted data keys"
        },
        "wrapped_keys": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/wrappedKeyEntry"
          },
          "description": "Wrapped DEKs per recipient"
        },
        "nonce": {
          "type": "string",
          "contentEncoding": "base64",
          "description": "Unique nonce for encryption"
        },
        "ciphertext": {
          "type": "string",
          "contentEncoding": "base64",
          "description": "Encrypted payload data"
        },
        "sender_signature": {
          "type": "string",
          "contentEncoding": "base64",
          "description": "Signature for authenticity"
        },
        "sender_pub_key": {
          "type": "string",
          "contentEncoding": "base64",
          "description": "Sender's public key"
        },
        "metadata": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Optional metadata"
        }
      },
      "additionalProperties": false
    },
    "wrappedKeyEntry": {
      "type": "object",
      "required": ["recipient_id", "wrapped_key"],
      "properties": {
        "recipient_id": {
          "type": "string",
          "pattern": "^[a-f0-9]{40}$"
        },
        "wrapped_key": {
          "type": "string",
          "contentEncoding": "base64"
        },
        "algorithm": {
          "type": "string"
        },
        "ephemeral_pub_key": {
          "type": "string",
          "contentEncoding": "base64"
        }
      },
      "additionalProperties": false
    },
    "ticketMessage": {
      "type": "object",
      "required": [
        "message_id",
        "sender_addr",
        "sender_role",
        "created_at",
        "content_envelope"
      ],
      "properties": {
        "message_id": {
          "type": "string",
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
        },
        "sender_addr": {
          "$ref": "#/$defs/virtengineAddress"
        },
        "sender_role": {
          "type": "string",
          "enum": [
            "customer",
            "support_agent",
            "moderator",
            "administrator",
            "service_provider",
            "system"
          ]
        },
        "created_at": {
          "type": "integer",
          "minimum": 0
        },
        "content_envelope": {
          "$ref": "#/$defs/encryptedPayloadEnvelope"
        },
        "is_internal": {
          "type": "boolean",
          "default": false,
          "description": "Internal notes not visible to customer"
        }
      },
      "additionalProperties": false
    },
    "attachmentRef": {
      "type": "object",
      "required": [
        "attachment_id",
        "file_name",
        "content_type",
        "size_bytes",
        "storage_location",
        "uploaded_at",
        "uploaded_by",
        "checksum_sha256",
        "key_envelope"
      ],
      "properties": {
        "attachment_id": {
          "type": "string",
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
        },
        "file_name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "pattern": "^[^\\\\/:*?\"<>|]+$"
        },
        "content_type": {
          "type": "string",
          "enum": [
            "image/png",
            "image/jpeg",
            "image/gif",
            "image/webp",
            "application/pdf",
            "text/plain",
            "text/csv",
            "application/json",
            "application/zip",
            "application/gzip",
            "video/mp4",
            "video/webm"
          ],
          "description": "Allowed MIME types"
        },
        "size_bytes": {
          "type": "integer",
          "minimum": 1,
          "maximum": 52428800,
          "description": "File size (max 50MB)"
        },
        "storage_location": {
          "type": "string",
          "description": "IPFS CID or storage path"
        },
        "uploaded_at": {
          "type": "integer",
          "minimum": 0
        },
        "uploaded_by": {
          "$ref": "#/$defs/virtengineAddress"
        },
        "checksum_sha256": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "key_envelope": {
          "$ref": "#/$defs/encryptedPayloadEnvelope"
        }
      },
      "additionalProperties": false
    },
    "retentionPolicyRef": {
      "type": "object",
      "required": ["policy_id", "retention_days", "delete_after_closed"],
      "properties": {
        "policy_id": {
          "type": "string",
          "enum": [
            "gdpr",
            "ccpa",
            "us_general",
            "uk_gdpr",
            "global",
            "legal_hold"
          ]
        },
        "retention_days": {
          "type": "integer",
          "minimum": 0,
          "maximum": 3650,
          "description": "Days to retain after closure (0 for indefinite)"
        },
        "delete_after_closed": {
          "type": "boolean",
          "description": "Whether to delete after retention period"
        },
        "archive_after_days": {
          "type": "integer",
          "minimum": 0,
          "description": "Days before archiving to cold storage"
        }
      },
      "additionalProperties": false
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "status": {
            "enum": ["CLOSED", "CANCELLED"]
          }
        }
      },
      "then": {
        "required": ["closed_at"]
      }
    }
  ]
}
