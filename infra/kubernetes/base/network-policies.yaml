# Network Policies for VirtEngine namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: virtengine
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-virtengine-internal
  namespace: virtengine
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/part-of: virtengine
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              app.kubernetes.io/name: virtengine
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: virtengine
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-virtengine-node-p2p
  namespace: virtengine
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: virtengine-node
  policyTypes:
    - Ingress
  ingress:
    # Allow P2P from anywhere (external validators)
    - ports:
        - port: 26656
          protocol: TCP
    # Allow RPC/gRPC from internal services
    - from:
        - namespaceSelector:
            matchLabels:
              app.kubernetes.io/name: virtengine
      ports:
        - port: 26657
          protocol: TCP
        - port: 1317
          protocol: TCP
        - port: 9090
          protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-provider-daemon-api
  namespace: virtengine
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: provider-daemon
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              app.kubernetes.io/name: virtengine
        - namespaceSelector:
            matchLabels:
              name: istio-system
      ports:
        - port: 8443
          protocol: TCP
        - port: 8444
          protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scrape
  namespace: virtengine
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/part-of: virtengine
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - port: 26660
          protocol: TCP
        - port: 8445
          protocol: TCP
