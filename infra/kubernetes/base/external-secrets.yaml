# External Secrets Operator - ClusterSecretStore for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
---
# External Secrets Operator - ClusterSecretStore for Vault
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault
spec:
  provider:
    vault:
      server: "https://vault.virtengine.internal:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
---
# VirtEngine Node Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: virtengine-node-secrets
  namespace: virtengine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: virtengine-node-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        node-key: "{{ .nodeKey }}"
        priv-validator-key: "{{ .privValidatorKey }}"
  data:
    - secretKey: nodeKey
      remoteRef:
        key: virtengine/prod/node/node-key
    - secretKey: privValidatorKey
      remoteRef:
        key: virtengine/prod/node/priv-validator-key
---
# Provider Daemon Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: provider-daemon-secrets
  namespace: virtengine
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: provider-daemon-secrets
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: providerKey
      remoteRef:
        key: virtengine/prod/provider/provider-key
    - secretKey: walletMnemonic
      remoteRef:
        key: virtengine/prod/provider/wallet-mnemonic
---
# Database Credentials (rotated automatically)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: virtengine
spec:
  refreshInterval: 15m  # More frequent for rotated credentials
  secretStoreRef:
    name: vault
    kind: ClusterSecretStore
  target:
    name: database-credentials
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: database/creds/virtengine-app
        property: username
    - secretKey: password
      remoteRef:
        key: database/creds/virtengine-app
        property: password
