# VirtEngine DR Backup CronJobs
# Automated backup scheduling for disaster recovery
#
# These CronJobs run automated backups across all regions:
# - Chain state backups every 4 hours
# - Key backups daily at 2 AM UTC
# - DR validation tests daily at 6 AM UTC

---
apiVersion: v1
kind: Namespace
metadata:
  name: dr-system
  labels:
    name: dr-system
    virtengine.io/managed-by: terraform

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dr-backup-sa
  namespace: dr-system
  annotations:
    eks.amazonaws.com/role-arn: "${DR_BACKUP_IAM_ROLE_ARN}"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dr-backup-role
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/exec", "pods/log"]
    verbs: ["get", "list", "create"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list"]
  - apiGroups: ["apps"]
    resources: ["statefulsets", "deployments"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dr-backup-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dr-backup-role
subjects:
  - kind: ServiceAccount
    name: dr-backup-sa
    namespace: dr-system

---
# Chain State Backup - Every 4 hours
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dr-backup-chain-state
  namespace: dr-system
  labels:
    app: dr-backup
    component: chain-state
spec:
  schedule: "0 */4 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400  # 24 hours
      template:
        metadata:
          labels:
            app: dr-backup
            component: chain-state
        spec:
          serviceAccountName: dr-backup-sa
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: virtengine/dr-tools:latest
              imagePullPolicy: Always
              command: ["/scripts/dr/backup-chain-state.sh"]
              env:
                - name: DR_BUCKET
                  value: "s3://virtengine-dr-backups"
                - name: NODE_HOME
                  value: "/opt/virtengine"
                - name: SNAPSHOT_DIR
                  value: "/data/snapshots"
                - name: RETENTION_COUNT
                  value: "10"
                - name: AWS_REGION
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.annotations['eks.amazonaws.com/region']
              volumeMounts:
                - name: node-data
                  mountPath: /opt/virtengine
                  readOnly: true
                - name: snapshots
                  mountPath: /data/snapshots
              resources:
                requests:
                  cpu: 500m
                  memory: 2Gi
                limits:
                  cpu: 2000m
                  memory: 4Gi
          volumes:
            - name: node-data
              persistentVolumeClaim:
                claimName: validator-data
            - name: snapshots
              persistentVolumeClaim:
                claimName: snapshot-storage

---
# Key Backup - Daily at 2 AM UTC
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dr-backup-keys
  namespace: dr-system
  labels:
    app: dr-backup
    component: keys
spec:
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: dr-backup
            component: keys
        spec:
          serviceAccountName: dr-backup-sa
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: virtengine/dr-tools:latest
              imagePullPolicy: Always
              command: ["/scripts/dr/backup-keys.sh", "--type", "all"]
              env:
                - name: DR_BUCKET
                  value: "s3://virtengine-dr-backups"
                - name: KEY_DIR
                  value: "/opt/virtengine/config"
                - name: BACKUP_DIR
                  value: "/secure/backups"
                - name: HSM_ENABLED
                  value: "0"
                - name: AWS_REGION
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.annotations['eks.amazonaws.com/region']
              volumeMounts:
                - name: keys
                  mountPath: /opt/virtengine/config
                  readOnly: true
                - name: backup-storage
                  mountPath: /secure/backups
              resources:
                requests:
                  cpu: 200m
                  memory: 512Mi
                limits:
                  cpu: 500m
                  memory: 1Gi
          volumes:
            - name: keys
              secret:
                secretName: validator-keys
                optional: true
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-storage

---
# DR Tests - Daily at 6 AM UTC
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dr-tests
  namespace: dr-system
  labels:
    app: dr-test
    component: validation
spec:
  schedule: "0 6 * * *"
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 5
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 1
      ttlSecondsAfterFinished: 172800  # 48 hours
      template:
        metadata:
          labels:
            app: dr-test
            component: validation
        spec:
          serviceAccountName: dr-backup-sa
          restartPolicy: OnFailure
          containers:
            - name: test
              image: virtengine/dr-tools:latest
              imagePullPolicy: Always
              command: ["/scripts/dr/dr-test.sh", "--report", "--notify"]
              env:
                - name: DR_BUCKET
                  value: "s3://virtengine-dr-backups"
                - name: TEST_ENVIRONMENT
                  value: "production"
                - name: RESULTS_DIR
                  value: "/var/log/dr-tests"
                - name: SLACK_WEBHOOK
                  valueFrom:
                    secretKeyRef:
                      name: dr-secrets
                      key: slack-webhook
                      optional: true
                - name: AWS_REGION
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.annotations['eks.amazonaws.com/region']
              volumeMounts:
                - name: test-results
                  mountPath: /var/log/dr-tests
              resources:
                requests:
                  cpu: 200m
                  memory: 512Mi
                limits:
                  cpu: 1000m
                  memory: 1Gi
          volumes:
            - name: test-results
              emptyDir: {}

---
# PersistentVolumeClaim for snapshots
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: snapshot-storage
  namespace: dr-system
  labels:
    app: dr-backup
    component: storage
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: gp3-encrypted
  resources:
    requests:
      storage: 500Gi

---
# PersistentVolumeClaim for key backups
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-storage
  namespace: dr-system
  labels:
    app: dr-backup
    component: storage
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: gp3-encrypted
  resources:
    requests:
      storage: 50Gi
