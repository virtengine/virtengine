# Provider Daemon Chaos Workflow for LitmusChaos
# Automated chaos testing for VirtEngine provider daemons

apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: provider-chaos-workflow
  namespace: litmus
  labels:
    app.kubernetes.io/part-of: virtengine
    chaos.virtengine.io/target: provider
spec:
  schedule: "0 3 * * *"  # Run daily at 3 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  suspend: false
  workflowSpec:
    entrypoint: provider-chaos-pipeline
    serviceAccountName: litmus-admin
    arguments:
      parameters:
        - name: chaos-namespace
          value: virtengine
        - name: app-label
          value: app.kubernetes.io/component=provider-daemon
        - name: chaos-duration
          value: "180"
    templates:
      - name: provider-chaos-pipeline
        steps:
          # Step 1: Pre-chaos verification
          - - name: pre-chaos-check
              template: health-check
          
          # Step 2: Provider pod crash test
          - - name: pod-crash-test
              template: pod-crash
          
          # Step 3: Verify auto-recovery
          - - name: recovery-check
              template: health-check
          
          # Step 4: Network latency test
          - - name: network-latency-test
              template: network-latency
          
          # Step 5: Verify continued operation
          - - name: latency-impact-check
              template: health-check
          
          # Step 6: Memory stress test
          - - name: memory-stress-test
              template: memory-stress
          
          # Step 7: Final health check
          - - name: final-check
              template: health-check

      - name: health-check
        container:
          image: curlimages/curl:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Checking provider daemon health..."
              response=$(curl -s -o /dev/null -w "%{http_code}" http://provider-daemon.virtengine:8443/health || echo "000")
              if [ "$response" != "200" ]; then
                echo "Provider daemon unhealthy: HTTP $response"
                exit 1
              fi
              echo "Provider daemon healthy"

      - name: pod-crash
        container:
          image: litmuschaos/litmus-checker:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Starting provider pod crash test..."
              cat <<EOF | kubectl apply -f -
              apiVersion: litmuschaos.io/v1alpha1
              kind: ChaosEngine
              metadata:
                name: provider-pod-crash-engine
                namespace: {{workflow.parameters.chaos-namespace}}
              spec:
                engineState: active
                appinfo:
                  appns: {{workflow.parameters.chaos-namespace}}
                  applabel: "{{workflow.parameters.app-label}}"
                  appkind: deployment
                chaosServiceAccount: litmus-admin
                experiments:
                  - name: pod-delete
                    spec:
                      components:
                        env:
                          - name: TOTAL_CHAOS_DURATION
                            value: "30"
                          - name: FORCE
                            value: "true"
              EOF
              
              echo "Waiting for recovery..."
              sleep 90

      - name: network-latency
        container:
          image: litmuschaos/litmus-checker:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Starting network latency test..."
              cat <<EOF | kubectl apply -f -
              apiVersion: litmuschaos.io/v1alpha1
              kind: ChaosEngine
              metadata:
                name: provider-network-latency-engine
                namespace: {{workflow.parameters.chaos-namespace}}
              spec:
                engineState: active
                appinfo:
                  appns: {{workflow.parameters.chaos-namespace}}
                  applabel: "{{workflow.parameters.app-label}}"
                  appkind: deployment
                chaosServiceAccount: litmus-admin
                experiments:
                  - name: pod-network-latency
                    spec:
                      components:
                        env:
                          - name: TOTAL_CHAOS_DURATION
                            value: "120"
                          - name: NETWORK_LATENCY
                            value: "500"
                          - name: JITTER
                            value: "100"
              EOF
              
              echo "Waiting for experiment..."
              sleep 150

      - name: memory-stress
        container:
          image: litmuschaos/litmus-checker:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Starting memory stress test..."
              cat <<EOF | kubectl apply -f -
              apiVersion: litmuschaos.io/v1alpha1
              kind: ChaosEngine
              metadata:
                name: provider-memory-stress-engine
                namespace: {{workflow.parameters.chaos-namespace}}
              spec:
                engineState: active
                appinfo:
                  appns: {{workflow.parameters.chaos-namespace}}
                  applabel: "{{workflow.parameters.app-label}}"
                  appkind: deployment
                chaosServiceAccount: litmus-admin
                experiments:
                  - name: pod-memory-hog
                    spec:
                      components:
                        env:
                          - name: TOTAL_CHAOS_DURATION
                            value: "120"
                          - name: MEMORY_CONSUMPTION
                            value: "500"
              EOF
              
              echo "Waiting for experiment..."
              sleep 150
