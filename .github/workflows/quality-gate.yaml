# VirtEngine Quality Gate - Fast PR checks
#
# Minimal, required checks for PRs (lint/build/test-go) to keep feedback fast.
# Full CI runs on push to main/develop via ci.yaml.

name: Quality Gate

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - mainnet/main
      - develop
      - "release/**"

concurrency:
  group: quality-gate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.25.5"
  GOWORK: "off" # Disable workspace mode for vendor operations
  GO_TEST_TIMEOUT_UNIT: "30m"

permissions:
  contents: read

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch base ref for lint diff
        run: |
          git fetch origin "${{ github.base_ref || 'main' }}" --depth=1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run golangci-lint (PR diff)
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.4.0
          args: --timeout=10m --new-from-rev=origin/${{ github.base_ref || 'main' }}

  vet:
    name: vet
    runs-on: ubuntu-latest
    needs: [lint]
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run go vet
        env:
          GOFLAGS: "-mod=readonly"
        run: go vet ./...

  build:
    name: build
    runs-on: ubuntu-latest
    needs: [lint, vet]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build binaries
        run: |
          go build -mod=readonly -v ./cmd/...

  test-go:
    name: test-go
    runs-on: ubuntu-latest
    needs: [lint, vet]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run core tests
        run: |
          go test -mod=readonly -v -short -race -timeout ${{ env.GO_TEST_TIMEOUT_UNIT }} \
            ./pkg/benchmark/... \
            ./pkg/cache/... \
            ./pkg/compatibility/... \
            ./pkg/enclave_runtime/... \
            ./pkg/errors/... \
            ./pkg/inference/... \
            ./pkg/pruning/... \
            ./pkg/ratelimit/... \
            ./pkg/waldur/... \
            ./pkg/workflow/... \
            ./x/enclave/... \
            ./x/encryption/...
