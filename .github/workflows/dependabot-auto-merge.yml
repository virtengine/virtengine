# Auto-merge Dependabot PRs after all CI checks pass.
# Only merges patch and minor updates to keep risk low.
# Controlled by the DEPENDABOT_AUTO_MERGE repository variable:
#   - Set to "true" (or leave absent) to enable
#   - Set to "false" to disable without removing the workflow
#
# This workflow complements the monitor's built-in dependabot auto-merge
# (DEPENDABOT_AUTO_MERGE env var) and serves as a reliable fallback when
# the codex-monitor process is not running.

name: Dependabot Auto-Merge
on: pull_request

permissions:
    contents: write
    pull-requests: write

jobs:
    dependabot:
        runs-on: ubuntu-latest
        if: github.actor == 'dependabot[bot]'
        steps:
            - name: Check auto-merge toggle
              id: toggle
              run: |
                  # Default to enabled if var is not set
                  ENABLED="${{ vars.DEPENDABOT_AUTO_MERGE }}"
                  if [ "$ENABLED" = "false" ] || [ "$ENABLED" = "0" ]; then
                    echo "skip=true" >> "$GITHUB_OUTPUT"
                    echo "::notice::Dependabot auto-merge is disabled via DEPENDABOT_AUTO_MERGE repository variable"
                  else
                    echo "skip=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Fetch Dependabot metadata
              if: steps.toggle.outputs.skip != 'true'
              id: metadata
              uses: dependabot/fetch-metadata@v2
              with:
                  github-token: "${{ secrets.GITHUB_TOKEN }}"

            - name: Auto-approve patch & minor updates
              if: >
                  steps.toggle.outputs.skip != 'true' &&
                  contains(fromJSON('["version-update:semver-patch", "version-update:semver-minor"]'), steps.metadata.outputs.update-type)
              run: gh pr review --approve "$PR_URL"
              env:
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Enable auto-merge (squash)
              if: >
                  steps.toggle.outputs.skip != 'true' &&
                  contains(fromJSON('["version-update:semver-patch", "version-update:semver-minor"]'), steps.metadata.outputs.update-type)
              run: gh pr merge --auto --squash "$PR_URL"
              env:
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Skip major updates
              if: >
                  steps.toggle.outputs.skip != 'true' &&
                  steps.metadata.outputs.update-type == 'version-update:semver-major'
              run: |
                  echo "::warning::Major version bump detected (${{ steps.metadata.outputs.dependency-names }}). Skipping auto-merge â€” requires manual review."
