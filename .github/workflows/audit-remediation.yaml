name: Audit Finding Remediation

permissions:
  contents: read
  issues: write

on:
  issues:
    types: [opened, edited, labeled]

jobs:
  triage:
    if: contains(github.event.issue.labels.*.name, 'audit-finding')
    runs-on: ubuntu-latest
    outputs:
      severity: ${{ steps.severity.outputs.severity }}
    steps:
      - name: Parse finding severity
        id: severity
        shell: bash
        run: |
          BODY="${{ github.event.issue.body }}"
          if [[ "$BODY" == *"CRITICAL"* ]]; then
            echo "severity=critical" >> "$GITHUB_OUTPUT"
          elif [[ "$BODY" == *"HIGH"* ]]; then
            echo "severity=high" >> "$GITHUB_OUTPUT"
          elif [[ "$BODY" == *"MEDIUM"* ]]; then
            echo "severity=medium" >> "$GITHUB_OUTPUT"
          else
            echo "severity=other" >> "$GITHUB_OUTPUT"
          fi

      - name: Assign critical findings
        if: steps.severity.outputs.severity == 'critical'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: ['security-lead', 'cto']
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['priority-p0', 'blocks-mainnet']
            });

  notify:
    needs: triage
    runs-on: ubuntu-latest
    if: needs.triage.result == 'success'
    steps:
      - name: Notify security team
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: 'C0XXXXXX' # #security-alerts
          slack-message: |
            ðŸš¨ New audit finding: ${{ github.event.issue.title }}
            Severity: ${{ needs.triage.outputs.severity }}
            Link: ${{ github.event.issue.html_url }}
