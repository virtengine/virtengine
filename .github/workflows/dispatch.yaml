---
# Dispatch Workflows for VirtEngine Release Notifications
#
# This workflow triggers downstream homebrew-tap workflows when releases are published.
# Uses a matrix strategy to reduce code duplication.
#
# REQUIRED SECRETS:
#   GORELEASER_ACCESS_TOKEN - Personal Access Token (PAT) with permissions:
#     - repo (Full control of private repositories)
#     - workflow (Update GitHub Action workflows)
#   
#   To configure:
#   1. Go to GitHub → Settings → Developer settings → Personal access tokens → Fine-grained tokens
#   2. Create a new token with access to virtengine/homebrew-tap repository
#   3. Grant "Contents" (read/write) and "Actions" (read/write) permissions
#   4. Add the token as a repository secret named GORELEASER_ACCESS_TOKEN
#   5. Go to repository Settings → Secrets and variables → Actions → New repository secret
#
# If GORELEASER_ACCESS_TOKEN is not configured, the workflow will skip gracefully.
# Alternatively, for same-org repos, GITHUB_TOKEN may work if workflow permissions allow.

name: dispatch

defaults:
  run:
    shell: bash

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"  # Only trigger on version tags (v1.0.0, v1.0.0-rc1, etc.)

jobs:
  # Consolidated dispatch job using matrix strategy
  dispatch-homebrew:
    runs-on: ubuntu-latest
    # Skip if GORELEASER_ACCESS_TOKEN is not configured
    if: ${{ secrets.GORELEASER_ACCESS_TOKEN != '' }}
    strategy:
      matrix:
        include:
          - name: virtengine
            workflow: virtengine
          - name: provider-services
            workflow: provider-services
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set release tag
        run: echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Check if pre-release
        id: check
        run: |
          is_prerelease=$(./script/is_prerelease.sh ${{ env.RELEASE_TAG }}; echo $?)
          echo "is_prerelease=${is_prerelease}" >> $GITHUB_OUTPUT

      - name: Notify homebrew-tap with new ${{ matrix.name }} release
        if: steps.check.outputs.is_prerelease == '1'
        uses: benc-uk/workflow-dispatch@v1
        with:
          token: ${{ secrets.GORELEASER_ACCESS_TOKEN }}
          repo: virtengine/homebrew-tap
          workflow: ${{ matrix.workflow }}
          ref: refs/heads/main
          inputs: '{"tag": "${{ env.RELEASE_TAG }}"}'
