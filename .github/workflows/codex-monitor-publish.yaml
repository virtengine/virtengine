# Publish @virtengine/codex-monitor to npm
#
# Triggers:
#   1. Push to main that changes scripts/codex-monitor/** (auto-publish)
#   2. Manual dispatch with optional version bump
#
# Security:
#   - Uses NPM_TOKEN secret for authentication
#   - Provenance attestation generated via --provenance flag
#   - Version bump detection prevents redundant publishes
#
# Prerequisites:
#   1. Create an npm access token (Granular or Automation type) at
#      https://www.npmjs.com/settings/<user>/tokens
#   2. Add it as a repository secret named NPM_TOKEN
#      (Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret)
#   3. If using an environment, add it to the "npm-publish" environment instead

name: "Codex Monitor: Publish"

env:
    NODE_VERSION: "20"

on:
    push:
        branches: [main]
        paths:
            - "scripts/codex-monitor/**"
            - "!scripts/codex-monitor/.env*"
            - "!scripts/codex-monitor/logs/**"
            - "!scripts/codex-monitor/*.config.json"
            - "!scripts/codex-monitor/workspaces.json"
    workflow_dispatch:
        inputs:
            dry-run:
                description: "Dry run (skip actual publish)"
                type: boolean
                default: false
            force:
                description: "Force publish even if version unchanged"
                type: boolean
                default: false

concurrency:
    group: codex-monitor-publish
    cancel-in-progress: false # never cancel an in-flight publish

permissions:
    contents: read
    id-token: write # Required for provenance attestation

jobs:
    # â”€â”€â”€ Gate: only proceed if the package.json version is newer than registry â”€â”€
    check:
        name: Version Check
        runs-on: ubuntu-latest
        outputs:
            should-publish: ${{ steps.compare.outputs.should-publish }}
            local-version: ${{ steps.compare.outputs.local-version }}
            registry-version: ${{ steps.compare.outputs.registry-version }}
        steps:
            - uses: actions/checkout@v4
              with:
                  sparse-checkout: scripts/codex-monitor

            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  registry-url: "https://registry.npmjs.org"
                  cache: "npm"
                  cache-dependency-path: scripts/codex-monitor/package-lock.json

            - name: Compare versions
              id: compare
              working-directory: scripts/codex-monitor
              run: |
                  LOCAL=$(node -p "require('./package.json').version")
                  echo "local-version=$LOCAL" >> "$GITHUB_OUTPUT"

                  # Fetch registry version (may 404 if first publish)
                  REGISTRY=$(npm view @virtengine/codex-monitor version 2>/dev/null || echo "0.0.0")
                  echo "registry-version=$REGISTRY" >> "$GITHUB_OUTPUT"

                  # Semver comparison via node
                  DOMINATED=$(node -e "
                    const [a, b] = ['$LOCAL', '$REGISTRY'].map(v => v.split('.').map(Number));
                    const newer = a[0] > b[0] || (a[0] === b[0] && a[1] > b[1]) || (a[0] === b[0] && a[1] === b[1] && a[2] > b[2]);
                    console.log(newer ? 'true' : 'false');
                  ")

                  FORCE="${{ inputs.force }}"
                  if [ "$DOMINATED" = "true" ] || [ "$FORCE" = "true" ]; then
                    echo "should-publish=true" >> "$GITHUB_OUTPUT"
                    echo "ðŸ“¦ Will publish: $LOCAL (registry: $REGISTRY)"
                  else
                    echo "should-publish=false" >> "$GITHUB_OUTPUT"
                    echo "â­ï¸ Skipping: $LOCAL is not newer than $REGISTRY"
                  fi

    # â”€â”€â”€ Publish with OIDC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    publish:
        name: Publish to npm
        needs: check
        if: needs.check.outputs.should-publish == 'true'
        runs-on: ubuntu-latest
        environment: npm-publish # matches the environment in trusted publisher config
        steps:
            - uses: actions/checkout@v4
              with:
                  sparse-checkout: scripts/codex-monitor

            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  registry-url: "https://registry.npmjs.org"
                  cache: "npm"
                  cache-dependency-path: scripts/codex-monitor/package-lock.json

            - name: Install dependencies
              working-directory: scripts/codex-monitor
              run: npm install --ignore-scripts

            - name: Test
              working-directory: scripts/codex-monitor
              run: npm test

            - name: Publish
              if: ${{ !inputs.dry-run }}
              working-directory: scripts/codex-monitor
              run: npm publish --access public --provenance
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Publish (dry run)
              if: ${{ inputs.dry-run }}
              working-directory: scripts/codex-monitor
              run: npm publish --access public --dry-run
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Verify publication
              if: ${{ !inputs.dry-run }}
              run: |
                  echo "â³ Waiting for registry propagation..."
                  sleep 10
                  PUBLISHED=$(npm view @virtengine/codex-monitor version 2>/dev/null || echo "NOT_FOUND")
                  EXPECTED="${{ needs.check.outputs.local-version }}"
                  if [ "$PUBLISHED" = "$EXPECTED" ]; then
                    echo "âœ… Successfully published @virtengine/codex-monitor@$PUBLISHED"
                  else
                    echo "âš ï¸ Registry shows $PUBLISHED, expected $EXPECTED (may still be propagating)"
                  fi

            - name: Summary
              run: |
                  echo "## ðŸ“¦ Codex Monitor Publish" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
                  echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Package | \`@virtengine/codex-monitor\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Version | \`${{ needs.check.outputs.local-version }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Previous | \`${{ needs.check.outputs.registry-version }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Dry Run | \`${{ inputs.dry-run || 'false' }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Trigger | \`${{ github.event_name }}\` |" >> "$GITHUB_STEP_SUMMARY"
