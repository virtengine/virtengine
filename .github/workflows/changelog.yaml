# INFRA-003: Automated Changelog Generation Workflow
# Generates changelog from conventional commits on release
#
# Features:
#   - Automatic changelog generation using git-chglog
#   - PR creation with changelog updates
#   - Release notes generation
#   - Conventional commit parsing

name: Changelog

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      dry_run:
        description: "Dry run (don't create PR)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  GIT_CHGLOG_VERSION: "0.15.4"

jobs:
  # ===========================================================================
  # Generate Changelog
  # ===========================================================================
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install git-chglog
        run: |
          curl -sSL "https://github.com/git-chglog/git-chglog/releases/download/v${GIT_CHGLOG_VERSION}/git-chglog_${GIT_CHGLOG_VERSION}_linux_amd64.tar.gz" | tar -xz
          sudo mv git-chglog /usr/local/bin/
          git-chglog --version

      - name: Generate changelog
        run: |
          # Generate full changelog
          git-chglog --output CHANGELOG.md

          # Generate release notes for this version only
          git-chglog ${{ steps.version.outputs.version }} > RELEASE_NOTES.md

          echo "=== Generated Changelog Preview ==="
          head -100 CHANGELOG.md

          echo ""
          echo "=== Release Notes ==="
          cat RELEASE_NOTES.md

      - name: Generate changelog summary
        id: summary
        run: |
          # Count changes by type
          FEATURES=$(grep -c "^### Features" CHANGELOG.md 2>/dev/null || echo "0")
          FIXES=$(grep -c "^### Bug Fixes" CHANGELOG.md 2>/dev/null || echo "0")
          BREAKING=$(grep -c "BREAKING CHANGE" CHANGELOG.md 2>/dev/null || echo "0")

          # Create summary
          SUMMARY="Changelog generated for ${{ steps.version.outputs.version }}"

          if [ "$BREAKING" -gt "0" ]; then
            SUMMARY="$SUMMARY (includes breaking changes)"
          fi

          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: Upload changelog artifacts
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: |
            CHANGELOG.md
            RELEASE_NOTES.md
          retention-days: 90

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet CHANGELOG.md 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create changelog PR
        if: steps.changes.outputs.changed == 'true' && (inputs.dry_run != true)
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update changelog for ${{ steps.version.outputs.version }}"
          title: "docs: Update CHANGELOG for ${{ steps.version.outputs.version }}"
          body: |
            ## Changelog Update

            This PR updates the CHANGELOG.md for release **${{ steps.version.outputs.version }}**.

            ### Summary
            ${{ steps.summary.outputs.summary }}

            ### Changes
            - Updated CHANGELOG.md with all changes since last release
            - Generated release notes

            ---
            *This PR was automatically generated by the changelog workflow.*
          branch: changelog/${{ steps.version.outputs.version }}
          base: main
          labels: |
            documentation
            automated
          delete-branch: true

      - name: Update release notes
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          append_body: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Validate Conventional Commits
  # ===========================================================================
  validate-commits:
    name: Validate Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Validate commit messages
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, checking all commits"
            COMMITS=$(git log --format="%s" HEAD)
          else
            echo "Checking commits between $PREV_TAG and $CURRENT_TAG"
            COMMITS=$(git log --format="%s" ${PREV_TAG}..${CURRENT_TAG})
          fi

          # Conventional commit pattern
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .+"

          INVALID=0
          while IFS= read -r commit; do
            if [[ ! "$commit" =~ $PATTERN ]]; then
              # Skip merge commits
              if [[ ! "$commit" =~ ^Merge ]]; then
                echo "⚠️ Non-conventional commit: $commit"
                INVALID=$((INVALID + 1))
              fi
            fi
          done <<< "$COMMITS"

          if [ $INVALID -gt 0 ]; then
            echo "::warning::Found $INVALID non-conventional commits. Consider using conventional commits for better changelog generation."
          else
            echo "✅ All commits follow conventional commit format"
          fi

  # ===========================================================================
  # Generate Release Statistics
  # ===========================================================================
  release-stats:
    name: Release Statistics
    runs-on: ubuntu-latest
    needs: generate-changelog
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: .

      - name: Generate statistics
        run: |
          # Determine version
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "# Release Statistics for $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$PREV_TAG" ]; then
            # Commit statistics
            TOTAL_COMMITS=$(git rev-list --count ${PREV_TAG}..HEAD)
            CONTRIBUTORS=$(git log --format="%aN" ${PREV_TAG}..HEAD | sort -u | wc -l)

            echo "## Commit Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- Total commits: $TOTAL_COMMITS" >> $GITHUB_STEP_SUMMARY
            echo "- Contributors: $CONTRIBUTORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # File changes
            echo "## File Changes" >> $GITHUB_STEP_SUMMARY
            git diff --stat ${PREV_TAG}..HEAD | tail -1 >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Top contributors
            echo "## Top Contributors" >> $GITHUB_STEP_SUMMARY
            git log --format="%aN" ${PREV_TAG}..HEAD | sort | uniq -c | sort -rn | head -5 >> $GITHUB_STEP_SUMMARY
          else
            echo "First release - no previous tag for comparison" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changelog Preview" >> $GITHUB_STEP_SUMMARY
          echo '```markdown' >> $GITHUB_STEP_SUMMARY
          head -50 RELEASE_NOTES.md >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
