# Fuzz Testing Workflow for VirtEngine
#
# Runs Go native fuzz tests on PRs and nightly builds
# Integrates with OSS-Fuzz for continuous fuzzing
#
# Task Reference: QUALITY-001 - Fuzz Testing Implementation

name: Fuzz Testing

on:
  push:
    branches:
      - main
      - mainnet/main
  pull_request:
    branches:
      - main
      - mainnet/main
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      fuzz_time:
        description: 'Fuzz test duration per target (e.g., 30s, 5m)'
        required: false
        default: '30s'

permissions:
  contents: read
  security-events: write

jobs:
  fuzz-tests:
    name: Fuzz Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Determine fuzz time
        id: fuzz-time
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "duration=5m" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.fuzz_time }}" != "" ]; then
            echo "duration=${{ github.event.inputs.fuzz_time }}" >> $GITHUB_OUTPUT
          else
            echo "duration=30s" >> $GITHUB_OUTPUT
          fi

      - name: Run encryption crypto fuzz tests
        run: |
          go test -fuzz=. -fuzztime=${{ steps.fuzz-time.outputs.duration }} ./x/encryption/crypto/...
        continue-on-error: true

      - name: Run encryption types fuzz tests
        run: |
          go test -fuzz=. -fuzztime=${{ steps.fuzz-time.outputs.duration }} ./x/encryption/types/...
        continue-on-error: true

      - name: Run VEID types fuzz tests
        run: |
          go test -fuzz=. -fuzztime=${{ steps.fuzz-time.outputs.duration }} ./x/veid/types/...
        continue-on-error: true

      - name: Run marketplace types fuzz tests
        run: |
          go test -fuzz=. -fuzztime=${{ steps.fuzz-time.outputs.duration }} ./x/market/types/marketplace/...
        continue-on-error: true

      - name: Run MFA types fuzz tests
        run: |
          go test -fuzz=. -fuzztime=${{ steps.fuzz-time.outputs.duration }} ./x/mfa/types/...
        continue-on-error: true

      # Provider daemon and enclave fuzz tests are currently disabled due to pre-existing
      # compilation issues in those packages. They will be re-enabled once those issues
      # are resolved.
      # - name: Run provider daemon fuzz tests
      #   run: |
      #     go test -fuzz=. -fuzztime=${{ steps.fuzz-time.outputs.duration }} ./pkg/provider_daemon/...
      #   continue-on-error: true

      - name: Upload fuzz corpus artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus
          path: |
            **/testdata/fuzz/**
          retention-days: 30
          if-no-files-found: ignore

  oss-fuzz-build:
    name: OSS-Fuzz Build Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install go-fuzz
        run: |
          go install github.com/dvyukov/go-fuzz/go-fuzz@latest
          go install github.com/dvyukov/go-fuzz/go-fuzz-build@latest

      - name: Verify fuzz targets compile
        run: |
          # Compile fuzz targets to verify they work
          # Note: pkg/provider_daemon and x/enclave/types have pre-existing issues
          for pkg in x/encryption/crypto x/encryption/types x/veid/types x/market/types/marketplace x/mfa/types; do
            echo "Checking fuzz targets in $pkg..."
            go test -c ./$pkg 2>&1 || echo "Warning: $pkg compilation issues"
          done

      - name: Check OSS-Fuzz configuration
        run: |
          # Verify OSS-Fuzz files exist
          test -f fuzz/project.yaml || { echo "Missing fuzz/project.yaml"; exit 1; }
          test -f fuzz/build.sh || { echo "Missing fuzz/build.sh"; exit 1; }
          test -f fuzz/Dockerfile || { echo "Missing fuzz/Dockerfile"; exit 1; }
          echo "OSS-Fuzz configuration verified"

  fuzz-security-audit:
    name: Fuzz Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: fuzz-tests
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Generate fuzz coverage summary
        run: |
          echo "# Fuzz Test Coverage Summary" > fuzz-summary.md
          echo "Generated: $(date -u)" >> fuzz-summary.md
          echo "" >> fuzz-summary.md

          # List fuzz test files
          echo "## Fuzz Test Files" >> fuzz-summary.md
          find . -name '*_fuzz_test.go' | while read f; do
            echo "- $f" >> fuzz-summary.md
          done
          echo "" >> fuzz-summary.md

          # Count fuzz tests
          echo "## Fuzz Test Counts" >> fuzz-summary.md
          for pkg in x/encryption/crypto x/encryption/types x/veid/types x/market/types/marketplace x/mfa/types pkg/provider_daemon; do
            count=$(grep -r "^func Fuzz" ./$pkg 2>/dev/null | wc -l || echo 0)
            echo "- $pkg: $count fuzz tests" >> fuzz-summary.md
          done

          cat fuzz-summary.md

      - name: Upload fuzz summary
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-summary
          path: fuzz-summary.md
          retention-days: 90
