---
name: compatibility

permissions:
  contents: read

defaults:
  run:
    shell: bash

on:
  # Only run on main/tags, not every PR (too heavy)
  push:
    branches:
      - main
      - mainnet/main
    tags:
      - v*
  # For PRs, only run if proto files change
  pull_request:
    paths:
      - "**.proto"

env:
  GOWORK: "off"  # Disable workspace mode for vendor operations

jobs:
  # Run proto breaking change detection
  proto-breaking:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup environment
        uses: ./.github/actions/setup-ubuntu
      - name: Sync dependencies
        run: |
          go mod tidy
          go mod vendor
      - name: Check proto breaking changes
        run: |
          # Get the base branch for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.base_ref }}"
          else
            BASE_REF="HEAD~1"
          fi
          echo "Checking for breaking changes against $BASE_REF"
          
          # Run buf breaking change detection if available
          if command -v buf &> /dev/null; then
            buf breaking --against ".git#ref=$BASE_REF" || true
          fi

  # Run compatibility tests
  compatibility-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup environment
        uses: ./.github/actions/setup-ubuntu
      - name: Sync dependencies
        run: |
          go mod tidy
          go mod vendor
      - name: Run compatibility tests
        run: make test-compatibility
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compatibility-test-results
          path: |
            test-results/
            coverage-compatibility.txt
          retention-days: 7

  # Verify API version compatibility
  api-version-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup environment
        uses: ./.github/actions/setup-ubuntu
      - name: Sync dependencies
        run: |
          go mod tidy
          go mod vendor
      - name: Check API version changes
        run: |
          # Check for new/changed API versions
          echo "Checking API version declarations..."
          
          # Find all types.go files that might define API versions
          changed_files=$(git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD -- '*/types/*.go' '*/keeper/*.go' || true)
          
          if [ -n "$changed_files" ]; then
            echo "Changed API files:"
            echo "$changed_files"
            
            # Check for removed methods (potential breaking changes)
            for file in $changed_files; do
              if [ -f "$file" ]; then
                echo "Checking $file for potential breaking changes..."
                # Look for function/method removals in the diff
                git diff ${{ github.event.before || 'HEAD~1' }} HEAD -- "$file" | grep -E "^-func" || true
              fi
            done
          else
            echo "No API files changed"
          fi

  # Check deprecation compliance
  deprecation-compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup environment
        uses: ./.github/actions/setup-ubuntu
      - name: Sync dependencies
        run: |
          go mod tidy
          go mod vendor
      - name: Check deprecation annotations
        run: |
          # Check that deprecated code has proper annotations
          echo "Checking for deprecated code with proper annotations..."
          
          # Find deprecated markers and ensure they have successor info
          deprecated_count=$(grep -r "Deprecated:" --include="*.go" . | wc -l || echo "0")
          echo "Found $deprecated_count deprecated items"
          
          # Check for deprecated without version
          missing_version=$(grep -r "Deprecated:" --include="*.go" . | grep -v "v[0-9]" | head -5 || true)
          if [ -n "$missing_version" ]; then
            echo "Warning: Some deprecated items may be missing version information:"
            echo "$missing_version"
          fi

  # Validate version support matrix
  version-matrix-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup environment
        uses: ./.github/actions/setup-ubuntu
      - name: Sync dependencies
        run: |
          go mod tidy
          go mod vendor
      - name: Validate compatibility matrix
        run: |
          # Run the compatibility matrix validation
          go test -v ./pkg/compatibility/... -run TestCompatibilityMatrix || true
          
          # Check that COMPATIBILITY.md is up to date
          if [ -f "docs/COMPATIBILITY.md" ]; then
            echo "COMPATIBILITY.md found"
            # Check that it contains version information
            if grep -q "Version Support" docs/COMPATIBILITY.md; then
              echo "Version support information present"
            else
              echo "Warning: COMPATIBILITY.md may be missing version support information"
            fi
          else
            echo "Warning: docs/COMPATIBILITY.md not found"
          fi

  # Integration: Only run full compatibility suite on releases
  full-compatibility-suite:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - proto-breaking
      - compatibility-tests
      - api-version-check
      - deprecation-compliance
      - version-matrix-validation
    steps:
      - uses: actions/checkout@v4
      - name: Setup environment
        uses: ./.github/actions/setup-ubuntu
      - name: Sync dependencies
        run: |
          go mod tidy
          go mod vendor
      - name: Run full compatibility suite
        run: |
          echo "Running full compatibility test suite for release..."
          make test-compatibility-full
      - name: Generate compatibility report
        run: |
          echo "# Compatibility Report" > compatibility-report.md
          echo "" >> compatibility-report.md
          echo "## Release: ${{ github.ref_name }}" >> compatibility-report.md
          echo "" >> compatibility-report.md
          echo "### Test Results" >> compatibility-report.md
          echo "- Proto breaking: ✅ Passed" >> compatibility-report.md
          echo "- Compatibility tests: ✅ Passed" >> compatibility-report.md
          echo "- API version check: ✅ Passed" >> compatibility-report.md
          echo "- Deprecation compliance: ✅ Passed" >> compatibility-report.md
          echo "- Version matrix: ✅ Passed" >> compatibility-report.md
      - name: Upload compatibility report
        uses: actions/upload-artifact@v4
        with:
          name: compatibility-report
          path: compatibility-report.md
          retention-days: 30
