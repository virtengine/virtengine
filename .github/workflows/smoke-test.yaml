name: Post-Deploy Smoke Test

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - testnet
  workflow_run:
    workflows: ["infrastructure"]
    types: [completed]

concurrency:
  group: smoke-test-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment: ${{ inputs.environment || 'staging' }}
    permissions:
      contents: read
    env:
      VE_RPC_URL: ${{ secrets.VE_SMOKE_RPC_URL }}
      VE_GRPC_URL: ${{ secrets.VE_SMOKE_GRPC_URL }}
      VE_REST_URL: ${{ secrets.VE_SMOKE_REST_URL }}
      VE_CHAIN_ID: ${{ secrets.VE_SMOKE_CHAIN_ID }}
      VE_SMOKE_MNEMONIC: ${{ secrets.VE_SMOKE_MNEMONIC }}
      VE_SMOKE_RECIPIENT_ADDRESS: ${{ secrets.VE_SMOKE_RECIPIENT_ADDRESS }}
      VE_PROVIDER_ADDRESS: ${{ secrets.VE_SMOKE_PROVIDER_ADDRESS }}
      VE_PORTAL_URL: ${{ secrets.VE_SMOKE_PORTAL_URL }}
      SLACK_WEBHOOK_URL: ${{ secrets.VE_SMOKE_SLACK_WEBHOOK }}
      DISCORD_WEBHOOK_URL: ${{ secrets.VE_SMOKE_DISCORD_WEBHOOK }}
      TARGET_ENV: ${{ inputs.environment || 'staging' }}
      GO_VERSION: "1.25.5"
      NODE_VERSION: "20"
      PNPM_VERSION: "9"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build virtengine CLI
        run: |
          go build -o /usr/local/bin/virtengine ./cmd/virtengine

      - name: Install grpcurl
        run: |
          go install github.com/fullstorydev/grpcurl/cmd/grpcurl@v1.9.1
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run backend smoke checks
        run: |
          chmod +x scripts/ci/post-deploy-smoke-test.sh
          scripts/ci/post-deploy-smoke-test.sh

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install portal dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run portal smoke test
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.VE_PORTAL_URL }}
        run: pnpm -C portal test:e2e --config playwright.smoke.config.ts --project=chromium --grep "@smoke"

      - name: Notify on failure
        if: failure()
        run: |
          message="Post-deploy smoke test failed for ${TARGET_ENV} on ${GITHUB_SHA}."
          payload="{\"text\":\"${message}\"}"
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST "$SLACK_WEBHOOK_URL" -H "Content-Type: application/json" -d "$payload"
          fi
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -s -X POST "$DISCORD_WEBHOOK_URL" -H "Content-Type: application/json" -d "{\"content\":\"${message}\"}"
          fi
