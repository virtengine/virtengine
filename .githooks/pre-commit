#!/usr/bin/env bash
# VirtEngine Pre-Commit Hook
#
# Runs fast checks on staged files before commit.
# - Auto-formats Go files with gofmt (always runs on staged .go files)
# - Auto-formats Portal files with prettier (always runs on staged portal files)
# - Runs go mod tidy/vendor when go.mod or go.sum are staged.
#
# Bypass: git commit --no-verify
# Skip formatting: VE_HOOK_SKIP_FMT=1 git commit
# Skip mod check:  VE_HOOK_SKIP_MOD=1 git commit

set -euo pipefail

HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=common.sh
source "$HOOK_DIR/common.sh"

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# =========================================================================
# Auto-format staged Go files with gofmt
# =========================================================================
if [ "${VE_HOOK_SKIP_FMT:-}" != "1" ]; then
    # Get staged Go files (excluding vendor and deleted files)
    STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.go' | grep -v '^vendor/' || true)

    if [ -n "$STAGED_GO_FILES" ]; then
        hook_header "[pre-commit] Formatting staged Go files..."

        # Track if any files were reformatted
        FORMATTED_COUNT=0

        for file in $STAGED_GO_FILES; do
            # Skip if file doesn't exist (edge case)
            [ -f "$file" ] || continue

            # Check if file needs formatting
            if ! gofmt -l "$file" | grep -q .; then
                continue
            fi

            # Format the file in place
            gofmt -w "$file"
            git add "$file"
            FORMATTED_COUNT=$((FORMATTED_COUNT + 1))
            hook_step "Formatted: $file"
        done

        if [ "$FORMATTED_COUNT" -gt 0 ]; then
            hook_pass "[pre-commit] Auto-formatted $FORMATTED_COUNT Go file(s)"
        else
            hook_pass "[pre-commit] All Go files already formatted"
        fi
    fi
fi

# =========================================================================
# Auto-format staged Portal files with prettier
# =========================================================================
if [ "${VE_HOOK_SKIP_FMT:-}" != "1" ]; then
    # Get staged portal files (TypeScript, JavaScript, CSS, JSON)
    STAGED_PORTAL_FILES=$(git diff --cached --name-only --diff-filter=ACM -- \
        'portal/src/**/*.ts' 'portal/src/**/*.tsx' 'portal/src/**/*.js' 'portal/src/**/*.jsx' \
        'portal/src/**/*.css' 'portal/src/**/*.json' 'portal/src/**/*.md' \
        'lib/portal/src/**/*.ts' 'lib/portal/src/**/*.tsx' || true)

    if [ -n "$STAGED_PORTAL_FILES" ]; then
        hook_header "[pre-commit] Formatting staged Portal files..."

        # Check if pnpm and prettier are available
        if command -v pnpm >/dev/null 2>&1 && [ -f "$REPO_ROOT/portal/node_modules/.bin/prettier" ]; then
            # Format all staged portal files at once (more efficient)
            FORMATTED_COUNT=0
            for file in $STAGED_PORTAL_FILES; do
                [ -f "$file" ] || continue
                
                # Check if file needs formatting
                if ! pnpm -C portal exec prettier --check "$REPO_ROOT/$file" >/dev/null 2>&1; then
                    pnpm -C portal exec prettier --write "$REPO_ROOT/$file" >/dev/null 2>&1
                    git add "$file"
                    FORMATTED_COUNT=$((FORMATTED_COUNT + 1))
                    hook_step "Formatted: $file"
                fi
            done

            if [ "$FORMATTED_COUNT" -gt 0 ]; then
                hook_pass "[pre-commit] Auto-formatted $FORMATTED_COUNT Portal file(s)"
            else
                hook_pass "[pre-commit] All Portal files already formatted"
            fi
        else
            hook_warn "[pre-commit] pnpm or prettier not available, skipping Portal formatting"
            hook_step "Run 'pnpm install' in portal/ to enable auto-formatting"
        fi
    fi
fi

# =========================================================================
# go mod tidy/vendor when go.mod or go.sum are staged
# =========================================================================
# Check if go.mod or go.sum are staged
if git diff --cached --name-only | grep -qE '^go\.(mod|sum)$'; then
    if [ "${VE_HOOK_SKIP_MOD:-}" = "1" ]; then
        hook_warn "[pre-commit] Skipping go mod checks (VE_HOOK_SKIP_MOD=1)"
        exit 0
    fi

    hook_header "[pre-commit] go.mod/go.sum changed - syncing modules..."
    
    # Run go mod tidy
    hook_step "Running 'go mod tidy'..."
    if ! go mod tidy 2>&1; then
        hook_fail "go mod tidy failed"
        exit 1
    fi

    # Check if tidy changed anything
    if ! git diff --quiet go.mod go.sum 2>/dev/null; then
        hook_warn "go mod tidy made changes. Adding to commit..."
        git add go.mod go.sum
    fi

    # Sync vendor directory
    if [ -f "$REPO_ROOT/go.work" ] && [ "${GOWORK:-}" != "off" ]; then
        hook_step "Running 'go work vendor'..."
        if ! go work vendor 2>&1; then
            hook_fail "go work vendor failed"
            exit 1
        fi
    else
        hook_step "Running 'go mod vendor'..."
        if ! go mod vendor 2>&1; then
            hook_fail "go mod vendor failed"
            exit 1
        fi
    fi

    hook_pass "[pre-commit] Module sync complete"
fi

exit 0
