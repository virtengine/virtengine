#!/usr/bin/env bash
# VirtEngine Pre-Commit Hook
#
# Runs fast checks on staged files before commit.
# - Auto-formats Go files with gofmt (always runs on staged .go files)
# - Auto-formats Portal files with prettier (always runs on staged portal files)
# - Runs go mod tidy/vendor when go.mod or go.sum are staged.
#
# Bypass: git commit --no-verify
# Skip formatting: VE_HOOK_SKIP_FMT=1 git commit
# Skip mod check:  VE_HOOK_SKIP_MOD=1 git commit

set -euo pipefail

HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=common.sh
source "$HOOK_DIR/common.sh"

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"
ensure_direnv_env

STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACM)"
STAGED_GO_FILES="$(echo "$STAGED_FILES" | grep -E '\.go$' | grep -v '^vendor/' || true)"

# =========================================================================
# Auto-format staged Go files with gofmt
# =========================================================================
if [ "${VE_HOOK_SKIP_FMT:-}" != "1" ]; then
    # Get staged Go files (excluding vendor and deleted files)
    if [ -n "$STAGED_GO_FILES" ]; then
        hook_header "[pre-commit] Formatting staged Go files..."

        # Track if any files were reformatted
        FORMATTED_COUNT=0

        for file in $STAGED_GO_FILES; do
            # Skip if file doesn't exist (edge case)
            [ -f "$file" ] || continue

            # Check if file needs formatting
            if ! gofmt -l "$file" | grep -q .; then
                continue
            fi

            # Format the file in place
            gofmt -w "$file"
            git add "$file"
            FORMATTED_COUNT=$((FORMATTED_COUNT + 1))
            hook_step "Formatted: $file"
        done

        if [ "$FORMATTED_COUNT" -gt 0 ]; then
            hook_pass "[pre-commit] Auto-formatted $FORMATTED_COUNT Go file(s)"
        else
            hook_pass "[pre-commit] All Go files already formatted"
        fi
    fi
fi

# =========================================================================
# Auto-format staged portal files with prettier (if available)
# =========================================================================
if [ "${VE_HOOK_SKIP_PRETTIER:-}" != "1" ]; then
    PORTAL_STAGED_FILES="$(echo "$STAGED_FILES" | grep -E '^(portal|lib/portal)/.*\.(ts|tsx|js|jsx|json|css|md)$' || true)"
    if [ -n "$PORTAL_STAGED_FILES" ]; then
        PRETTIER_BIN="$REPO_ROOT/portal/node_modules/.bin/prettier"
        if [ -x "$PRETTIER_BIN" ]; then
            hook_header "[pre-commit] Formatting staged portal files with prettier..."
            # Prettier needs paths relative to repo root.
            echo "$PORTAL_STAGED_FILES" | xargs "$PRETTIER_BIN" --write
            echo "$PORTAL_STAGED_FILES" | xargs git add
            hook_pass "[pre-commit] Prettier formatted staged portal files"
        else
            hook_warn "[pre-commit] Prettier not available in portal/node_modules. Skipping portal formatting."
            hook_warn "            Run 'pnpm -C portal install' to enable auto-formatting."
        fi
    fi
fi

# =========================================================================
# Auto-format staged sdk/ts files with lint-staged (if available)
# =========================================================================
if [ "${VE_HOOK_SKIP_JS:-}" != "1" ]; then
    SDK_TS_STAGED_FILES="$(echo "$STAGED_FILES" | grep -E '^sdk/ts/.*\.(ts|tsx|js|jsx|json)$' || true)"
    if [ -n "$SDK_TS_STAGED_FILES" ]; then
        SDK_LINT_STAGED_BIN="$REPO_ROOT/sdk/ts/node_modules/.bin/lint-staged"
        if [ -x "$SDK_LINT_STAGED_BIN" ]; then
            hook_header "[pre-commit] Formatting staged sdk/ts files with lint-staged..."
            (cd "$REPO_ROOT/sdk/ts" && "$SDK_LINT_STAGED_BIN")
            hook_pass "[pre-commit] lint-staged applied for sdk/ts"
        else
            hook_warn "[pre-commit] lint-staged not available in sdk/ts/node_modules. Skipping sdk/ts formatting."
            hook_warn "            Run 'pnpm -C sdk/ts install' to enable auto-formatting."
        fi
    fi
fi

# =========================================================================
# Lint staged Go packages with golangci-lint
# =========================================================================
if [ "${VE_HOOK_SKIP_LINT:-}" != "1" ]; then
    if [ -n "$STAGED_GO_FILES" ]; then
        hook_header "[pre-commit] Linting staged Go packages (golangci-lint)..."
        GO_DIRS="$(echo "$STAGED_GO_FILES" | xargs -n1 dirname | sort -u | sed 's#^#./#')"
        if ! golangci-lint run $GO_DIRS; then
            hook_fail "golangci-lint failed. Fix issues or set VE_HOOK_SKIP_LINT=1 to bypass."
            exit 1
        fi
        hook_pass "[pre-commit] golangci-lint passed"
    fi
fi

# =========================================================================
# go mod tidy/vendor when go.mod or go.sum are staged
# =========================================================================
# Check if go.mod or go.sum are staged
if git diff --cached --name-only | grep -qE '^go\.(mod|sum)$'; then
    if [ "${VE_HOOK_SKIP_MOD:-}" = "1" ]; then
        hook_warn "[pre-commit] Skipping go mod checks (VE_HOOK_SKIP_MOD=1)"
        exit 0
    fi

    hook_header "[pre-commit] go.mod/go.sum changed - syncing modules..."
    
    # Run go mod tidy
    hook_step "Running 'go mod tidy'..."
    if ! go mod tidy 2>&1; then
        hook_fail "go mod tidy failed"
        exit 1
    fi

    # Check if tidy changed anything
    if ! git diff --quiet go.mod go.sum 2>/dev/null; then
        hook_warn "go mod tidy made changes. Adding to commit..."
        git add go.mod go.sum
    fi

    # Sync vendor directory
    if [ -f "$REPO_ROOT/go.work" ] && [ "${GOWORK:-}" != "off" ]; then
        hook_step "Running 'go work vendor'..."
        if ! go work vendor 2>&1; then
            hook_fail "go work vendor failed"
            exit 1
        fi
    else
        hook_step "Running 'go mod vendor'..."
        if ! go mod vendor 2>&1; then
            hook_fail "go mod vendor failed"
            exit 1
        fi
    fi

    hook_pass "[pre-commit] Module sync complete"
fi

exit 0
