#!/usr/bin/env pwsh
<##
.SYNOPSIS
  Archive completed Vibe-Kanban tasks into repo docs and remove them from Kanban.

.DESCRIPTION
  Finds tasks with status "done" that are older than a configured age and have
  a merged PR. Archives each task into `_docs/ralph/tasks/completed/` and
  appends an entry to `_docs/ralph/tasks/completed_tasks.md`, then deletes the
  task from Vibe-Kanban.

.PARAMETER AgeHours
  Minimum age (in hours) since task completion before archiving.

.PARAMETER MinIntervalMinutes
  Minimum minutes between runs (persisted in .cache/ve-completed-task-archive.json).

.PARAMETER MaxTasks
  Maximum number of tasks to archive per run.

.PARAMETER DryRun
  If set, do not write files or delete tasks (logs only).
#>
[CmdletBinding()]
param(
  [int]$AgeHours = 24,
  [int]$MinIntervalMinutes = 30,
  [int]$MaxTasks = 200,
  [switch]$DryRun
)

$ErrorActionPreference = "Stop"

function Write-Log {
  param([string]$Message, [string]$Level = "INFO")
  $ts = Get-Date -Format "HH:mm:ss"
  Write-Host "[$ts] $Level  $Message"
}

function Resolve-RepoRoot {
  try {
    return (Resolve-Path (Join-Path $PSScriptRoot ".."))
  } catch {
    return (Get-Location)
  }
}

function Read-ArchiveState {
  param([string]$Path)
  if (-not (Test-Path -LiteralPath $Path)) { return $null }
  try {
    $raw = Get-Content -Path $Path -Raw
    if (-not $raw) { return $null }
    return $raw | ConvertFrom-Json -Depth 4
  } catch {
    return $null
  }
}

function Write-ArchiveState {
  param([string]$Path, [hashtable]$State)
  $dir = Split-Path -Parent $Path
  if (-not (Test-Path -LiteralPath $dir)) {
    New-Item -ItemType Directory -Path $dir | Out-Null
  }
  $State | ConvertTo-Json -Depth 4 | Set-Content -Path $Path -Encoding UTF8
}

function Convert-ToDateTime {
  param([object]$Value)
  if (-not $Value) { return $null }
  try {
    return [datetime]::Parse($Value.ToString(), [System.Globalization.CultureInfo]::InvariantCulture, [System.Globalization.DateTimeStyles]::AdjustToUniversal)
  } catch {
    return $null
  }
}

function Get-TaskDoneAt {
  param([object]$Task)
  $candidates = @($Task.completed_at, $Task.completedAt, $Task.updated_at, $Task.updatedAt, $Task.created_at, $Task.createdAt)
  foreach ($c in $candidates) {
    $dt = Convert-ToDateTime -Value $c
    if ($dt) { return $dt }
  }
  return $null
}

function Get-Slug {
  param([string]$Title)
  $slug = ($Title ?? "task")
  $slug = $slug.ToLowerInvariant()
  $slug = [regex]::Replace($slug, "[^a-z0-9]+", "-")
  $slug = $slug.Trim("-")
  if ($slug.Length -gt 70) { $slug = $slug.Substring(0, 70).Trim("-") }
  if (-not $slug) { $slug = "task" }
  return $slug
}

function Ensure-IndexFile {
  param([string]$Path)
  if (Test-Path -LiteralPath $Path) { return }
  $header = @(
    "# Completed Tasks Archive",
    "",
    "Generated by `scripts/archive-completed-tasks.ps1`.",
    "",
    "| Completed At (UTC) | Task | PR | Task ID | File |",
    "| --- | --- | --- | --- | --- |"
  )
  $header | Set-Content -Path $Path -Encoding UTF8
}

function Task-AlreadyIndexed {
  param([string]$IndexPath, [string]$TaskId)
  if (-not (Test-Path -LiteralPath $IndexPath)) { return $false }
  try {
    return (Select-String -Path $IndexPath -Pattern [regex]::Escape($TaskId) -SimpleMatch -Quiet)
  } catch {
    return $false
  }
}

function Write-TaskArchive {
  param(
    [object]$Task,
    [object]$Attempt,
    [object]$Pr,
    [datetime]$DoneAt,
    [string]$ArchiveDir,
    [string]$IndexPath,
    [switch]$DryRun
  )

  $shortId = if ($Task.id) { $Task.id.Substring(0, 8) } else { "task" }
  $slug = Get-Slug -Title $Task.title
  $datePrefix = $DoneAt.ToUniversalTime().ToString("yyyyMMdd")
  $fileName = "$datePrefix-$slug-$shortId.md"
  $filePath = Join-Path $ArchiveDir $fileName
  $relativePath = Join-Path "completed" $fileName

  if (-not $DryRun -and -not (Test-Path -LiteralPath $ArchiveDir)) {
    New-Item -ItemType Directory -Path $ArchiveDir | Out-Null
  }

  if (-not $DryRun -and -not (Test-Path -LiteralPath $filePath)) {
    $lines = @(
      "# $($Task.title)",
      "",
      "- Task ID: $($Task.id)",
      "- Status: $($Task.status)",
      "- Completed At (UTC): $($DoneAt.ToUniversalTime().ToString("o"))",
      ("- Merged PR: #$($Pr.number)" + ($(if ($Pr.mergedAt) { " (merged $($Pr.mergedAt))" } else { "" }))),
      ("- Branch: $($Attempt.branch)"),
      ("- Archived At (UTC): $([datetime]::UtcNow.ToString("o"))"),
      "",
      "## Description",
      "",
      ($Task.description ?? "(no description)")
    )
    $lines | Set-Content -Path $filePath -Encoding UTF8
  }

  Ensure-IndexFile -Path $IndexPath
  if (-not (Task-AlreadyIndexed -IndexPath $IndexPath -TaskId $Task.id)) {
    $row = "| $($DoneAt.ToUniversalTime().ToString("o")) | $($Task.title) | #$($Pr.number) | $($Task.id) | $relativePath |"
    if (-not $DryRun) {
      Add-Content -Path $IndexPath -Value $row
    }
  }

  return @{
    file = $filePath
    relative = $relativePath
  }
}

function Remove-VKTask {
  param([string]$TaskId)
  try {
    $null = Invoke-VKApi -Path "/api/tasks/$TaskId" -Method "DELETE"
    return $true
  } catch {
    return $false
  }
}

# ── Config ─────────────────────────────────────────────────────────────

if ($env:VE_COMPLETED_TASK_ARCHIVE_AGE_HOURS) {
  $AgeHours = [int]$env:VE_COMPLETED_TASK_ARCHIVE_AGE_HOURS
}
if ($env:VE_COMPLETED_TASK_ARCHIVE_INTERVAL_MIN) {
  $MinIntervalMinutes = [int]$env:VE_COMPLETED_TASK_ARCHIVE_INTERVAL_MIN
}
if ($env:VE_COMPLETED_TASK_ARCHIVE_MAX) {
  $MaxTasks = [int]$env:VE_COMPLETED_TASK_ARCHIVE_MAX
}
if ($env:VE_COMPLETED_TASK_ARCHIVE_DRY_RUN -and $env:VE_COMPLETED_TASK_ARCHIVE_DRY_RUN -ne "0") {
  $DryRun = $true
}

$repoRoot = Resolve-RepoRoot
$statePath = Join-Path $repoRoot ".cache\ve-completed-task-archive.json"

if (-not $DryRun -and $MinIntervalMinutes -gt 0) {
  $state = Read-ArchiveState -Path $statePath
  if ($state -and $state.last_run_at) {
    $lastRun = Convert-ToDateTime -Value $state.last_run_at
    if ($lastRun) {
      $elapsed = (Get-Date).ToUniversalTime() - $lastRun.ToUniversalTime()
      if ($elapsed.TotalMinutes -lt $MinIntervalMinutes) {
        Write-Log "Skipping archive run (last run $([math]::Round($elapsed.TotalMinutes, 1)) min ago)." "INFO"
        return
      }
    }
  }
}

$kanbanPath = Join-Path $repoRoot "scripts\ve-kanban.ps1"
if (-not (Test-Path -LiteralPath $kanbanPath)) {
  throw "ve-kanban.ps1 not found at $kanbanPath"
}
. $kanbanPath

if (-not (Initialize-VKConfig)) {
  throw "Failed to initialize vibe-kanban config"
}

$tasks = Get-VKTasks -Status "done" -Limit 500
if (-not $tasks -or $tasks.Count -eq 0) {
  Write-Log "No completed tasks found." "INFO"
  if (-not $DryRun) {
    Write-ArchiveState -Path $statePath -State @{ last_run_at = [datetime]::UtcNow.ToString("o") }
  }
  return
}

$attempts = Get-VKAttempts
$attemptMap = @{}
foreach ($a in $attempts) {
  if (-not $a.task_id) { continue }
  if (-not $attemptMap.ContainsKey($a.task_id)) { $attemptMap[$a.task_id] = @() }
  $attemptMap[$a.task_id] += $a
}

$threshold = (Get-Date).ToUniversalTime().AddHours(-$AgeHours)
$archiveDir = Join-Path $repoRoot "_docs\ralph\tasks\completed"
$indexPath = Join-Path $repoRoot "_docs\ralph\tasks\completed_tasks.md"

$archived = 0
$skipped = 0

$sorted = @($tasks | Sort-Object -Property updated_at)
foreach ($task in $sorted) {
  if ($archived -ge $MaxTasks) { break }

  $doneAt = Get-TaskDoneAt -Task $task
  if (-not $doneAt) { $skipped++; continue }
  if ($doneAt.ToUniversalTime() -gt $threshold) { continue }

  $taskAttempts = $attemptMap[$task.id]
  if (-not $taskAttempts -or $taskAttempts.Count -eq 0) { $skipped++; continue }

  $merged = $null
  $mergedAttempt = $null
  $orderedAttempts = $taskAttempts | Sort-Object -Property updated_at -Descending
  foreach ($attempt in $orderedAttempts) {
    if (-not $attempt.branch) { continue }
    $pr = Get-PRForBranch -Branch $attempt.branch
    if ($pr -and ($pr.mergedAt -or ($pr.state -match "merged"))) {
      $merged = $pr
      $mergedAttempt = $attempt
      break
    }
  }

  if (-not $merged) { $skipped++; continue }

  Write-Log "Archiving task $($task.title) ($($task.id))" "INFO"
  $null = Write-TaskArchive -Task $task -Attempt $mergedAttempt -Pr $merged -DoneAt $doneAt -ArchiveDir $archiveDir -IndexPath $indexPath -DryRun:$DryRun

  if (-not $DryRun) {
    foreach ($attempt in $taskAttempts) {
      if (-not $attempt.archived) {
        Archive-VKAttempt -AttemptId $attempt.id | Out-Null
      }
    }
    $deleted = Remove-VKTask -TaskId $task.id
    if (-not $deleted) {
      Write-Log "Failed to delete task $($task.id) from Vibe-Kanban." "WARN"
    }
  }

  $archived++
}

Write-Log "Archive run complete. Archived: $archived. Skipped: $skipped." "INFO"
if (-not $DryRun) {
  Write-ArchiveState -Path $statePath -State @{ last_run_at = [datetime]::UtcNow.ToString("o"); archived = $archived; skipped = $skipped }
}
