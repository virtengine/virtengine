# ─── Codex Monitor — Environment Configuration ───────────────────────────────
# Copy this file to .env and fill in your values.
# Or run: codex-monitor --setup
# All variables are optional unless marked [REQUIRED].

# ─── Project Identity ─────────────────────────────────────────────────────────
# Project name shown in Telegram messages and logs.
# Auto-detected from package.json or directory name if not set.
# PROJECT_NAME=my-project

# ─── Telegram Bot ─────────────────────────────────────────────────────────────
# Create a bot via @BotFather on Telegram, then paste the token here.
# Run `codex-monitor-chat-id` to discover your chat ID.
TELEGRAM_BOT_TOKEN=
TELEGRAM_CHAT_ID=
# Minutes between periodic status summaries (default: 10)
TELEGRAM_INTERVAL_MIN=10
# Long-poll timeout for getUpdates in seconds (default: 20)
TELEGRAM_COMMAND_POLL_TIMEOUT_SEC=20
# Max concurrent telegram command handlers (default: 2)
# TELEGRAM_COMMAND_CONCURRENCY=2
# Max commands to pull per batch (default: 25)
# TELEGRAM_COMMAND_MAX_BATCH=25

# ─── Notification Batching (RECOMMENDED) ─────────────────────────────────────
# Batch notifications into periodic summaries instead of spamming individual messages
# TELEGRAM_BATCH_NOTIFICATIONS=true
# Batch interval in seconds - send summary every N seconds (default: 300 = 5 min)
# TELEGRAM_BATCH_INTERVAL_SEC=300
# Max messages before forcing a flush (default: 50)
# TELEGRAM_BATCH_MAX_SIZE=50
# Priority threshold for immediate delivery: 1=critical only, 2=critical+errors (default: 1)
# TELEGRAM_IMMEDIATE_PRIORITY=1

# ─── Presence & Multi-Instance Coordination ──────────────────────────────────
# Presence heartbeat allows discovering multiple codex-monitor instances.
# Heartbeat interval in seconds (default: 60)
# TELEGRAM_PRESENCE_INTERVAL_SEC=60
# Consider instances offline after this many seconds (default: 180)
# TELEGRAM_PRESENCE_TTL_SEC=180
# Disable presence heartbeats entirely (default: false)
# TELEGRAM_PRESENCE_DISABLED=false
# Send presence messages silently without notification sound (default: false)
# TELEGRAM_PRESENCE_SILENT=false
# Only send when state changes, not on every heartbeat (default: true)
# TELEGRAM_PRESENCE_ONLY_ON_CHANGE=true
# Chat/channel for presence messages (required to enable presence announcements)
# TELEGRAM_PRESENCE_CHAT_ID=
# Instance ID (auto-generated stable ID across restarts if not set)
# VE_INSTANCE_ID=
# Human-friendly instance label shown in /presence (default: workspace name)
# VE_INSTANCE_LABEL=
# Coordinator election priority - lower wins (default: 10 for coordinators, 100 for workspaces)
# VE_COORDINATOR_PRIORITY=
# Opt out of coordinator election (default: true)
# VE_COORDINATOR_ELIGIBLE=true

# ─── Orchestrator Script ──────────────────────────────────────────────────────
# Path to the orchestrator script (PowerShell, Bash, or any CLI).
# Auto-detected from common locations if not set.
# ORCHESTRATOR_SCRIPT=./orchestrator.ps1

# Arguments passed to the orchestrator script (space-separated).
# ORCHESTRATOR_ARGS=-MaxParallel 6 -WaitForMutex

# ─── Executor Configuration ──────────────────────────────────────────────────
# Define AI executors that work on tasks.
# Format: EXECUTOR_TYPE:VARIANT:WEIGHT,EXECUTOR_TYPE:VARIANT:WEIGHT
# Example: COPILOT:CLAUDE_OPUS_4_6:50,CODEX:DEFAULT:50
# For full config, use codex-monitor.config.json instead.
# EXECUTORS=COPILOT:CLAUDE_OPUS_4_6:50,CODEX:DEFAULT:50

# Task distribution mode: "weighted" | "round-robin" | "primary-only"
# EXECUTOR_DISTRIBUTION=weighted

# ─── Failover Configuration ──────────────────────────────────────────────────
# What happens when an executor fails repeatedly.
# Strategy: "next-in-line" | "weighted-random" | "round-robin"
# FAILOVER_STRATEGY=next-in-line
# Max retries before switching executor
# FAILOVER_MAX_RETRIES=3
# Minutes to disable an executor after consecutive failures
# FAILOVER_COOLDOWN_MIN=5
# Disable executor after N consecutive failures
# FAILOVER_DISABLE_AFTER=3

# ─── Vibe-Kanban ──────────────────────────────────────────────────────────────
# Base URL for the Vibe-Kanban API (default: http://127.0.0.1:54089)
VK_BASE_URL=http://127.0.0.1:54089
# Alternate endpoint URL for VK (overrides VK_BASE_URL if set)
# VK_ENDPOINT_URL=http://127.0.0.1:54089
# Port for vibe-kanban API (default: 54089)
VK_RECOVERY_PORT=54089
# Host for VK recovery (default: 0.0.0.0)
# VK_RECOVERY_HOST=0.0.0.0
# VK_HOST=0.0.0.0
# Public URL shown in Telegram links (optional)
# VK_PUBLIC_URL=https://kanban.yoursite.com
# VK_WEB_URL=https://kanban.yoursite.com
# VK HTTP timeout/retry controls (used by ve-kanban.ps1)
# VK_HTTP_TIMEOUT_SEC=45
# VK_HTTP_RETRIES=2
# VK_HTTP_RETRY_DELAY_MS=1500
# Set to 1 to prevent the monitor from spawning vibe-kanban automatically
# VK_NO_SPAWN=0
# Cooldown minutes between VK recovery attempts (default: 10)
# VK_RECOVERY_COOLDOWN_MIN=10
# VK health check interval in ms (default: 60000)
# VK_ENSURE_INTERVAL=60000
# VK project name (auto-detected)
# VK_PROJECT_NAME=my-project
# Explicit VK project/repo IDs (auto-detected if empty)
# VK_PROJECT_ID=
# VK_REPO_ID=
# Override task URL template (optional)
# VK_TASK_URL_TEMPLATE=https://kanban.yoursite.com/projects/{projectId}/tasks/{taskId}

# ─── Shared Workspace Registry ───────────────────────────────────────────────
# Optional registry path for shared workspace leasing
# VE_SHARED_WORKSPACE_REGISTRY=.cache/codex-monitor/shared-workspaces.json
# Optional audit log path for shared workspace leasing
# VE_SHARED_WORKSPACE_AUDIT_LOG=.cache/codex-monitor/shared-workspace-audit.jsonl
# Default lease TTL in minutes (Telegram claims); can override with seconds below
# VE_WORKSPACE_LEASE_TTL_MIN=120
# Default lease TTL in seconds (converted to minutes if set)
# VE_WORKSPACE_LEASE_TTL_SEC=7200
# Default owner name for CLI/Telegram claims (falls back to USER/USERNAME)
# VE_WORKSPACE_OWNER=your-name

# ─── GitHub ───────────────────────────────────────────────────────────────────
# Repository slug for PR links (default: auto-detected from git remote)
# GITHUB_REPO=your-org/your-repo
# Custom GitHub URL base for links
# GITHUB_REPO_URL=https://github.com/your-org/your-repo
# GitHub API token for PR lookups when gh is unavailable (any of these work)
# GITHUB_TOKEN=
# GH_TOKEN=
# GITHUB_PAT=
# Owner/repo for gh CLI in ve-kanban
# GH_OWNER=virtengine
# GH_REPO=virtengine
# Target branch for PR checks/merge (default: origin/main)
# VK_TARGET_BRANCH=origin/main

# ─── Codex / AI Provider ─────────────────────────────────────────────────────
# The Codex SDK uses OpenAI-compatible configuration that has been setup in ~/.codex/config.toml - 
# you do not need to set env variables here if config is already setup.
# Set these to use a different model or provider.
OPENAI_API_KEY=
# OPENAI_BASE_URL=https://api.openai.com/v1
# CODEX_MODEL=gpt-4o
# Set to 1 to disable all Codex/AI features (analysis, autofix, shell)
# CODEX_SDK_DISABLED=0

# ─── Merge Strategy (Codex-powered PR decision engine) ───────────────────────
# When a task completes, analyze the agent's output via Codex SDK to decide:
# merge_after_ci_pass, prompt (agent), close_pr, re_attempt, manual_review, wait
# Set to "false" to disable (default: enabled when Codex is enabled)
# CODEX_ANALYZE_MERGE_STRATEGY=true
# Timeout for merge strategy analysis in milliseconds (default: 600000 = 10 min)
# MERGE_STRATEGY_TIMEOUT_MS=600000

# ─── Autofix Mode ────────────────────────────────────────────────────────────
# How autofix behaves when errors are detected:
#   "auto"    - (default) detect from environment (dev source = execute, npm = analyze)
#   "execute" - force execute mode: actually applies fixes to disk
#   "analyze" - force analyze mode: only sends suggestions, never modifies files
# AUTOFIX_MODE=auto

# ─── Copilot SDK (Primary Agent) ─────────────────────────────────────────────
# Requires GitHub Copilot CLI installed and authenticated.
# Set to 1 to disable Copilot SDK (primary agent) usage.
# COPILOT_SDK_DISABLED=0
# Override model (defaults to Copilot CLI configured model)
# COPILOT_MODEL=gpt-5
# Optional: point to Copilot CLI binary or server
# COPILOT_CLI_PATH=copilot
# COPILOT_CLI_URL=http://127.0.0.1:8888
# Optional: pass MCP server config (JSON string or path)
# COPILOT_MCP_SERVERS={"github":{"type":"http","url":"https://api.githubcopilot.com/mcp/"}}
# COPILOT_MCP_CONFIG=.vscode/mcp.json

# ─── Task Planner ────────────────────────────────────────────────────────────
# Auto-trigger task planner when backlog-per-slot drops below threshold
TASK_PLANNER_PER_CAPITA_THRESHOLD=1
# Auto-trigger when idle slots meet/exceed threshold
TASK_PLANNER_IDLE_SLOT_THRESHOLD=1
# De-duplication window in hours
TASK_PLANNER_DEDUP_HOURS=6

# ─── Shared Cloud Workspaces ────────────────────────────────────────────────
# Registry file for shared workspace leasing (default: .cache/codex-monitor/shared-workspaces.json)
# VE_SHARED_WORKSPACE_REGISTRY=
# Audit log file for claim/release events (default: .cache/codex-monitor/shared-workspace-audit.jsonl)
# VE_SHARED_WORKSPACE_AUDIT_LOG=

# ─── CI Sweep (Orchestrator) ─────────────────────────────────────────────────
# Trigger CI sweep after N completed tasks (0 disables)
# VE_CI_SWEEP_EVERY=15
# Backup trigger after N merged PRs on main (0 disables)
# VE_CI_SWEEP_PR_EVERY=15
# Enable PR-based backup trigger
# VE_CI_SWEEP_PR_BACKUP=true
# Disable Copilot cloud triggers when rate-limited
# COPILOT_CLOUD_DISABLE_ON_RATE_LIMIT=true
# COPILOT_CLOUD_COOLDOWN_MIN=60
# Cooldown duration (minutes) when Copilot rate limit is detected in PR comments
# COPILOT_RATE_LIMIT_COOLDOWN_MIN=120
# Force-disable Copilot cloud triggers (PR comments/issues)
# COPILOT_CLOUD_DISABLED=0
# COPILOT_CLOUD_DISABLED_UNTIL=2026-02-07T12:00:00Z
# Local resolution strategy when Copilot cloud is disabled: "agent" or "codex"
# COPILOT_LOCAL_RESOLUTION=agent
# Wait for orchestrator mutex instead of exiting when another instance runs
# VE_ORCHESTRATOR_WAIT_FOR_MUTEX=true
# Allow smartPR to recreate PRs even if a closed PR already exists for the branch
# VE_SMARTPR_ALLOW_RECREATE_CLOSED=0

# ─── Git Identity (optional) ─────────────────────────────────────────────────
# Override git author for automated commits
# VE_GIT_AUTHOR_NAME=Codex Monitor
# VE_GIT_AUTHOR_EMAIL=bot@yoursite.com

# ─── Task Planner ─────────────────────────────────────────────────────────────
# How to plan new tasks when backlog is empty:
#   "kanban"   - (default) create a VK planning task for an agent to refine
#   "codex-sdk" - run Codex SDK directly to generate tasks
#   "disabled"  - do nothing, wait for manual task creation
# TASK_PLANNER_MODE=kanban

# ─── Merge Strategy / Conflict Resolution ────────────────────────────────────
# Merge strategy mode: "smart" or "smart+codexsdk" (enables Codex conflict resolution)
# MERGE_STRATEGY_MODE=smart
# Codex conflict resolution timeout in ms
# MERGE_CONFLICT_RESOLUTION_TIMEOUT_MS=600000

# ─── Advanced ─────────────────────────────────────────────────────────────────
# Override codex-monitor config directory (where .env and config live)
# CODEX_MONITOR_DIR=/path/to/scripts/codex-monitor
# Max orchestrator restarts (0 = unlimited)
# MAX_RESTARTS=0
# Restart delay in milliseconds
# RESTART_DELAY_MS=10000
# Max parallel task slots
# MAX_PARALLEL=6
# Repository root (auto-detected from git)
# REPO_ROOT=/path/to/repo
# Watch path to trigger restarts (default: script path)
# WATCH_PATH=/path/to/ve-orchestrator.ps1
# Status file path (default: .cache/ve-orchestrator-status.json)
# STATUS_FILE=.cache/ve-orchestrator-status.json
# Log directory (default: ./logs)
# LOG_DIR=./logs
# Max total log folder size in MB. Oldest logs are deleted when exceeded. 0 = unlimited.
# LOG_MAX_SIZE_MB=500
# How often to check log folder size in minutes. 0 = startup only.
# LOG_CLEANUP_INTERVAL_MIN=30
