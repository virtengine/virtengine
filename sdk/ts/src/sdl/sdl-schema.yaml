$schema: http://json-schema.org/draft-07/schema#
additionalProperties: false
description: |
  Schema for VirtEngine Stack Definition Language (SDL) YAML input files.

  Note: This schema validates structure only. Semantic validations (cross-references,
  unused endpoints, profile references, etc.) are performed at runtime by the Go parser.
  See README.md for details.

definitions:
  stringArrayOrNull:
    description: String array or null value (used for command args and env vars)
    oneOf:
      - items:
          type: string
        type: array
      - type: 'null'

  portNumber:
    description: Valid TCP/UDP port number (1-65535)
    type: integer
    minimum: 1
    maximum: 65535

  httpErrorCode:
    description: HTTP error codes for proxy retry logic
    enum:
      - error
      - timeout
      - "500"
      - "502"
      - "503"
      - "504"
      - "403"
      - "404"
      - "429"
      - off
    type: string

  priceCoin:
    description: Price definition with amount and denomination
    additionalProperties: false
    properties:
      amount:
        oneOf:
          - type: string
            pattern: '^[0-9]+(\.[0-9]+)?$'
            description: Positive number as string
          - type: number
            minimum: 0
            description: Positive number
      denom:
        pattern: '^(uve|ibc/.*)$'
        type: string
    required:
      - denom
      - amount
    type: object

  storageAttributesValidation:
    description: |
      Storage attributes validation:
      1. RAM class must not be persistent
      2. Non-RAM classes (beta1, beta2, beta3, default) require persistent=true
    additionalProperties: false
    properties:
      class:
        type: string
      persistent:
        oneOf:
          - type: boolean
          - type: string
    not:
      properties:
        class: { const: ram }
        persistent:
          oneOf:
            - { const: true }
            - { const: "true" }
      required: [class, persistent]
    type: object

  storageVolume:
    description: Storage volume definition with size and optional attributes
    additionalProperties: false
    properties:
      attributes:
        $ref: '#/definitions/storageAttributesValidation'
      name:
        type: string
      size:
        type: string
    required:
      - size
    type: object

  absolutePath:
    description: Absolute filesystem path starting with /
    type: string
    minLength: 1
    pattern: '^/'

  exposeToWithIpEnforcesGlobal:
    description: Expose to with IP enforces global
    if:
      properties:
        ip:
          type: string
          minLength: 1
      required:
        - ip
    then:
      properties:
        global:
          const: true
      required:
        - global

properties:
  deployment:
    additionalProperties:
      additionalProperties:
        additionalProperties: false
        properties:
          count:
            minimum: 1
            type: integer
          profile:
            type: string
        required:
          - profile
          - count
        type: object
      type: object
    type: object

  endpoints:
    additionalProperties: false
    patternProperties:
      '^[a-z]+[-_0-9a-z]+$':
        additionalProperties: false
        properties:
          kind:
            enum:
              - ip
            type: string
        required:
          - kind
        type: object
    type: object

  include:
    description: Optional list of files to include
    items:
      type: string
    type: array

  profiles:
    additionalProperties: false
    properties:
      compute:
        additionalProperties:
          additionalProperties: false
          properties:
            resources:
              additionalProperties: false
              properties:
                cpu:
                  additionalProperties: false
                  properties:
                    attributes:
                      type: object
                    units:
                      oneOf:
                        - type: string
                          pattern: '^[0-9]+(\.[0-9]+)?[a-zA-Z]*$'
                          not:
                            pattern: '^0+(\.0+)?m?$'
                        - type: number
                          exclusiveMinimum: 0
                  required:
                    - units
                  type: object
                gpu:
                  description: |
                    GPU resource specification.
                    - units defaults to 0 if omitted
                    - Bidirectional validation: units > 0 requires attributes, and attributes require units > 0
                  additionalProperties: false
                  properties:
                    attributes:
                      additionalProperties: false
                      properties:
                        vendor:
                          additionalProperties: false
                          minProperties: 1
                          properties:
                            nvidia:
                              oneOf:
                                - type: array
                                  items:
                                    additionalProperties: false
                                    properties:
                                      interface:
                                        enum:
                                          - pcie
                                          - sxm
                                        type: string
                                      model:
                                        type: string
                                      ram:
                                        type: string
                                    type: object
                                - type: 'null'
                          type: object
                      type: object
                    units:
                      oneOf:
                        - type: string
                        - type: number
                  required: [units]
                  type: object
                memory:
                  additionalProperties: false
                  properties:
                    size:
                      type: string
                  required:
                    - size
                  type: object
                storage:
                  oneOf:
                    - $ref: '#/definitions/storageVolume'
                    - items:
                        $ref: '#/definitions/storageVolume'
                      type: array
              required:
                - cpu
                - memory
                - storage
              type: object
          required:
            - resources
          type: object
        type: object
      placement:
        additionalProperties:
          additionalProperties: false
          properties:
            attributes:
              type: object
            pricing:
              additionalProperties:
                $ref: '#/definitions/priceCoin'
              type: object
            signedBy:
              additionalProperties: false
              properties:
                allOf:
                  items:
                    type: string
                  type: array
                anyOf:
                  items:
                    type: string
                  type: array
              type: object
          required:
            - pricing
          type: object
        type: object
    required:
      - compute
      - placement
    type: object

  services:
    additionalProperties:
      properties:
        args:
          $ref: '#/definitions/stringArrayOrNull'
        command:
          $ref: '#/definitions/stringArrayOrNull'
        credentials:
          additionalProperties: false
          properties:
            email:
              type: string
              minLength: 5
            host:
              type: string
              minLength: 1
            password:
              type: string
              minLength: 6
            username:
              type: string
              minLength: 1
          required:
            - host
            - username
            - password
          type: object
        dependencies:
          items:
            additionalProperties: false
            properties:
              service:
                type: string
            type: object
          type: array
        env:
          $ref: '#/definitions/stringArrayOrNull'
        expose:
          items:
            additionalProperties: false
            properties:
              accept:
                items:
                  type: string
                type: array
              as:
                $ref: '#/definitions/portNumber'
              http_options:
                additionalProperties: false
                properties:
                  max_body_size:
                    type: integer
                    minimum: 0
                    maximum: 104857600
                    description: Maximum body size in bytes (max 100 MB)
                  next_cases:
                    oneOf:
                      - type: array
                        items:
                          $ref: '#/definitions/httpErrorCode'
                        contains:
                          const: off
                        maxItems: 1
                        minItems: 1
                      - type: array
                        items:
                          $ref: '#/definitions/httpErrorCode'
                        not:
                          contains:
                            const: off
                  next_timeout:
                    type: integer
                    minimum: 0
                  next_tries:
                    type: integer
                    minimum: 0
                  read_timeout:
                    type: integer
                    minimum: 0
                    maximum: 60000
                    description: Read timeout in milliseconds (max 60 seconds)
                  send_timeout:
                    type: integer
                    minimum: 0
                    maximum: 60000
                    description: Send timeout in milliseconds (max 60 seconds)
                type: object
              port:
                $ref: '#/definitions/portNumber'
              proto:
                enum:
                  - TCP
                  - UDP
                  - tcp
                  - udp
                type: string
              to:
                items:
                  additionalProperties: false
                  properties:
                    global:
                      type: boolean
                    ip:
                      minLength: 1
                      type: string
                    service:
                      type: string
                  allOf:
                    - $ref: '#/definitions/exposeToWithIpEnforcesGlobal'
                  type: object
                type: array
            required:
              - port
            type: object
          type: array
        image:
          type: string
          minLength: 1
        params:
          additionalProperties: false
          properties:
            storage:
              additionalProperties:
                additionalProperties: false
                properties:
                  mount:
                    $ref: '#/definitions/absolutePath'
                  readOnly:
                    type: boolean
                type: object
              type: object
          type: object
      required:
        - image
      type: object
      additionalProperties: false
    type: object

  version:
    description: SDL version
    enum:
      - '2.0'
      - '2.1'
    type: string

required:
  - version
  - services
  - profiles
  - deployment
title: VirtEngine SDL Input Schema
type: object
