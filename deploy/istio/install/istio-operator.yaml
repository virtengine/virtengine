apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: virtengine-istio
  namespace: istio-system
spec:
  profile: default
  
  # ============================================================================
  # Mesh Configuration
  # ============================================================================
  meshConfig:
    # Enable mTLS STRICT mode - all service-to-service communication must be encrypted
    # PERMISSIVE mode can be used during migration to allow both mTLS and plaintext
    defaultConfig:
      holdApplicationUntilProxyStarts: true
      proxyMetadata:
        # Correlation ID propagation for request tracing
        ISTIO_META_CORRELATION_ID: "true"
    
    # Access logging to stdout for centralized log aggregation
    accessLogFile: /dev/stdout
    accessLogFormat: |
      [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
      %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION%
      %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
      "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%"
      "%UPSTREAM_HOST%" "%UPSTREAM_CLUSTER%" "%UPSTREAM_LOCAL_ADDRESS%"
      "%DOWNSTREAM_LOCAL_ADDRESS%" "%DOWNSTREAM_REMOTE_ADDRESS%"
      "%REQUESTED_SERVER_NAME%" "%ROUTE_NAME%" "%REQ(X-VE-CORRELATION-ID)%"
    
    # Enable distributed tracing with OpenTelemetry
    enableTracing: true
    
    # OpenTelemetry exporter configuration
    extensionProviders:
      - name: otel
        opentelemetry:
          service: otel-collector.virtengine-observability.svc.cluster.local
          port: 4317
          maxTagLength: 256
      
      # Envoy external authorization for request signing verification
      - name: ve-authz
        envoyExtAuthzGrpc:
          service: virtengine-gateway-authz.istio-system.svc.cluster.local
          port: 9191
          timeout: 3s
          includeHeadersInCheck:
            - "x-ve-address"
            - "x-ve-timestamp"
            - "x-ve-nonce"
            - "x-ve-signature"
            - "x-ve-pubkey"
            - "authorization"
      
      # Prometheus metrics scraping
      - name: prometheus
        prometheus: {}
    
    # Service discovery and DNS
    dnsRefreshRate: 5s
    
    # Trust domain for mTLS certificates
    trustDomain: "virtengine.local"
    
    # Enable automatic mTLS
    enableAutoMtls: true
  
  # ============================================================================
  # Component Configuration
  # ============================================================================
  components:
    # Istiod (control plane) configuration
    pilot:
      enabled: true
      k8s:
        resources:
          requests:
            cpu: 500m
            memory: 2048Mi
          limits:
            cpu: 2000m
            memory: 4096Mi
        # High availability - 2 replicas minimum
        replicaCount: 2
        hpaSpec:
          minReplicas: 2
          maxReplicas: 5
          metrics:
            - type: Resource
              resource:
                name: cpu
                target:
                  type: Utilization
                  averageUtilization: 80
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - istiod
                topologyKey: kubernetes.io/hostname
        env:
          # Enable protocol sniffing for automatic protocol detection
          - name: PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_OUTBOUND
            value: "true"
          - name: PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_INBOUND
            value: "true"
          # Increase push timeout for large meshes
          - name: PILOT_PUSH_THROTTLE
            value: "100"
          - name: PILOT_MAX_REQUESTS_PER_SECOND
            value: "25"
    
    # Ingress gateway configuration
    ingressGateways:
      - name: istio-ingressgateway
        enabled: true
        k8s:
          resources:
            requests:
              cpu: 1000m
              memory: 1024Mi
            limits:
              cpu: 2000m
              memory: 2048Mi
          # High availability
          replicaCount: 2
          hpaSpec:
            minReplicas: 2
            maxReplicas: 10
            metrics:
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: 80
          service:
            type: LoadBalancer
            ports:
              # HTTP/HTTPS ports
              - name: http2
                port: 80
                targetPort: 8080
                protocol: TCP
              - name: https
                port: 443
                targetPort: 8443
                protocol: TCP
              # gRPC ports for provider and chain
              - name: grpc-provider
                port: 8444
                targetPort: 8444
                protocol: TCP
              - name: grpc-chain
                port: 9090
                targetPort: 9090
                protocol: TCP
              # Status port for health checks
              - name: status-port
                port: 15021
                targetPort: 15021
                protocol: TCP
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: app
                        operator: In
                        values:
                          - istio-ingressgateway
                  topologyKey: kubernetes.io/hostname
    
    # Egress gateway for controlled external access
    egressGateways:
      - name: istio-egressgateway
        enabled: true
        k8s:
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1024Mi
          replicaCount: 2
  
  # ============================================================================
  # Global Values
  # ============================================================================
  values:
    global:
      # Logging configuration
      logging:
        level: "default:info"
      
      # mTLS configuration
      # STRICT: Only mTLS connections allowed
      # PERMISSIVE: Both mTLS and plaintext allowed (for migration)
      mtls:
        mode: STRICT
      
      # Multi-cluster configuration (future-proofing)
      multiCluster:
        clusterName: "virtengine-primary"
      
      # Network name for multi-network support
      network: "virtengine-network"
      
      # Trace sampling rate (100% for development, tune for production)
      tracer:
        zipkin:
          address: ""
        lightstep:
          address: ""
        datadog:
          address: ""
        stackdriver:
          debug: false
          maxNumberOfAttributes: 200
          maxNumberOfAnnotations: 200
          maxNumberOfMessageEvents: 200
    
    # Pilot (Istiod) configuration
    pilot:
      # Trace sampling: 100% for dev, 1-10% for production
      traceSampling: 100.0
      
      # Enable Kubernetes gateway API support
      env:
        PILOT_ENABLE_GATEWAY_API: "true"
        PILOT_ENABLE_GATEWAY_API_STATUS: "true"
        PILOT_ENABLE_GATEWAY_API_DEPLOYMENT_CONTROLLER: "true"
    
    # Sidecar injector configuration
    sidecarInjectorWebhook:
      # Enable sidecar injection by default for labeled namespaces
      enableNamespacesByDefault: false
      
      # Rewrite app probes to go through the sidecar
      rewriteAppHTTPProbe: true
      
      # Default resources for sidecars
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 2000m
          memory: 1024Mi
    
    # Gateway configuration
    gateways:
      istio-ingressgateway:
        # Enable automatic discovery of gateway resources
        autoscaleEnabled: true
        autoscaleMin: 2
        autoscaleMax: 10
        
        # Connection draining during shutdown
        terminationDrainDuration: 30s
        
        # Resource limits enforced at gateway level
        cpu:
          targetAverageUtilization: 80
        
        # Security context
        runAsRoot: false
        runAsUser: 1337
        
        # Service annotations for cloud providers
        serviceAnnotations: {}
        
        # Enable SDS (Secret Discovery Service) for certificate management
        sds:
          enabled: true
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 2000m
              memory: 1024Mi
