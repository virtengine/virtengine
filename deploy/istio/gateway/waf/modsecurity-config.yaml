# ModSecurity WAF Configuration for VirtEngine Gateway
# 
# Integrates OWASP Core Rule Set (CRS) with custom rules for blockchain API patterns.
# Protects against common web attacks while allowing legitimate blockchain traffic.
#
# Deployment: ModSecurity runs as an Envoy external processor filter

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: modsecurity-config
  namespace: istio-system
  labels:
    app: virtengine-gateway
    component: waf
data:
  modsecurity.conf: |
    # ModSecurity Core Configuration
    # ==========================================================================
    
    # Basic engine configuration
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecResponseBodyMimeType text/plain text/html text/xml application/json
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyLimitAction Reject
    
    # Reject requests with unknown Transfer-Encoding
    SecRule REQUEST_HEADERS:Transfer-Encoding "!^(?:chunked)?$" \
        "id:1000,phase:1,deny,status:400,log,msg:'Unknown Transfer-Encoding'"
    
    # Audit logging
    SecAuditEngine RelevantOnly
    SecAuditLogRelevantStatus "^(?:5|4(?!04))"
    SecAuditLogParts ABIJDEFHZ
    SecAuditLogType Serial
    SecAuditLog /var/log/modsecurity/audit.log
    SecAuditLogFormat JSON
    
    # Debug logging (disable in production)
    SecDebugLog /var/log/modsecurity/debug.log
    SecDebugLogLevel 0
    
    # Argument separator
    SecArgumentSeparator &
    
    # Cookie format
    SecCookieFormat 0
    
    # Unicode mapping
    SecUnicodeMapFile unicode.mapping 20127
    
    # Geo IP database (optional)
    # SecGeoLookupDb /usr/share/GeoIP/GeoLiteCity.dat
    
    # Collection timeout
    SecCollectionTimeout 600
    
    # Temp directory
    SecTmpDir /tmp/
    SecDataDir /tmp/
    
    # File upload limits
    SecUploadDir /tmp/
    SecUploadKeepFiles Off
    SecUploadFileMode 0600
    
    # Response headers
    SecServerSignature "VirtEngine Gateway"
    SecComponentSignature "ModSecurity/3.0.8"
    
    # ==========================================================================
    # Custom Rules for VirtEngine Blockchain APIs
    # ==========================================================================
    
    # Allow specific blockchain patterns that might trigger false positives
    
    # Rule: Allow Cosmos SDK message types (contain slashes)
    SecRule REQUEST_URI "@contains /cosmos" \
        "id:9001,phase:1,pass,nolog,ctl:ruleRemoveById=920420"
    
    SecRule REQUEST_URI "@contains /virtengine" \
        "id:9002,phase:1,pass,nolog,ctl:ruleRemoveById=920420"
    
    # Rule: Allow base64-encoded public keys and signatures
    SecRule REQUEST_HEADERS:X-VE-Signature "@rx ^[A-Za-z0-9+/=]+$" \
        "id:9003,phase:1,pass,nolog,ctl:ruleRemoveById=942432"
    
    SecRule REQUEST_HEADERS:X-VE-PubKey "@rx ^[A-Za-z0-9+/=]+$" \
        "id:9004,phase:1,pass,nolog,ctl:ruleRemoveById=942432"
    
    # Rule: Allow bech32 addresses (ve1...)
    SecRule REQUEST_HEADERS:X-VE-Address "@rx ^ve1[a-z0-9]{38,}$" \
        "id:9005,phase:1,pass,nolog"
    
    # Rule: Allow hex-encoded transaction hashes
    SecRule REQUEST_URI "@rx /tx/0x[A-Fa-f0-9]{64}" \
        "id:9006,phase:1,pass,nolog,ctl:ruleRemoveById=920420"
    
    # Rule: Allow large JSON payloads for deployment manifests
    SecRule REQUEST_URI "@contains /provider/v1/manifest" \
        "id:9007,phase:1,pass,nolog,ctl:ruleRemoveById=920420"
    
    # Rule: Allow WebSocket upgrade for blockchain subscriptions
    SecRule REQUEST_HEADERS:Upgrade "@streq websocket" \
        "chain,id:9008,phase:1,pass,nolog"
    SecRule REQUEST_URI "@contains /websocket" \
        "ctl:ruleRemoveById=920420"
    
    # ==========================================================================
    # Security Rules
    # ==========================================================================
    
    # Block SQL injection attempts in query parameters
    SecRule ARGS "@detectSQLi" \
        "id:9100,phase:2,deny,status:403,log,msg:'SQL Injection Attempt Detected',\
        logdata:'Matched Data: %{MATCHED_VAR}',tag:'attack-sqli'"
    
    # Block XSS attempts
    SecRule ARGS "@detectXSS" \
        "id:9101,phase:2,deny,status:403,log,msg:'XSS Attack Detected',\
        logdata:'Matched Data: %{MATCHED_VAR}',tag:'attack-xss'"
    
    # Block shell command injection
    SecRule ARGS "@rx (?:;|\||`|&|\$\(|\$\{)" \
        "id:9102,phase:2,deny,status:403,log,msg:'Shell Command Injection Attempt',\
        logdata:'Matched Data: %{MATCHED_VAR}',tag:'attack-injection-shell'"
    
    # Block path traversal
    SecRule ARGS "@rx (?:\.\.\/|\.\.\\)" \
        "id:9103,phase:2,deny,status:403,log,msg:'Path Traversal Attempt',\
        logdata:'Matched Data: %{MATCHED_VAR}',tag:'attack-path-traversal'"
    
    # Rate limit protection (complement to Envoy rate limiting)
    SecAction "id:9200,phase:1,pass,nolog,initcol:ip=%{REMOTE_ADDR}"
    
    SecRule IP:REQUEST_COUNT "@gt 1000" \
        "id:9201,phase:1,deny,status:429,log,msg:'Rate Limit Exceeded',\
        setvar:ip.request_count=+1,expirevar:ip.request_count=60"
    
    # Anomaly scoring mode
    SecDefaultAction "phase:1,pass,log,tag:'VirtEngine'"
    SecDefaultAction "phase:2,pass,log,tag:'VirtEngine'"
    
    # ==========================================================================
    # OWASP CRS v3.3 Integration
    # ==========================================================================
    
    # Load OWASP Core Rule Set
    # These rules are loaded from separate files in /etc/modsecurity/coreruleset/
    # Include /etc/modsecurity/coreruleset/crs-setup.conf
    # Include /etc/modsecurity/coreruleset/rules/*.conf
    
    # Paranoia level (1-4, higher = more strict)
    # Level 1: Basic protection (recommended for production)
    # Level 2: Increased protection
    # Level 3: High protection (may cause false positives)
    # Level 4: Maximum protection (expect false positives)
    SecAction \
      "id:900000,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.paranoia_level=1"
    
    # Anomaly scoring thresholds
    SecAction \
      "id:900110,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.inbound_anomaly_score_threshold=5,\
       setvar:tx.outbound_anomaly_score_threshold=4"
    
    # ==========================================================================
    # Response Headers
    # ==========================================================================
    
    # Add security headers to responses
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:; frame-ancestors 'none'"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

---
# OWASP CRS Setup Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: modsecurity-crs-setup
  namespace: istio-system
  labels:
    app: virtengine-gateway
    component: waf
data:
  crs-setup.conf: |
    # OWASP ModSecurity Core Rule Set (CRS) Setup
    # Version: 3.3.x
    
    # Paranoia Level
    SecAction \
      "id:900000,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.paranoia_level=1"
    
    # Executing Paranoia Level
    SecAction \
      "id:900001,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.executing_paranoia_level=%{tx.paranoia_level}"
    
    # Anomaly Scoring Mode
    SecAction \
      "id:900110,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.inbound_anomaly_score_threshold=5,\
       setvar:tx.outbound_anomaly_score_threshold=4"
    
    # HTTP Policy
    SecAction \
      "id:900200,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE,\
       setvar:tx.allowed_request_content_type=application/x-www-form-urlencoded|multipart/form-data|text/xml|application/xml|application/soap+xml|application/json|application/cloudevents+json|application/cloudevents-batch+json,\
       setvar:tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0,\
       setvar:tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/,\
       setvar:tx.restricted_headers=/proxy/ /lock-token/ /content-range/ /if/,\
       setvar:tx.static_extensions=/.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/"
    
    # File Upload
    SecAction \
      "id:900300,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.max_file_size=52428800,\
       setvar:tx.combined_file_sizes=52428800"
    
    # Anti-Automation / DoS Protection
    SecAction \
      "id:900400,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.dos_burst_time_slice=60,\
       setvar:tx.dos_counter_threshold=100,\
       setvar:tx.dos_block_timeout=600"
    
    # Sampling
    SecAction \
      "id:900500,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.sampling_percentage=100"

---
# ModSecurity Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: modsecurity-waf
  namespace: istio-system
  labels:
    app: modsecurity-waf
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: modsecurity-waf
  template:
    metadata:
      labels:
        app: modsecurity-waf
        version: v1
    spec:
      containers:
        - name: modsecurity
          image: owasp/modsecurity-crs:3.3.4-nginx
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          env:
            - name: PARANOIA
              value: "1"
            - name: ANOMALY_INBOUND
              value: "5"
            - name: ANOMALY_OUTBOUND
              value: "4"
            - name: PROXY
              value: "1"
            - name: PROXY_SSL
              value: "1"
            - name: BACKEND
              value: "http://istio-ingressgateway.istio-system.svc.cluster.local"
            - name: PORT
              value: "8080"
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 512Mi
          volumeMounts:
            - name: modsecurity-config
              mountPath: /etc/modsecurity.d/modsecurity-override.conf
              subPath: modsecurity.conf
            - name: crs-setup
              mountPath: /etc/modsecurity.d/owasp-crs/crs-setup.conf
              subPath: crs-setup.conf
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: modsecurity-config
          configMap:
            name: modsecurity-config
        - name: crs-setup
          configMap:
            name: modsecurity-crs-setup

---
apiVersion: v1
kind: Service
metadata:
  name: modsecurity-waf
  namespace: istio-system
  labels:
    app: modsecurity-waf
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      name: http
      protocol: TCP
  selector:
    app: modsecurity-waf
