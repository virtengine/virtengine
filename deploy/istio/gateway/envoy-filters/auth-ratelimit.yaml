# EnvoyFilter for Wallet-Signed Request Verification
# 
# This filter validates wallet-signed requests at the gateway level before
# routing to backend services. It integrates with the existing cosmos_verify.go
# logic but implements it as an external authorization service.
#
# Authentication flow:
# 1. Client signs request with wallet (method, path, timestamp, nonce, body_hash)
# 2. Gateway extracts auth headers (X-VE-Address, X-VE-Signature, etc.)
# 3. External authz service verifies signature using secp256k1
# 4. On success, request proceeds with verified address in context
# 5. On failure, request is rejected with 401/403

---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ve-auth-filter
  namespace: istio-system
  labels:
    app: virtengine-gateway
    version: v1
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  
  configPatches:
    # Add external authorization filter to HTTP connection manager
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.ext_authz
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
            
            # gRPC external authorization service
            grpc_service:
              envoy_grpc:
                cluster_name: ext-authz-grpc
              timeout: 3s
            
            # Include request headers in authorization check
            with_request_body:
              max_request_bytes: 65536  # 64KB max body for signature verification
              allow_partial_message: false
              pack_as_bytes: true
            
            # Headers to send to authorization service
            include_peer_certificate: true
            
            # Status on error (fail-closed for security)
            failure_mode_allow: false
            
            # Transport API version
            transport_api_version: V3
            
            # Filter configuration
            filter_enabled:
              runtime_key: ve.auth.enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            
            # Metadata to add to request
            metadata_context_namespaces:
              - virtengine.auth

---
# Cluster definition for external authz service
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ve-auth-cluster
  namespace: istio-system
  labels:
    app: virtengine-gateway
    version: v1
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  
  configPatches:
    - applyTo: CLUSTER
      match:
        context: GATEWAY
      patch:
        operation: ADD
        value:
          name: ext-authz-grpc
          type: STRICT_DNS
          connect_timeout: 1s
          lb_policy: ROUND_ROBIN
          http2_protocol_options: {}
          load_assignment:
            cluster_name: ext-authz-grpc
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: virtengine-gateway-authz.istio-system.svc.cluster.local
                          port_value: 9191
          # Health checking
          health_checks:
            - timeout: 1s
              interval: 10s
              unhealthy_threshold: 2
              healthy_threshold: 2
              grpc_health_check: {}
          
          # Circuit breaker settings
          circuit_breakers:
            thresholds:
              - priority: DEFAULT
                max_connections: 1024
                max_pending_requests: 1024
                max_requests: 1024
                max_retries: 3

---
# EnvoyFilter for Rate Limiting
# 
# Implements per-org and per-endpoint rate limiting using Redis backend.
# Rate limits are enforced AFTER authentication to allow org/project context.

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ve-ratelimit-filter
  namespace: istio-system
  labels:
    app: virtengine-gateway
    version: v1
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  
  configPatches:
    # Add rate limit filter
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.ext_authz
      patch:
        operation: INSERT_AFTER
        value:
          name: envoy.filters.http.ratelimit
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
            domain: virtengine
            
            # Rate limit service configuration
            rate_limit_service:
              grpc_service:
                envoy_grpc:
                  cluster_name: rate-limit-service
                timeout: 0.25s
              transport_api_version: V3
            
            # Failure mode (allow on error for availability)
            failure_mode_deny: false
            
            # Enable X-RateLimit headers in response
            enable_x_ratelimit_headers: DRAFT_VERSION_03
            
            # Rate limit status on error
            rate_limited_as_resource_exhausted: true

---
# Rate limit service cluster
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ve-ratelimit-cluster
  namespace: istio-system
  labels:
    app: virtengine-gateway
    version: v1
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  
  configPatches:
    - applyTo: CLUSTER
      match:
        context: GATEWAY
      patch:
        operation: ADD
        value:
          name: rate-limit-service
          type: STRICT_DNS
          connect_timeout: 0.25s
          lb_policy: ROUND_ROBIN
          http2_protocol_options: {}
          load_assignment:
            cluster_name: rate-limit-service
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: virtengine-ratelimit.istio-system.svc.cluster.local
                          port_value: 8081
          
          # Circuit breaker
          circuit_breakers:
            thresholds:
              - priority: DEFAULT
                max_connections: 512
                max_pending_requests: 512
                max_requests: 512

---
# EnvoyFilter for Correlation ID Injection
# 
# Adds correlation IDs to all requests for distributed tracing and debugging.
# If X-Request-ID exists, use it; otherwise generate a new UUID.

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ve-correlation-id-filter
  namespace: istio-system
  labels:
    app: virtengine-gateway
    version: v1
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  
  configPatches:
    # Inject correlation ID header
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: MERGE
        value:
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
            use_remote_address: true
            xff_num_trusted_hops: 1
            
            # Generate request ID if not present
            request_id_extension:
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.request_id.uuid.v3.UuidRequestIdConfig
                use_request_id_for_trace_sampling: true
            
            # Common TLS parameters
            common_http_protocol_options:
              idle_timeout: 300s
              headers_with_underscores_action: REJECT_REQUEST
            
            # HTTP/2 options
            http2_protocol_options:
              max_concurrent_streams: 100
              initial_stream_window_size: 65536
              initial_connection_window_size: 1048576
            
            # Access log with correlation ID
            access_log:
              - name: envoy.access_loggers.file
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                  path: /dev/stdout
                  format: |
                    [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
                    %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION%
                    "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%"
                    "%REQ(X-VE-CORRELATION-ID)%" "%REQ(X-VE-ADDRESS)%" "%UPSTREAM_HOST%"

---
# EnvoyFilter for Request/Response Header Manipulation
# 
# Adds security headers, sanitizes sensitive data, and injects rate limit info.

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ve-header-manipulation
  namespace: istio-system
  labels:
    app: virtengine-gateway
    version: v1
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  
  configPatches:
    # Response header manipulation
    - applyTo: HTTP_ROUTE
      match:
        context: GATEWAY
      patch:
        operation: MERGE
        value:
          typed_per_filter_config:
            envoy.filters.http.lua:
              "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute
              source_code:
                inline_string: |
                  function envoy_on_response(response_handle)
                    -- Add security headers
                    response_handle:headers():add("X-Content-Type-Options", "nosniff")
                    response_handle:headers():add("X-Frame-Options", "DENY")
                    response_handle:headers():add("X-XSS-Protection", "1; mode=block")
                    response_handle:headers():add("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
                    
                    -- Remove internal headers
                    response_handle:headers():remove("X-Envoy-Upstream-Service-Time")
                    response_handle:headers():remove("X-Envoy-Decorator-Operation")
                    
                    -- Add correlation ID to response
                    local req_id = response_handle:headers():get("x-request-id")
                    if req_id then
                      response_handle:headers():add("X-VE-Correlation-ID", req_id)
                    end
                  end
