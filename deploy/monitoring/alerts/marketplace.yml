# VirtEngine Marketplace Alert Rules
# Alerts for marketplace orders, bids, and leases

groups:
  # =============================================================================
  # Marketplace Availability
  # =============================================================================
  - name: market_availability
    interval: 30s
    rules:
      # Marketplace operations unavailable
      - alert: MarketplaceUnavailable
        expr: |
          sum(rate(market_operations_total{status="success"}[5m])) /
          sum(rate(market_operations_total[5m])) < 0.9
        for: 5m
        labels:
          severity: critical
          service: market
          tier: tier1
        annotations:
          summary: "Marketplace operations degraded"
          description: "Marketplace success rate is {{ $value | humanizePercentage }}, target is > 99.5%"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/market-unavailable"
          dashboard: "https://grafana.virtengine.com/d/marketplace"

      # Market module errors
      - alert: MarketModuleErrors
        expr: |
          rate(virtengine_errors_total{module="market"}[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "High market module error rate"
          description: "Market module errors at {{ $value }} errors/sec"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/market-errors"

  # =============================================================================
  # Order Processing
  # =============================================================================
  - name: market_orders
    interval: 30s
    rules:
      # Order backlog growing
      - alert: MarketOrderBacklog
        expr: market_orders_pending > 100
        for: 10m
        labels:
          severity: high
          service: market
          tier: tier1
        annotations:
          summary: "Market order backlog growing"
          description: "{{ $value }} orders pending fulfillment"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/market-order-backlog"

      # Order backlog critical
      - alert: MarketOrderBacklogCritical
        expr: market_orders_pending > 500
        for: 5m
        labels:
          severity: critical
          service: market
          tier: tier1
        annotations:
          summary: "CRITICAL: Market order backlog critically high"
          description: "{{ $value }} orders pending, customer impact severe"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/market-order-backlog-critical"

      # Order fulfillment time too long
      - alert: OrderFulfillmentTimeLong
        expr: |
          histogram_quantile(0.95, 
            sum(rate(market_order_fulfillment_seconds_bucket[1h])) by (le)
          ) > 600
        for: 15m
        labels:
          severity: high
          service: market
          tier: tier1
        annotations:
          summary: "Order fulfillment P95 exceeds 10 minutes"
          description: "Order fulfillment P95 is {{ $value | humanizeDuration }}, target is < 10 minutes"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/order-fulfillment-slow"

      # Order failure rate high
      - alert: OrderFailureRateHigh
        expr: |
          rate(market_orders_failed_total[1h]) /
          rate(market_orders_created_total[1h]) > 0.1
        for: 30m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "High order failure rate"
          description: "{{ $value | humanizePercentage }} of orders are failing"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/order-failures"

      # No orders being created
      - alert: NoOrdersCreated
        expr: |
          sum(rate(market_orders_created_total[30m])) == 0
        for: 30m
        labels:
          severity: info
          service: market
          tier: tier1
        annotations:
          summary: "No marketplace orders created"
          description: "No orders created in the last 30 minutes"

  # =============================================================================
  # Bid Processing
  # =============================================================================
  - name: market_bids
    interval: 30s
    rules:
      # No bids received for orders
      - alert: NoBidsReceived
        expr: |
          market_orders_pending > 10 and
          rate(market_bids_received_total[10m]) == 0
        for: 10m
        labels:
          severity: high
          service: market
          tier: tier1
        annotations:
          summary: "No bids being received for pending orders"
          description: "{{ with query \"market_orders_pending\" }}{{ . | first | value }}{{ end }} orders pending but no bids in 10 minutes"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/no-bids"

      # Bid response time too slow
      - alert: BidResponseTimeSlow
        expr: |
          histogram_quantile(0.90, 
            sum(rate(market_bid_response_seconds_bucket[1h])) by (le)
          ) > 120
        for: 15m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "Bid response P90 exceeds 2 minutes"
          description: "Bid response P90 is {{ $value | humanizeDuration }}, target is < 2 minutes"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/slow-bids"

      # Bid rejection rate high
      - alert: BidRejectionRateHigh
        expr: |
          rate(market_bids_rejected_total[1h]) /
          rate(market_bids_received_total[1h]) > 0.5
        for: 30m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "High bid rejection rate"
          description: "{{ $value | humanizePercentage }} of bids are being rejected"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/bid-rejections"

  # =============================================================================
  # Lease Management
  # =============================================================================
  - name: market_leases
    interval: 30s
    rules:
      # Lease creation failures
      - alert: LeaseCreationFailures
        expr: |
          rate(market_lease_creation_errors_total[5m]) > 0.1
        for: 10m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "Lease creation failures detected"
          description: "{{ $value }} lease creation failures per second"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/lease-creation-failures"

      # Lease termination rate high
      - alert: LeaseTerminationRateHigh
        expr: |
          rate(market_leases_terminated_total{reason!="completed"}[1h]) /
          rate(market_leases_created_total[1h]) > 0.2
        for: 1h
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "High lease termination rate"
          description: "{{ $value | humanizePercentage }} of leases are being terminated prematurely"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/lease-terminations"

      # Lease dispute rate
      - alert: LeaseDisputeRate
        expr: |
          rate(market_lease_disputes_total[24h]) > 1
        for: 1h
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "Lease disputes detected"
          description: "{{ $value }} lease disputes per day"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/lease-disputes"

  # =============================================================================
  # Escrow Operations
  # =============================================================================
  - name: market_escrow
    interval: 30s
    rules:
      # Escrow balance issues
      - alert: EscrowBalanceIssues
        expr: |
          rate(escrow_balance_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: high
          service: escrow
          tier: tier1
        annotations:
          summary: "Escrow balance errors detected"
          description: "{{ $value }} escrow balance errors per second"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/escrow-errors"

      # Escrow withdrawal failures
      - alert: EscrowWithdrawalFailures
        expr: |
          rate(escrow_withdrawal_errors_total[5m]) > 0.1
        for: 10m
        labels:
          severity: high
          service: escrow
          tier: tier1
        annotations:
          summary: "Escrow withdrawal failures detected"
          description: "{{ $value }} withdrawal failures per second"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/escrow-withdrawal-failures"

      # Escrow settlement delays
      - alert: EscrowSettlementDelayed
        expr: |
          histogram_quantile(0.95, 
            sum(rate(escrow_settlement_duration_seconds_bucket[1h])) by (le)
          ) > 300
        for: 30m
        labels:
          severity: warning
          service: escrow
          tier: tier1
        annotations:
          summary: "Escrow settlement P95 exceeds 5 minutes"
          description: "Settlement P95 is {{ $value | humanizeDuration }}"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/escrow-settlement-delays"

  # =============================================================================
  # Provider Health
  # =============================================================================
  - name: market_providers
    interval: 60s
    rules:
      # Active provider count low
      - alert: ActiveProviderCountLow
        expr: market_providers_active < 5
        for: 10m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "Low active provider count"
          description: "Only {{ $value }} active providers in marketplace"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/low-providers"

      # Provider capacity utilization high
      - alert: ProviderCapacityUtilizationHigh
        expr: |
          (market_total_allocated_resources / market_total_available_resources) * 100 > 90
        for: 30m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "High provider capacity utilization"
          description: "{{ $value | humanize }}% of total provider capacity is allocated"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/capacity-high"

      # No providers available for resource type
      - alert: NoProvidersForResourceType
        expr: |
          market_providers_by_resource_type{type=~"gpu|hpc"} == 0
        for: 30m
        labels:
          severity: warning
          service: market
          tier: tier1
        annotations:
          summary: "No providers for resource type {{ $labels.type }}"
          description: "No active providers offering {{ $labels.type }} resources"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/no-providers-resource"
