# VirtEngine SLO Compliance Alert Rules
# Alerts for SLO violations and error budget burn rate

groups:
  # =============================================================================
  # Error Budget Alerts
  # =============================================================================
  - name: slo_error_budget
    interval: 60s
    rules:
      # Error budget depleted
      - alert: ErrorBudgetDepleted
        expr: |
          (1 - virtengine_slo_error_budget_remaining_ratio) * 100 > 95
        for: 5m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "CRITICAL: Error budget depleted for {{ $labels.service }}"
          description: "Error budget for {{ $labels.service }} is {{ $value | humanize }}% consumed. Feature freeze required."
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/error-budget-depleted"
          dashboard: "https://grafana.virtengine.com/d/error-budget"

      # Error budget critical
      - alert: ErrorBudgetCritical
        expr: |
          (1 - virtengine_slo_error_budget_remaining_ratio) * 100 > 75
        for: 15m
        labels:
          severity: high
          service: "{{ $labels.service }}"
        annotations:
          summary: "Error budget critical for {{ $labels.service }}"
          description: "Error budget for {{ $labels.service }} is {{ $value | humanize }}% consumed"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/error-budget-critical"

      # Error budget warning
      - alert: ErrorBudgetWarning
        expr: |
          (1 - virtengine_slo_error_budget_remaining_ratio) * 100 > 50
        for: 30m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "Error budget warning for {{ $labels.service }}"
          description: "Error budget for {{ $labels.service }} is {{ $value | humanize }}% consumed"

  # =============================================================================
  # Error Budget Burn Rate
  # =============================================================================
  - name: slo_burn_rate
    interval: 60s
    rules:
      # Fast burn rate - 10x (5 minutes)
      - alert: ErrorBudgetBurnRateCritical
        expr: |
          (
            rate(virtengine_slo_errors_total[5m]) /
            rate(virtengine_slo_requests_total[5m])
          ) / (1 - virtengine_slo_target) > 10
        for: 5m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "CRITICAL: Fast error budget burn rate for {{ $labels.service }}"
          description: "Error budget burn rate is {{ $value | humanize }}x sustainable rate. Consider automatic rollback."
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/fast-burn-rate"

      # High burn rate - 5x (15 minutes)
      - alert: ErrorBudgetBurnRateHigh
        expr: |
          (
            rate(virtengine_slo_errors_total[15m]) /
            rate(virtengine_slo_requests_total[15m])
          ) / (1 - virtengine_slo_target) > 5
        for: 15m
        labels:
          severity: high
          service: "{{ $labels.service }}"
        annotations:
          summary: "High error budget burn rate for {{ $labels.service }}"
          description: "Error budget burn rate is {{ $value | humanize }}x sustainable rate"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/high-burn-rate"

      # Elevated burn rate - 2x (1 hour)
      - alert: ErrorBudgetBurnRateElevated
        expr: |
          (
            rate(virtengine_slo_errors_total[1h]) /
            rate(virtengine_slo_requests_total[1h])
          ) / (1 - virtengine_slo_target) > 2
        for: 1h
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "Elevated error budget burn rate for {{ $labels.service }}"
          description: "Error budget burn rate is {{ $value | humanize }}x sustainable rate"

  # =============================================================================
  # Node SLO Alerts
  # =============================================================================
  - name: slo_node
    interval: 30s
    rules:
      # Node uptime SLO violation
      - alert: NodeUptimeSLOViolation
        expr: |
          (
            sum_over_time(up{job="virtengine-node"}[28d]) /
            count_over_time(up{job="virtengine-node"}[28d])
          ) < 0.9995
        for: 5m
        labels:
          severity: high
          slo: SLO-NODE-001
        annotations:
          summary: "Node uptime below 99.95% SLO"
          description: "Node uptime is {{ $value | humanizePercentage }}, target is 99.95%"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/node-uptime-slo"

      # Transaction confirmation latency SLO
      - alert: TransactionConfirmationSLOViolation
        expr: |
          histogram_quantile(0.95, 
            sum(rate(tendermint_tx_confirmation_seconds_bucket[1h])) by (le)
          ) > 10
        for: 30m
        labels:
          severity: warning
          slo: SLO-NODE-005
        annotations:
          summary: "Transaction confirmation P95 exceeds 10 seconds"
          description: "Transaction confirmation P95 is {{ $value | humanizeDuration }}"

      # Query response latency SLO
      - alert: QueryResponseSLOViolation
        expr: |
          histogram_quantile(0.95, 
            sum(rate(grpc_server_handling_seconds_bucket{grpc_type="unary"}[1h])) by (le)
          ) > 2
        for: 30m
        labels:
          severity: warning
          slo: SLO-NODE-006
        annotations:
          summary: "Query response P95 exceeds 2 seconds"
          description: "Query response P95 is {{ $value | humanizeDuration }}"

  # =============================================================================
  # Provider Daemon SLO Alerts
  # =============================================================================
  - name: slo_provider
    interval: 30s
    rules:
      # Provider daemon uptime SLO
      - alert: ProviderDaemonUptimeSLOViolation
        expr: |
          (
            sum_over_time(up{job="provider-daemon"}[28d]) /
            count_over_time(up{job="provider-daemon"}[28d])
          ) < 0.999
        for: 5m
        labels:
          severity: warning
          slo: SLO-PROV-001
        annotations:
          summary: "Provider daemon uptime below 99.90% SLO"
          description: "Provider daemon uptime is {{ $value | humanizePercentage }}"

      # Deployment success rate SLO
      - alert: DeploymentSuccessRateSLOViolation
        expr: |
          (
            sum(rate(provider_deployments_successful_total[24h])) /
            sum(rate(provider_deployments_total[24h]))
          ) < 0.99
        for: 1h
        labels:
          severity: warning
          slo: SLO-PROV-003
        annotations:
          summary: "Deployment success rate below 99% SLO"
          description: "Deployment success rate is {{ $value | humanizePercentage }}"

      # Provisioning latency SLO
      - alert: ProvisioningLatencySLOViolation
        expr: |
          histogram_quantile(0.95, 
            sum(rate(provider_provisioning_duration_seconds_bucket[24h])) by (le)
          ) > 300
        for: 1h
        labels:
          severity: warning
          slo: SLO-PROV-005
        annotations:
          summary: "Provisioning P95 exceeds 5 minutes SLO"
          description: "Provisioning P95 is {{ $value | humanizeDuration }}"

  # =============================================================================
  # API SLO Alerts
  # =============================================================================
  - name: slo_api
    interval: 30s
    rules:
      # API availability SLO
      - alert: APIAvailabilitySLOViolation
        expr: |
          (
            sum(rate(http_requests_total{code!~"5.."}[1h])) /
            sum(rate(http_requests_total[1h]))
          ) < 0.999
        for: 30m
        labels:
          severity: warning
          slo: SLO-API-001
        annotations:
          summary: "API availability below 99.90% SLO"
          description: "API availability is {{ $value | humanizePercentage }}"

      # API error rate SLO
      - alert: APIErrorRateSLOViolation
        expr: |
          (
            sum(rate(http_requests_total{code=~"5.."}[1h])) /
            sum(rate(http_requests_total[1h]))
          ) > 0.005
        for: 30m
        labels:
          severity: warning
          slo: SLO-API-002
        annotations:
          summary: "API error rate exceeds 0.5% SLO"
          description: "API error rate is {{ $value | humanizePercentage }}"

      # API latency SLO
      - alert: APILatencySLOViolation
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_request_duration_seconds_bucket[1h])) by (le)
          ) > 2
        for: 30m
        labels:
          severity: warning
          slo: SLO-API-003
        annotations:
          summary: "API P95 latency exceeds 2 seconds SLO"
          description: "API P95 latency is {{ $value | humanizeDuration }}"

  # =============================================================================
  # Multi-Window SLO Alerts
  # =============================================================================
  - name: slo_multi_window
    interval: 60s
    rules:
      # Fast burn + slow burn combined
      - alert: SLOMultiWindowAlert
        expr: |
          (
            (
              rate(virtengine_slo_errors_total[1h]) /
              rate(virtengine_slo_requests_total[1h])
            ) > 14 * (1 - virtengine_slo_target)
            and
            (
              rate(virtengine_slo_errors_total[5m]) /
              rate(virtengine_slo_requests_total[5m])
            ) > 14 * (1 - virtengine_slo_target)
          )
          or
          (
            (
              rate(virtengine_slo_errors_total[6h]) /
              rate(virtengine_slo_requests_total[6h])
            ) > 6 * (1 - virtengine_slo_target)
            and
            (
              rate(virtengine_slo_errors_total[30m]) /
              rate(virtengine_slo_requests_total[30m])
            ) > 6 * (1 - virtengine_slo_target)
          )
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "Multi-window SLO burn alert for {{ $labels.service }}"
          description: "Service is burning error budget faster than sustainable in multiple time windows"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/multi-window-burn"
