# VirtEngine Chain Health Alert Rules
# Critical alerts for blockchain consensus and operations

groups:
  # =============================================================================
  # Block Production Alerts
  # =============================================================================
  - name: virtengine_chain_health
    interval: 15s
    rules:
      # Chain halted - no new blocks
      - alert: ChainHalted
        expr: time() - max(tendermint_consensus_latest_block_time) > 30
        for: 1m
        labels:
          severity: critical
          service: chain
          tier: tier0
        annotations:
          summary: "CRITICAL: Chain halted - no new blocks produced"
          description: "No new blocks have been produced for {{ $value | humanizeDuration }}. Last block time: {{ with query \"tendermint_consensus_latest_block_time\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/chain-halted"
          dashboard: "https://grafana.virtengine.com/d/chain-health"

      # Block time too slow
      - alert: BlockTimeSlow
        expr: |
          histogram_quantile(0.99, 
            sum(rate(tendermint_consensus_block_interval_seconds_bucket[10m])) by (le)
          ) > 6
        for: 5m
        labels:
          severity: high
          service: chain
          tier: tier0
        annotations:
          summary: "Block time P99 exceeds 6 seconds"
          description: "Block production P99 latency is {{ $value | humanizeDuration }}, target is < 6s"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/slow-blocks"

      # Block height not increasing
      - alert: BlockHeightStalled
        expr: |
          increase(tendermint_consensus_height[5m]) == 0
        for: 2m
        labels:
          severity: critical
          service: chain
          tier: tier0
        annotations:
          summary: "Block height not increasing"
          description: "Block height has not increased in 5 minutes on {{ $labels.instance }}"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/chain-halted"

  # =============================================================================
  # Consensus Health Alerts
  # =============================================================================
  - name: virtengine_consensus
    interval: 15s
    rules:
      # High consensus round count (indicates trouble reaching consensus)
      - alert: HighConsensusRounds
        expr: tendermint_consensus_rounds > 3
        for: 5m
        labels:
          severity: warning
          service: consensus
          tier: tier0
        annotations:
          summary: "High consensus rounds on {{ $labels.instance }}"
          description: "Consensus is taking {{ $value }} rounds to reach agreement, indicating validator communication issues"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/consensus-issues"

      # Consensus timeout rate
      - alert: ConsensusTimeoutRateHigh
        expr: |
          rate(tendermint_consensus_rounds_total{result="timeout"}[10m]) /
          rate(tendermint_consensus_rounds_total[10m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: consensus
          tier: tier0
        annotations:
          summary: "High consensus timeout rate"
          description: "{{ $value | humanizePercentage }} of consensus rounds are timing out"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/consensus-timeouts"

      # Validator missing blocks
      - alert: ValidatorMissingBlocks
        expr: |
          increase(tendermint_consensus_validator_missed_blocks[1h]) > 10
        for: 5m
        labels:
          severity: warning
          service: validator
          tier: tier0
        annotations:
          summary: "Validator {{ $labels.validator_address }} missing blocks"
          description: "Validator has missed {{ $value }} blocks in the last hour"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/validator-missing-blocks"

      # Low validator power participation
      - alert: LowVotingPowerParticipation
        expr: |
          tendermint_consensus_validators_power / 
          tendermint_consensus_validators_total_power < 0.67
        for: 2m
        labels:
          severity: critical
          service: consensus
          tier: tier0
        annotations:
          summary: "Voting power participation below 67%"
          description: "Only {{ $value | humanizePercentage }} of voting power is participating, consensus may halt"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/low-voting-power"

  # =============================================================================
  # Transaction Processing Alerts
  # =============================================================================
  - name: virtengine_transactions
    interval: 15s
    rules:
      # Mempool size growing
      - alert: MempoolBacklog
        expr: tendermint_mempool_size > 1000
        for: 5m
        labels:
          severity: warning
          service: chain
          tier: tier0
        annotations:
          summary: "Mempool backlog growing on {{ $labels.instance }}"
          description: "Mempool contains {{ $value }} unprocessed transactions"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/mempool-backlog"

      # High transaction failure rate
      - alert: TransactionFailureRateHigh
        expr: |
          rate(tendermint_consensus_tx_count{result="failed"}[5m]) /
          rate(tendermint_consensus_tx_count[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: chain
          tier: tier0
        annotations:
          summary: "High transaction failure rate"
          description: "{{ $value | humanizePercentage }} of transactions are failing"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/tx-failures"

      # Transaction throughput too low
      - alert: TransactionThroughputLow
        expr: |
          rate(tendermint_consensus_tx_count[5m]) < 1
        for: 10m
        labels:
          severity: info
          service: chain
          tier: tier0
        annotations:
          summary: "Low transaction throughput"
          description: "Transaction rate is {{ $value }} TPS, which may indicate low usage or issues"

  # =============================================================================
  # Peer Connectivity Alerts
  # =============================================================================
  - name: virtengine_peers
    interval: 30s
    rules:
      # Low peer count
      - alert: LowPeerCount
        expr: tendermint_p2p_peers < 3
        for: 5m
        labels:
          severity: warning
          service: p2p
          tier: tier0
        annotations:
          summary: "Low peer count on {{ $labels.instance }}"
          description: "Node only has {{ $value }} peers connected"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/low-peers"

      # Peer disconnection rate
      - alert: HighPeerDisconnectionRate
        expr: |
          rate(tendermint_p2p_peer_receive_bytes_total[5m]) == 0 and
          tendermint_p2p_peers > 0
        for: 5m
        labels:
          severity: warning
          service: p2p
          tier: tier0
        annotations:
          summary: "No data received from peers"
          description: "Node {{ $labels.instance }} is not receiving any data from peers"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/peer-connectivity"

  # =============================================================================
  # Node Health Alerts
  # =============================================================================
  - name: virtengine_node_health
    interval: 30s
    rules:
      # Node out of sync
      - alert: NodeOutOfSync
        expr: tendermint_consensus_fast_syncing == 1
        for: 10m
        labels:
          severity: warning
          service: node
          tier: tier0
        annotations:
          summary: "Node {{ $labels.instance }} is syncing"
          description: "Node has been fast syncing for over 10 minutes"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/node-syncing"

      # Node behind
      - alert: NodeBehind
        expr: |
          (max(tendermint_consensus_height) without (instance) - 
           tendermint_consensus_height) > 10
        for: 5m
        labels:
          severity: warning
          service: node
          tier: tier0
        annotations:
          summary: "Node {{ $labels.instance }} is behind"
          description: "Node is {{ $value }} blocks behind the network"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/node-behind"

      # High state sync latency
      - alert: StateSyncLatencyHigh
        expr: |
          histogram_quantile(0.95, 
            sum(rate(cosmos_state_sync_duration_seconds_bucket[5m])) by (le)
          ) > 60
        for: 10m
        labels:
          severity: warning
          service: node
          tier: tier0
        annotations:
          summary: "High state sync latency"
          description: "State sync P95 latency is {{ $value | humanizeDuration }}"

  # =============================================================================
  # Resource Alerts
  # =============================================================================
  - name: virtengine_node_resources
    interval: 30s
    rules:
      # High CPU usage
      - alert: NodeCPUHigh
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 10m
        labels:
          severity: warning
          service: node
          tier: tier0
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value | humanize }}%"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/high-cpu"

      # High memory usage
      - alert: NodeMemoryHigh
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 10m
        labels:
          severity: warning
          service: node
          tier: tier0
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value | humanize }}%"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/high-memory"

      # Disk space low
      - alert: DiskSpaceLow
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / 
           node_filesystem_size_bytes{mountpoint="/"})) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: node
          tier: tier0
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Disk usage is {{ $value | humanize }}%"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/low-disk"

      # Disk space critical
      - alert: DiskSpaceCritical
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / 
           node_filesystem_size_bytes{mountpoint="/"})) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: node
          tier: tier0
        annotations:
          summary: "CRITICAL: Disk space nearly full on {{ $labels.instance }}"
          description: "Disk usage is {{ $value | humanize }}%, immediate action required"
          runbook: "https://github.com/virtengine/virtengine/wiki/runbooks/low-disk"
