# VirtEngine SLO Alert Rules
# MONITOR-001: SLO-based alerting with error budgets

groups:
  # =============================================================================
  # Tier 0 - Critical Services SLO Alerts
  # =============================================================================
  - name: virtengine_slo_tier0
    interval: 30s
    rules:
      # SLO-NODE-001: Node Uptime (99.95%)
      - alert: SLONodeUptimeBudgetBurning
        expr: |
          (
            1 - (
              sum(rate(up{job="virtengine-node"}[1h]))
              / count(up{job="virtengine-node"})
            )
          ) > (1 - 0.9995) * 14.4
        for: 5m
        labels:
          severity: warning
          slo_id: SLO-NODE-001
          service: virtengine-node
          tier: tier0
        annotations:
          summary: "Node uptime SLO budget burning fast"
          description: "Error budget for node uptime is being consumed at 14.4x the sustainable rate"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-node-uptime"
          slo_target: "99.95%"

      - alert: SLONodeUptimeBudgetCritical
        expr: |
          (
            1 - avg_over_time(up{job="virtengine-node"}[28d])
          ) > (1 - 0.9995) * 0.75
        for: 5m
        labels:
          severity: critical
          slo_id: SLO-NODE-001
          service: virtengine-node
          tier: tier0
        annotations:
          summary: "Node uptime SLO budget 75% consumed"
          description: "Only 25% of the monthly error budget remains for node uptime"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-node-uptime-critical"

      # SLO-NODE-005: Transaction Confirmation P95 (< 10s)
      - alert: SLOTxConfirmationLatencyBreach
        expr: |
          histogram_quantile(0.95, sum(rate(virtengine_tx_latency_seconds_bucket{type="confirmation"}[5m])) by (le)) > 10
        for: 5m
        labels:
          severity: warning
          slo_id: SLO-NODE-005
          service: virtengine-node
          tier: tier0
        annotations:
          summary: "Transaction confirmation latency SLO breach"
          description: "P95 transaction confirmation latency is {{ $value | printf \"%.2f\" }}s (SLO: <10s)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-tx-latency"

      # SLO-NODE-006: Query Response P95 (< 2s)
      - alert: SLOQueryLatencyBreach
        expr: |
          histogram_quantile(0.95, sum(rate(virtengine_api_request_duration_seconds_bucket{method=~"Query.*"}[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          slo_id: SLO-NODE-006
          service: virtengine-node
          tier: tier0
        annotations:
          summary: "Query response latency SLO breach"
          description: "P95 query latency is {{ $value | printf \"%.2f\" }}s (SLO: <2s)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-query-latency"

  # =============================================================================
  # Tier 1 - High Priority Services SLO Alerts
  # =============================================================================
  - name: virtengine_slo_tier1
    interval: 30s
    rules:
      # SLO-PROV-001: Provider Daemon Uptime (99.90%)
      - alert: SLOProviderUptimeBudgetBurning
        expr: |
          (
            1 - avg_over_time(up{job="provider-daemon"}[1h])
          ) > (1 - 0.9990) * 14.4
        for: 5m
        labels:
          severity: warning
          slo_id: SLO-PROV-001
          service: provider-daemon
          tier: tier1
        annotations:
          summary: "Provider daemon uptime SLO budget burning"
          description: "Error budget for provider uptime is being consumed at 14.4x the sustainable rate"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-provider-uptime"

      # SLO-PROV-003: Deployment Success Rate (99.00%)
      - alert: SLODeploymentSuccessRateBreach
        expr: |
          (
            sum(rate(virtengine_provider_deployments_total{status="success"}[1h]))
            / sum(rate(virtengine_provider_deployments_total[1h]))
          ) < 0.99
        for: 10m
        labels:
          severity: warning
          slo_id: SLO-PROV-003
          service: provider-daemon
          tier: tier1
        annotations:
          summary: "Deployment success rate below SLO"
          description: "Deployment success rate is {{ $value | printf \"%.2f\" }}% (SLO: 99%)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-deployment-success"

      # SLO-PROV-005: Provisioning Latency P95 (< 300s)
      - alert: SLOProvisioningLatencyBreach
        expr: |
          histogram_quantile(0.95, sum(rate(virtengine_provider_deployment_latency_seconds_bucket{operation="provision"}[1h])) by (le)) > 300
        for: 10m
        labels:
          severity: warning
          slo_id: SLO-PROV-005
          service: provider-daemon
          tier: tier1
        annotations:
          summary: "Provisioning latency SLO breach"
          description: "P95 provisioning latency is {{ $value | printf \"%.0f\" }}s (SLO: <300s)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-provisioning-latency"

      # SLO-API-001: API Availability (99.90%)
      - alert: SLOAPIAvailabilityBreach
        expr: |
          (
            sum(rate(virtengine_api_requests_total{status!~"5.."}[5m]))
            / sum(rate(virtengine_api_requests_total[5m]))
          ) < 0.999
        for: 5m
        labels:
          severity: warning
          slo_id: SLO-API-001
          service: api
          tier: tier1
        annotations:
          summary: "API availability below SLO"
          description: "API availability is {{ $value | printf \"%.4f\" }}% (SLO: 99.90%)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-api-availability"

      # SLO-API-003: Request Latency P95 (< 2s)
      - alert: SLOAPILatencyBreach
        expr: |
          histogram_quantile(0.95, sum(rate(virtengine_api_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          slo_id: SLO-API-003
          service: api
          tier: tier1
        annotations:
          summary: "API request latency SLO breach"
          description: "P95 API latency is {{ $value | printf \"%.2f\" }}s (SLO: <2s)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-api-latency"

  # =============================================================================
  # VEID SLO Alerts
  # =============================================================================
  - name: virtengine_slo_veid
    interval: 30s
    rules:
      # VEID Verification Success Rate
      - alert: SLOVEIDVerificationSuccessRate
        expr: |
          (
            sum(rate(virtengine_veid_verifications_total{status="success"}[1h]))
            / sum(rate(virtengine_veid_verifications_total[1h]))
          ) < 0.95
        for: 10m
        labels:
          severity: warning
          slo_id: SLO-VEID-001
          service: veid
          tier: tier1
        annotations:
          summary: "VEID verification success rate below target"
          description: "VEID verification success rate is {{ $value | printf \"%.2f\" }}% (target: 95%)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-veid-verification"

      # VEID Verification Latency P95
      - alert: SLOVEIDVerificationLatency
        expr: |
          histogram_quantile(0.95, sum(rate(virtengine_veid_verification_latency_seconds_bucket[5m])) by (le)) > 30
        for: 5m
        labels:
          severity: warning
          slo_id: SLO-VEID-002
          service: veid
          tier: tier1
        annotations:
          summary: "VEID verification latency SLO breach"
          description: "P95 VEID verification latency is {{ $value | printf \"%.2f\" }}s (SLO: <30s)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-veid-latency"

      # VEID ML Inference Determinism (Critical - must be 100%)
      - alert: VEIDInferenceNonDeterministic
        expr: increase(virtengine_veid_inference_non_deterministic_total[10m]) > 0
        for: 1m
        labels:
          severity: critical
          slo_id: SLO-VEID-DETERMINISM
          service: veid
          tier: tier0
        annotations:
          summary: "CRITICAL: Non-deterministic ML inference detected"
          description: "{{ $value }} non-deterministic inference results detected. This is a consensus-breaking issue!"
          runbook_url: "https://docs.virtengine.io/runbooks/veid-non-deterministic"
          impact: "Validators may produce different results, causing consensus failures"

  # =============================================================================
  # Marketplace SLO Alerts
  # =============================================================================
  - name: virtengine_slo_marketplace
    interval: 30s
    rules:
      # Order Fill Rate
      - alert: SLOMarketFillRate
        expr: virtengine_market_fill_rate_percent < 90
        for: 30m
        labels:
          severity: warning
          slo_id: SLO-MARKET-001
          service: market
          tier: tier1
        annotations:
          summary: "Marketplace fill rate below target"
          description: "Order fill rate is {{ $value | printf \"%.2f\" }}% (target: 90%)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-market-fill-rate"

      # Market Efficiency
      - alert: SLOMarketEfficiency
        expr: virtengine_market_efficiency_score < 60
        for: 1h
        labels:
          severity: warning
          slo_id: SLO-MARKET-002
          service: market
          tier: tier1
        annotations:
          summary: "Marketplace efficiency below target"
          description: "Market efficiency score is {{ $value | printf \"%.0f\" }} (target: >60)"
          runbook_url: "https://docs.virtengine.io/runbooks/slo-market-efficiency"

  # =============================================================================
  # Error Budget Burn Rate Alerts (Multi-Window)
  # =============================================================================
  - name: virtengine_error_budget_burn
    interval: 30s
    rules:
      # Fast burn - 2% budget in 1 hour (14.4x rate)
      - alert: ErrorBudgetFastBurn
        expr: |
          (
            # 5m burn rate
            sum(rate(virtengine_api_requests_total{status=~"5.."}[5m]))
            / sum(rate(virtengine_api_requests_total[5m]))
          ) > 14.4 * 0.001
          and
          (
            # 1h burn rate
            sum(rate(virtengine_api_requests_total{status=~"5.."}[1h]))
            / sum(rate(virtengine_api_requests_total[1h]))
          ) > 14.4 * 0.001
        for: 2m
        labels:
          severity: critical
          alert_type: error_budget
        annotations:
          summary: "Error budget fast burn detected"
          description: "Error budget is being consumed at 14.4x the sustainable rate"
          runbook_url: "https://docs.virtengine.io/runbooks/error-budget-fast-burn"

      # Slow burn - 5% budget in 6 hours (2x rate)
      - alert: ErrorBudgetSlowBurn
        expr: |
          (
            # 30m burn rate
            sum(rate(virtengine_api_requests_total{status=~"5.."}[30m]))
            / sum(rate(virtengine_api_requests_total[30m]))
          ) > 2 * 0.001
          and
          (
            # 6h burn rate
            sum(rate(virtengine_api_requests_total{status=~"5.."}[6h]))
            / sum(rate(virtengine_api_requests_total[6h]))
          ) > 2 * 0.001
        for: 15m
        labels:
          severity: warning
          alert_type: error_budget
        annotations:
          summary: "Error budget slow burn detected"
          description: "Error budget is being consumed at 2x the sustainable rate"
          runbook_url: "https://docs.virtengine.io/runbooks/error-budget-slow-burn"
