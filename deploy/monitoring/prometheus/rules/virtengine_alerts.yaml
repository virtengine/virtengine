# VirtEngine Production Alert Rules
# MONITOR-31J: Critical, warning, and business alerts

groups:
  - name: virtengine.critical
    interval: 30s
    rules:
      - alert: ConsensusStalled
        expr: increase(cometbft_consensus_height[5m]) == 0
        for: 5m
        labels:
          severity: critical
          tier: tier0
          service: virtengine-node
        annotations:
          summary: "Consensus has stalled - no new blocks in 5 minutes"
          description: "No new blocks have been produced in the last 5 minutes. Consensus may be stalled."
          runbook_url: "https://docs.virtengine.io/runbooks/consensus-stalled"
          dashboard_url: "http://grafana:3000/d/virtengine-overview"

      - alert: ValidatorDown
        expr: count(cometbft_consensus_validator_ready == 1) < (count(cometbft_consensus_validator_ready) * 0.67)
        for: 2m
        labels:
          severity: critical
          tier: tier0
          service: virtengine-node
        annotations:
          summary: "More than 1/3 of validators are down"
          description: "Validator readiness has dropped below 67% of total voting power."
          runbook_url: "https://docs.virtengine.io/runbooks/validator-down"
          dashboard_url: "http://grafana:3000/d/chain-health"

      - alert: EscrowBalanceLow
        expr: virtengine_escrow_balance_total < 1000000000
        for: 10m
        labels:
          severity: critical
          tier: tier1
          service: escrow
        annotations:
          summary: "Escrow balance critically low"
          description: "Escrow balance is below 1000 tokens (minor units)."
          runbook_url: "https://docs.virtengine.io/runbooks/escrow-balance-low"
          dashboard_url: "http://grafana:3000/d/business-metrics"

  - name: virtengine.warning
    interval: 1m
    rules:
      - alert: HighTransactionLatency
        expr: histogram_quantile(0.99, rate(virtengine_tx_latency_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
          tier: tier0
          service: virtengine-node
        annotations:
          summary: "P99 transaction latency exceeds 5 seconds"
          description: "Transaction latency P99 has exceeded 5 seconds for 10 minutes."
          runbook_url: "https://docs.virtengine.io/runbooks/high-transaction-latency"
          dashboard_url: "http://grafana:3000/d/virtengine-overview"

      - alert: VEIDVerificationQueue
        expr: virtengine_veid_pending_verifications > 100
        for: 15m
        labels:
          severity: warning
          tier: tier1
          service: veid
        annotations:
          summary: "VEID verification queue backlog"
          description: "Pending VEID verifications exceed 100 for 15 minutes."
          runbook_url: "https://docs.virtengine.io/runbooks/veid-queue-backlog"
          dashboard_url: "http://grafana:3000/d/veid-module"

      - alert: ProviderHighFailureRate
        expr: rate(virtengine_provider_workload_failures[1h]) / rate(virtengine_provider_workload_starts[1h]) > 0.1
        for: 15m
        labels:
          severity: warning
          tier: tier1
          service: provider-daemon
        annotations:
          summary: "Provider experiencing high workload failure rate (>10%)"
          description: "Provider workload failure rate has exceeded 10% for 15 minutes."
          runbook_url: "https://docs.virtengine.io/runbooks/provider-failure-rate"
          dashboard_url: "http://grafana:3000/d/provider-daemon"

      - alert: MLInferenceTimeout
        expr: rate(virtengine_ml_inference_timeout_total[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
          tier: tier1
          service: ml-inference
        annotations:
          summary: "ML inference timeouts detected"
          description: "ML inference timeout rate is above 0.01/sec."
          runbook_url: "https://docs.virtengine.io/runbooks/ml-inference-timeout"
          dashboard_url: "http://grafana:3000/d/ml-inference"

  - name: virtengine.business
    interval: 5m
    rules:
      - alert: SLOVEIDResponseTime
        expr: |
          (
            sum(rate(virtengine_veid_submission_seconds_bucket{le="10"}[1h]))
            / sum(rate(virtengine_veid_submission_seconds_count[1h]))
          ) < 0.99
        for: 1h
        labels:
          severity: warning
          slo: veid_response_time
          service: veid
          alert_type: slo
        annotations:
          summary: "VEID response time SLO at risk (<99% within 10s)"
          description: "Less than 99% of VEID submissions complete within 10 seconds."
          runbook_url: "https://docs.virtengine.io/runbooks/veid-slo-response-time"
          dashboard_url: "http://grafana:3000/d/veid-module"

      - alert: SLOOrderMatchingSuccess
        expr: |
          (
            sum(rate(virtengine_market_orders_matched[24h]))
            / sum(rate(virtengine_market_orders_created[24h]))
          ) < 0.95
        for: 2h
        labels:
          severity: warning
          slo: order_matching
          service: market
          alert_type: slo
        annotations:
          summary: "Order matching success rate below 95%"
          description: "Order matching success rate has fallen below 95% for 2 hours."
          runbook_url: "https://docs.virtengine.io/runbooks/order-matching-slo"
          dashboard_url: "http://grafana:3000/d/market-module"
