# Promtail Configuration for VirtEngine Log Collection
# https://grafana.com/docs/loki/latest/clients/promtail/configuration/

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# Positions file - tracks which log files have been read
positions:
  filename: /var/promtail/positions.yaml
  sync_period: 10s

# Loki server to send logs to
clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: virtengine
    batchwait: 1s
    batchsize: 1048576  # 1MB
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    external_labels:
      cluster: virtengine-production
      environment: production

# Scrape configurations
scrape_configs:
  # =============================================================================
  # VirtEngine Node Logs
  # =============================================================================
  - job_name: virtengine-node
    static_configs:
      - targets:
          - localhost
        labels:
          job: virtengine-node
          __path__: /var/log/virtengine/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            module: module
            message: msg
            time: time
            block_height: block_height
            tx_hash: tx_hash
      - labels:
          level:
          module:
      - timestamp:
          source: time
          format: RFC3339Nano
      - output:
          source: message

  # =============================================================================
  # Provider Daemon Logs
  # =============================================================================
  - job_name: provider-daemon
    static_configs:
      - targets:
          - localhost
        labels:
          job: provider-daemon
          __path__: /var/log/provider-daemon/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            component: component
            message: msg
            time: time
            provider_address: provider
            deployment_id: deployment_id
            workload_state: workload_state
      - labels:
          level:
          component:
      - timestamp:
          source: time
          format: RFC3339Nano
      - output:
          source: message

  # =============================================================================
  # Benchmark Daemon Logs
  # =============================================================================
  - job_name: benchmark-daemon
    static_configs:
      - targets:
          - localhost
        labels:
          job: benchmark-daemon
          __path__: /var/log/benchmark-daemon/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            component: component
            message: msg
            time: time
            benchmark_type: benchmark_type
            provider_address: provider
      - labels:
          level:
          component:
      - timestamp:
          source: time
          format: RFC3339Nano
      - output:
          source: message

  # =============================================================================
  # ML Inference Logs
  # =============================================================================
  - job_name: ml-inference
    static_configs:
      - targets:
          - localhost
        labels:
          job: ml-inference
          __path__: /var/log/ml-inference/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            model_version: model_version
            message: msg
            time: time
            request_id: request_id
            inference_time_ms: inference_time_ms
      - labels:
          level:
          model_version:
      - timestamp:
          source: time
          format: RFC3339Nano
      - output:
          source: message

  # =============================================================================
  # Kubernetes Pod Logs
  # =============================================================================
  - job_name: kubernetes-pods
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      # Only scrape pods with promtail.io/scrape: true annotation
      - source_labels:
          - __meta_kubernetes_pod_annotation_promtail_io_scrape
        action: keep
        regex: true
      # Use pod name as job name
      - source_labels:
          - __meta_kubernetes_pod_name
        target_label: pod
      # Use namespace
      - source_labels:
          - __meta_kubernetes_namespace
        target_label: namespace
      # Use container name
      - source_labels:
          - __meta_kubernetes_pod_container_name
        target_label: container
      # Use node name
      - source_labels:
          - __meta_kubernetes_pod_node_name
        target_label: node
      # Use app label
      - source_labels:
          - __meta_kubernetes_pod_label_app
        target_label: app
      # Use component label
      - source_labels:
          - __meta_kubernetes_pod_label_component
        target_label: component
      # Set path to pod logs
      - source_labels:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_container_name
        target_label: __path__
        separator: /
        replacement: /var/log/pods/*$1/*.log
    pipeline_stages:
      # Parse Docker/containerd logs
      - cri: {}
      # Try to parse JSON logs
      - json:
          expressions:
            level: level
            module: module
            message: msg
      - labels:
          level:
          module:

  # =============================================================================
  # System Logs (journald)
  # =============================================================================
  - job_name: journal
    journal:
      max_age: 12h
      labels:
        job: systemd-journal
    relabel_configs:
      - source_labels:
          - __journal__systemd_unit
        target_label: unit
      - source_labels:
          - __journal__hostname
        target_label: hostname
    pipeline_stages:
      - json:
          expressions:
            level: PRIORITY
            message: MESSAGE
      - labels:
          level:
      - output:
          source: message

# Target configuration (for service discovery)
target_config:
  sync_period: 10s
