# Blue/Green Deployment Support for Production
# Uses Istio VirtualService for traffic splitting

# Primary (Blue) Service - receives production traffic
apiVersion: v1
kind: Service
metadata:
  name: virtengine-node-blue
  namespace: virtengine-prod
  labels:
    app.kubernetes.io/name: virtengine-node
    app.kubernetes.io/version: blue
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: virtengine-node
    version: blue
  ports:
    - name: rpc
      port: 26657
      targetPort: rpc
    - name: rest
      port: 1317
      targetPort: rest
    - name: grpc
      port: 9090
      targetPort: grpc
---
# Secondary (Green) Service - for canary/new deployment
apiVersion: v1
kind: Service
metadata:
  name: virtengine-node-green
  namespace: virtengine-prod
  labels:
    app.kubernetes.io/name: virtengine-node
    app.kubernetes.io/version: green
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: virtengine-node
    version: green
  ports:
    - name: rpc
      port: 26657
      targetPort: rpc
    - name: rest
      port: 1317
      targetPort: rest
    - name: grpc
      port: 9090
      targetPort: grpc
---
# Istio VirtualService for traffic splitting
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: virtengine-node
  namespace: virtengine-prod
  labels:
    app.kubernetes.io/name: virtengine-node
spec:
  hosts:
    - virtengine-node
    - virtengine-node.virtengine-prod.svc.cluster.local
  http:
    - match:
        - headers:
            x-canary:
              exact: "true"
      route:
        - destination:
            host: virtengine-node-green
            port:
              number: 26657
    - route:
        - destination:
            host: virtengine-node-blue
            port:
              number: 26657
          weight: 100
        - destination:
            host: virtengine-node-green
            port:
              number: 26657
          weight: 0
---
# DestinationRule for circuit breaking
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: virtengine-node
  namespace: virtengine-prod
spec:
  host: virtengine-node
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
  subsets:
    - name: blue
      labels:
        version: blue
    - name: green
      labels:
        version: green
---
# Provider Daemon Blue Service
apiVersion: v1
kind: Service
metadata:
  name: provider-daemon-blue
  namespace: virtengine-prod
  labels:
    app.kubernetes.io/name: provider-daemon
    app.kubernetes.io/version: blue
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: provider-daemon
    version: blue
  ports:
    - name: https
      port: 8443
      targetPort: https
    - name: grpc
      port: 8444
      targetPort: grpc
---
# Provider Daemon Green Service
apiVersion: v1
kind: Service
metadata:
  name: provider-daemon-green
  namespace: virtengine-prod
  labels:
    app.kubernetes.io/name: provider-daemon
    app.kubernetes.io/version: green
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: provider-daemon
    version: green
  ports:
    - name: https
      port: 8443
      targetPort: https
    - name: grpc
      port: 8444
      targetPort: grpc
---
# Provider Daemon VirtualService
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: provider-daemon
  namespace: virtengine-prod
spec:
  hosts:
    - provider-daemon
    - provider-daemon.virtengine-prod.svc.cluster.local
  http:
    - match:
        - headers:
            x-canary:
              exact: "true"
      route:
        - destination:
            host: provider-daemon-green
            port:
              number: 8443
    - route:
        - destination:
            host: provider-daemon-blue
            port:
              number: 8443
          weight: 100
        - destination:
            host: provider-daemon-green
            port:
              number: 8443
          weight: 0
