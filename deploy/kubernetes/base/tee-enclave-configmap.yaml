# VirtEngine TEE Enclave ConfigMap
# TEE-HW-001: Deploy TEE hardware & attestation in production
#
# Configuration for TEE enclave services including platform-specific settings,
# attestation endpoints, and measurement allowlists.
apiVersion: v1
kind: ConfigMap
metadata:
  name: tee-enclave-config
  namespace: virtengine
  labels:
    app.kubernetes.io/name: tee-enclave
    app.kubernetes.io/component: enclave
    app.kubernetes.io/part-of: virtengine
data:
  # TEE Mode: production, development, testing
  VIRTENGINE_TEE_MODE: "production"

  # Require hardware TEE (true in production)
  VIRTENGINE_TEE_REQUIRE_HARDWARE: "true"

  # Never allow debug enclaves in production
  VIRTENGINE_TEE_ALLOW_DEBUG: "false"

  # Attestation configuration
  VIRTENGINE_TEE_ATTESTATION_ENDPOINT: "https://attestation.virtengine.io/v1"
  VIRTENGINE_TEE_CERT_CACHE_PATH: "/var/cache/virtengine/tee-certs"

  # Minimum TCB version for SEV-SNP (BL.TEE.SNP.UC format)
  VIRTENGINE_TEE_MIN_TCB_VERSION: "2.0.8.115"

  # SGX Configuration
  sgx.pccs.endpoint: "https://pccs.virtengine.io/sgx/certification/v4/"
  sgx.quote.provider.library: "/usr/lib/x86_64-linux-gnu/libsgx_dcap_ql.so"
  sgx.enclave.path: "/opt/virtengine/enclaves/veid_scorer.signed.so"
  sgx.require.flc: "true"

  # SEV-SNP Configuration
  sevsnp.kds.base.url: "https://kdsintf.amd.com/vcek/v1"
  sevsnp.product.name: "Milan"
  sevsnp.cert.chain.path: "/var/cache/virtengine/sev-certs"

  # Nitro Configuration
  nitro.enclave.image.path: "/opt/virtengine/enclaves/veid_scorer.eif"
  nitro.cpu.count: "2"
  nitro.memory.mb: "2048"

  # Runtime configuration
  runtime.max.input.size: "10485760"
  runtime.max.execution.time.ms: "5000"
  runtime.max.concurrent.requests: "4"

  # Health check configuration
  health.check.interval.seconds: "30"
  health.attestation.refresh.hours: "24"

  # Logging
  log.level: "info"
  log.format: "json"

---
# TEE Measurement Allowlist ConfigMap
# Contains approved enclave measurements for each platform
apiVersion: v1
kind: ConfigMap
metadata:
  name: tee-measurement-allowlist
  namespace: virtengine
  labels:
    app.kubernetes.io/name: tee-enclave
    app.kubernetes.io/component: enclave
    app.kubernetes.io/part-of: virtengine
data:
  # Allowlist JSON - updated via CI/CD when enclave binaries are rebuilt
  measurements.json: |
    {
      "version": "1.0.0",
      "updated_at": "2026-01-30T00:00:00Z",
      "sgx": {
        "allowed_mrenclaves": [],
        "allowed_mrsigners": []
      },
      "sev_snp": {
        "allowed_launch_digests": []
      },
      "nitro": {
        "allowed_pcr0": [],
        "allowed_pcr1": [],
        "allowed_pcr2": []
      }
    }
