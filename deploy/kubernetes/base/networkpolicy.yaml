# Network Policies
# Restrict traffic flow between components
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: virtengine
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Allow DNS resolution
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: virtengine
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# VirtEngine Node Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: virtengine-node
  namespace: virtengine
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: virtengine-node
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # P2P from anywhere (for validators)
    - from: []
      ports:
        - protocol: TCP
          port: 26656
    # RPC from within cluster
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 26657
    # REST API from within cluster
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 1317
    # gRPC from within cluster
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 9091
    # Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 26660
  egress:
    # P2P to other validators
    - to: []
      ports:
        - protocol: TCP
          port: 26656
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Provider Daemon Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: provider-daemon
  namespace: virtengine
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: provider-daemon
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # HTTPS API
    - from: []
      ports:
        - protocol: TCP
          port: 8443
    # gRPC
    - from: []
      ports:
        - protocol: TCP
          port: 8444
    # Metrics from monitoring
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9100
  egress:
    # To VirtEngine node
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: virtengine-node
      ports:
        - protocol: TCP
          port: 26657
        - protocol: TCP
          port: 9090
    # To lease namespaces (all namespaces starting with lease-)
    - to:
        - namespaceSelector: {}
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # AWS APIs
    - to: []
      ports:
        - protocol: TCP
          port: 443
