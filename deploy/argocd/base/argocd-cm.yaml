# ArgoCD ConfigMap
# Main configuration for ArgoCD
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # Repository server timeout
  timeout.reconciliation: "180s"
  
  # Application controller settings
  application.instanceLabelKey: argocd.argoproj.io/instance
  
  # Resource exclusions (skip certain resources)
  resource.exclusions: |
    - apiGroups:
        - tekton.dev
      clusters:
        - '*'
      kinds:
        - TaskRun
        - PipelineRun
    - apiGroups:
        - cilium.io
      kinds:
        - CiliumIdentity
      clusters:
        - '*'

  # Resource customizations
  resource.customizations: |
    networking.k8s.io/Ingress:
      health.lua: |
        hs = {}
        hs.status = "Healthy"
        return hs
    argoproj.io/Application:
      health.lua: |
        hs = {}
        hs.status = "Progressing"
        hs.message = ""
        if obj.status ~= nil then
          if obj.status.health ~= nil then
            hs.status = obj.status.health.status
            if obj.status.health.message ~= nil then
              hs.message = obj.status.health.message
            end
          end
        end
        return hs

  # URLs
  url: https://argocd.virtengine.io
  
  # OIDC configuration (placeholder - configure per environment)
  # oidc.config: |
  #   name: Okta
  #   issuer: https://virtengine.okta.com
  #   clientID: $argocd-oidc:clientId
  #   clientSecret: $argocd-oidc:clientSecret
  #   requestedScopes: ["openid", "profile", "email", "groups"]

  # Dex configuration for SSO
  dex.config: |
    connectors: []

  # Status badge
  statusbadge.enabled: "true"

  # Kustomize build options
  kustomize.buildOptions: --load-restrictor LoadRestrictionsNone
