package model

import (
	"math/big"
	"time"

	"github.com/virtengine/virtengine/sim/markets"
)

// State represents the current simulation state.
type State struct {
	Time        time.Time
	BlockHeight int64

	TokenSupply  *big.Int
	Staked       *big.Int
	Escrowed     *big.Int
	Burned       *big.Int
	Circulating  *big.Int
	InflationBPS int64
	StakingRatio int64
	APR          int64

	TokenPriceUSD float64
	TokenVelocity float64

	Market markets.MarketState
}

// MarketAction represents a market-level action generated by an agent.
type MarketAction struct {
	ComputeDemand float64
	StorageDemand float64
	GPUDemand     float64
	GasDemand     float64

	ComputeSupply float64
	StorageSupply float64
	GPUSupply     float64
}

// EventType defines an event category.
type EventType string

const (
	EventDemand          EventType = "demand"
	EventSupply          EventType = "supply"
	EventStake           EventType = "stake"
	EventUnstake         EventType = "unstake"
	EventEscrowLock      EventType = "escrow_lock"
	EventEscrowRelease   EventType = "escrow_release"
	EventSettlement      EventType = "settlement"
	EventSlash           EventType = "slash"
	EventPriceManipulate EventType = "price_manipulation"
	EventSybil           EventType = "sybil"
	EventProviderExit    EventType = "provider_exit"
	EventMEV             EventType = "mev_extraction"
)

// Event represents a simulation event.
type Event struct {
	Type      EventType
	Timestamp time.Time
	Data      interface{}
}

// DemandEvent captures user demand signals.
type DemandEvent struct {
	Action MarketAction
}

// SupplyEvent captures provider supply changes.
type SupplyEvent struct {
	Action MarketAction
}

// StakeEvent captures staking and unbonding actions.
type StakeEvent struct {
	Amount *big.Int
}

// EscrowEvent captures escrow lock/release.
type EscrowEvent struct {
	Amount *big.Int
}

// SettlementEvent captures settlement outcomes.
type SettlementEvent struct {
	Amount  *big.Int
	Success bool
}

// SlashEvent captures slashing outcomes.
type SlashEvent struct {
	Amount *big.Int
	Reason string
}

// AttackEvent captures economic attacks.
type AttackEvent struct {
	AttackType string
	ImpactUSD  float64
	CostUSD    float64
}

// ProviderExitEvent captures a provider exiting the market.
type ProviderExitEvent struct {
	ProviderID string
	Capacity   float64
}

// MEVEvent captures MEV extraction actions.
type MEVEvent struct {
	ExtractedFees *big.Int
	ImpactUSD     float64
}
