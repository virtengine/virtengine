{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://virtengine.io/schemas/billing/invoice.json",
  "title": "Invoice",
  "description": "VirtEngine billing invoice schema",
  "type": "object",
  "required": [
    "invoice_id",
    "invoice_number",
    "escrow_id",
    "provider",
    "customer",
    "status",
    "currency",
    "billing_period",
    "line_items",
    "subtotal",
    "total",
    "due_date",
    "issued_at"
  ],
  "properties": {
    "invoice_id": {
      "type": "string",
      "description": "Unique invoice identifier",
      "maxLength": 64,
      "pattern": "^[a-zA-Z0-9-_]+$"
    },
    "invoice_number": {
      "type": "string",
      "description": "Human-readable invoice number",
      "pattern": "^[A-Z]+-[0-9]{8}$"
    },
    "escrow_id": {
      "type": "string",
      "description": "Linked escrow account ID"
    },
    "order_id": {
      "type": "string",
      "description": "Linked marketplace order ID"
    },
    "lease_id": {
      "type": "string",
      "description": "Linked marketplace lease ID"
    },
    "provider": {
      "type": "string",
      "description": "Provider's bech32 address",
      "pattern": "^cosmos1[a-z0-9]{38}$"
    },
    "customer": {
      "type": "string",
      "description": "Customer's bech32 address",
      "pattern": "^cosmos1[a-z0-9]{38}$"
    },
    "status": {
      "type": "string",
      "enum": ["draft", "pending", "paid", "partially_paid", "overdue", "disputed", "cancelled", "refunded"],
      "description": "Invoice status"
    },
    "billing_period": {
      "$ref": "#/definitions/BillingPeriod"
    },
    "line_items": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/LineItem"
      },
      "minItems": 1
    },
    "subtotal": {
      "$ref": "#/definitions/Coins",
      "description": "Sum of line items before adjustments"
    },
    "discounts": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/AppliedDiscount"
      }
    },
    "discount_total": {
      "$ref": "#/definitions/Coins",
      "description": "Total discount amount"
    },
    "tax_details": {
      "$ref": "#/definitions/TaxDetails"
    },
    "tax_total": {
      "$ref": "#/definitions/Coins",
      "description": "Total tax amount"
    },
    "total": {
      "$ref": "#/definitions/Coins",
      "description": "Final amount due (subtotal - discounts + tax)"
    },
    "currency": {
      "type": "string",
      "description": "Primary currency denomination",
      "default": "uvirt"
    },
    "amount_paid": {
      "$ref": "#/definitions/Coins"
    },
    "amount_due": {
      "$ref": "#/definitions/Coins"
    },
    "due_date": {
      "type": "string",
      "format": "date-time",
      "description": "Payment due date"
    },
    "issued_at": {
      "type": "string",
      "format": "date-time",
      "description": "Invoice issue date"
    },
    "paid_at": {
      "type": "string",
      "format": "date-time",
      "description": "Payment completion date"
    },
    "settlement_id": {
      "type": "string",
      "description": "Linked settlement record ID"
    },
    "dispute_window": {
      "$ref": "#/definitions/DisputeWindow"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      }
    },
    "block_height": {
      "type": "integer",
      "description": "Block height when created"
    }
  },
  "definitions": {
    "BillingPeriod": {
      "type": "object",
      "required": ["start_time", "end_time", "period_type"],
      "properties": {
        "start_time": {
          "type": "string",
          "format": "date-time"
        },
        "end_time": {
          "type": "string",
          "format": "date-time"
        },
        "duration_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "period_type": {
          "type": "string",
          "enum": ["hourly", "daily", "weekly", "monthly", "usage_based", "final"]
        },
        "sequence_number": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "LineItem": {
      "type": "object",
      "required": ["line_item_id", "description", "usage_type", "quantity", "unit", "unit_price", "amount"],
      "properties": {
        "line_item_id": {
          "type": "string",
          "description": "Unique line item identifier"
        },
        "description": {
          "type": "string",
          "description": "Charge description"
        },
        "usage_type": {
          "type": "string",
          "enum": ["cpu", "memory", "storage", "network", "gpu", "fixed", "setup", "other"]
        },
        "quantity": {
          "type": "string",
          "description": "Quantity consumed (as decimal string)"
        },
        "unit": {
          "type": "string",
          "description": "Measurement unit"
        },
        "unit_price": {
          "$ref": "#/definitions/DecCoin"
        },
        "amount": {
          "$ref": "#/definitions/Coins"
        },
        "usage_record_ids": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "pricing_tier": {
          "type": "string"
        },
        "discount_applied": {
          "$ref": "#/definitions/Coins"
        },
        "metadata": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "Coins": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Coin"
      }
    },
    "Coin": {
      "type": "object",
      "required": ["denom", "amount"],
      "properties": {
        "denom": {
          "type": "string"
        },
        "amount": {
          "type": "string",
          "pattern": "^[0-9]+$"
        }
      }
    },
    "DecCoin": {
      "type": "object",
      "required": ["denom", "amount"],
      "properties": {
        "denom": {
          "type": "string"
        },
        "amount": {
          "type": "string",
          "description": "Decimal amount as string"
        }
      }
    },
    "AppliedDiscount": {
      "type": "object",
      "required": ["discount_id", "policy_id", "type", "amount"],
      "properties": {
        "discount_id": {
          "type": "string"
        },
        "policy_id": {
          "type": "string"
        },
        "coupon_code": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["percentage", "fixed", "volume", "coupon", "referral", "loyalty"]
        },
        "description": {
          "type": "string"
        },
        "amount": {
          "$ref": "#/definitions/Coins"
        },
        "applied_at": {
          "type": "string",
          "format": "date-time"
        },
        "applied_by": {
          "type": "string"
        }
      }
    },
    "TaxDetails": {
      "type": "object",
      "properties": {
        "jurisdiction": {
          "$ref": "#/definitions/TaxJurisdiction"
        },
        "customer_tax_id": {
          "type": "string"
        },
        "provider_tax_id": {
          "type": "string"
        },
        "exemption_category": {
          "type": "string",
          "enum": ["none", "b2b", "non_profit", "government", "education", "export", "small_business"]
        },
        "tax_line_items": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TaxLineItem"
          }
        },
        "total_tax": {
          "$ref": "#/definitions/Coins"
        },
        "is_reverse_charge": {
          "type": "boolean"
        },
        "reverse_charge_note": {
          "type": "string"
        },
        "tax_point_date": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "TaxJurisdiction": {
      "type": "object",
      "required": ["jurisdiction_id", "country_code", "country_name"],
      "properties": {
        "jurisdiction_id": {
          "type": "string"
        },
        "country_code": {
          "type": "string",
          "minLength": 2,
          "maxLength": 2,
          "description": "ISO 3166-1 alpha-2 country code"
        },
        "country_name": {
          "type": "string"
        },
        "region_code": {
          "type": "string"
        },
        "region_name": {
          "type": "string"
        },
        "tax_rates": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TaxRate"
          }
        }
      }
    },
    "TaxRate": {
      "type": "object",
      "required": ["rate_id", "tax_type", "name", "rate_bps"],
      "properties": {
        "rate_id": {
          "type": "string"
        },
        "tax_type": {
          "type": "string",
          "enum": ["vat", "gst", "sales_tax", "withholding", "service_tax", "digital_services", "other"]
        },
        "name": {
          "type": "string"
        },
        "rate_bps": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10000,
          "description": "Tax rate in basis points (e.g., 2000 = 20%)"
        },
        "is_compound": {
          "type": "boolean"
        },
        "included_in_price": {
          "type": "boolean"
        }
      }
    },
    "TaxLineItem": {
      "type": "object",
      "properties": {
        "tax_rate_id": {
          "type": "string"
        },
        "tax_type": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "rate_bps": {
          "type": "integer"
        },
        "taxable_amount": {
          "$ref": "#/definitions/Coins"
        },
        "tax_amount": {
          "$ref": "#/definitions/Coins"
        },
        "is_exempt": {
          "type": "boolean"
        },
        "exemption_reason": {
          "type": "string"
        }
      }
    },
    "DisputeWindow": {
      "type": "object",
      "required": ["window_id", "invoice_id", "window_start_time", "window_end_time"],
      "properties": {
        "window_id": {
          "type": "string"
        },
        "invoice_id": {
          "type": "string"
        },
        "window_start_time": {
          "type": "string",
          "format": "date-time"
        },
        "window_end_time": {
          "type": "string",
          "format": "date-time"
        },
        "window_duration_seconds": {
          "type": "integer"
        },
        "status": {
          "type": "string",
          "enum": ["open", "under_review", "resolved", "escalated", "closed", "expired"]
        },
        "dispute_reason": {
          "type": "string"
        },
        "resolution": {
          "type": "string",
          "enum": ["none", "provider_win", "customer_win", "partial_refund", "mutual_agreement", "arbitration"]
        },
        "refund_amount": {
          "$ref": "#/definitions/Coins"
        }
      }
    }
  }
}
