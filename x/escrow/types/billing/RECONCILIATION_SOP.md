# Reconciliation Standard Operating Procedure

## Overview

This document defines the Standard Operating Procedure (SOP) for billing reconciliation within the VirtEngine marketplace. Reconciliation ensures that usage records from provider daemons, invoices generated by the billing system, and payouts processed through the settlement system remain consistent and accurate.

The reconciliation process is critical for:

- Ensuring providers receive accurate compensation for resources consumed
- Maintaining customer trust through transparent billing
- Detecting and resolving discrepancies before they escalate
- Providing audit-ready financial records for compliance
- Supporting dispute resolution with verifiable data

---

## Reconciliation Types

### Daily Reconciliation

- **Schedule**: Nightly job at 00:00 UTC
- **Scope**: Previous 24-hour period
- **Purpose**: Catch discrepancies early, generate daily financial reports
- **Output**: Daily reconciliation report with variance analysis

### Weekly Reconciliation

- **Schedule**: Every Sunday at 02:00 UTC
- **Scope**: Previous 7 days with aggregate analysis
- **Purpose**: Identify patterns, validate daily reconciliation accuracy
- **Output**: Weekly summary report with trend analysis

### Monthly Reconciliation

- **Schedule**: 1st of each month at 04:00 UTC
- **Scope**: Previous calendar month
- **Purpose**: Final reconciliation for accounting close, compliance reporting
- **Output**: Monthly reconciliation report, finance export files

### On-Demand Reconciliation

- **Trigger**: Manual request via API or admin console
- **Scope**: User-specified date range
- **Purpose**: Investigation, dispute resolution, ad-hoc audits
- **Output**: Custom reconciliation report

### Settlement-Based Reconciliation

- **Trigger**: Upon settlement batch completion
- **Scope**: All invoices in settlement batch
- **Purpose**: Verify settlement amounts match invoice totals
- **Output**: Settlement reconciliation confirmation

---

## Reconciliation Process Flow

### Step 1: Collect Usage Records from Provider Daemon

- Query `ResourceMetrics` from all active providers
- Aggregate usage by lease ID, resource type, and time period
- Validate data completeness (check for gaps in reporting)
- Store raw usage data for audit trail

### Step 2: Collect Invoices from Billing System

- Retrieve all invoices for the reconciliation period
- Include invoice status, line items, and amounts
- Capture tax calculations and discounts applied
- Store invoice snapshot for comparison

### Step 3: Collect Payout Records from Settlement System

- Query settlement batches for the period
- Map settlements to invoices and providers
- Include payout status and transaction references
- Record settlement timestamps and amounts

### Step 4: Compare Usage to Invoices (Detect Unbilled Usage)

- Match usage records to invoice line items
- Identify usage without corresponding invoice entries
- Flag unbilled usage exceeding threshold
- Generate unbilled usage report

### Step 5: Compare Invoices to Payouts (Detect Unpaid Invoices)

- Match invoices to settlement records
- Identify invoices without corresponding payouts
- Flag overdue settlements
- Generate unpaid invoice report

### Step 6: Calculate Variances and Identify Discrepancies

- Compute variance percentages for all matched records
- Apply variance thresholds (see Variance Thresholds section)
- Categorize discrepancies by type and severity
- Calculate total variance impact

### Step 7: Generate Reconciliation Report

- Compile matched, unmatched, and variance data
- Include summary statistics and totals
- Attach supporting evidence and calculations
- Store report with unique reconciliation ID

### Step 8: Trigger Alerts for Variance Thresholds

- Evaluate each discrepancy against threshold levels
- Send notifications based on severity
- Log alert in audit system
- Update dashboard metrics

### Step 9: Auto-Resolve Minor Discrepancies

- Apply auto-resolution rules for discrepancies below threshold
- Create correction entries with `AutoResolved` status
- Update ledger with adjustment entries
- Log resolution in audit trail

### Step 10: Escalate Significant Discrepancies

- Route discrepancies exceeding thresholds to appropriate level
- Create escalation ticket with evidence
- Notify responsible parties
- Track escalation status and SLA compliance

---

## Discrepancy Types and Handling

| Discrepancy Type   | Description                                      | Handling                                                                 |
| ------------------ | ------------------------------------------------ | ------------------------------------------------------------------------ |
| Amount Mismatch    | Invoice amount differs from calculated usage     | < 1%: Auto-resolve with adjustment; >= 1%: Manual review required        |
| Missing Invoice    | Usage record exists without corresponding invoice| Investigate cause; create invoice if usage is valid                      |
| Missing Settlement | Invoice exists without corresponding payout      | Flag for payout processing; verify provider payment details              |
| Missing Usage      | Invoice exists without corresponding usage record| Investigate provider daemon logs; possible data transmission failure     |
| Duplicate Invoice  | Multiple invoices for same usage period/lease    | Cancel duplicate invoice; apply adjustment to ledger                     |
| Status Mismatch    | Invoice/settlement status inconsistent           | Sync statuses across systems; investigate root cause                     |
| Date Mismatch      | Usage period dates don't align with invoice dates| Review and correct date ranges; adjust billing period if needed          |

---

## Variance Thresholds

| Level     | Variance Range | Action                                           | Notification          |
| --------- | -------------- | ------------------------------------------------ | --------------------- |
| Info      | < 0.5%         | Log for audit; no action required                | None                  |
| Warning   | 0.5% - 2%      | Auto-resolve if within tolerance; monitor trend  | Daily digest          |
| Critical  | 2% - 5%        | Manual review required; hold settlement          | Immediate alert       |
| Emergency | > 5%           | Escalate to management; suspend affected leases  | Immediate escalation  |

---

## Dispute Workflow

### Initiation

- **Timeframe**: Must be initiated within 7 days of invoice date
- **Initiator**: Customer or provider via API or console
- **Requirements**: Invoice ID, dispute reason, supporting evidence
- **Outcome**: Dispute ticket created with unique ID

### Evidence Upload

- **Maximum Files**: 10 files per dispute
- **Maximum Size**: 10 MB per file
- **Accepted Formats**: PDF, PNG, JPG, CSV, JSON, TXT
- **Storage**: Encrypted storage with 7-year retention

### Review Period

- **Duration**: 2 business days for initial review
- **Reviewer**: Assigned based on dispute amount and type
- **Activities**: Evidence evaluation, system log analysis, stakeholder consultation

### Resolution Options

| Resolution Type    | Description                                              |
| ------------------ | -------------------------------------------------------- |
| Provider Win       | Invoice stands; no adjustment made                       |
| Customer Win       | Full refund or credit issued                             |
| Partial Refund     | Agreed percentage refunded to customer                   |
| Mutual Agreement   | Negotiated settlement between parties                    |
| Arbitration        | Escalate to neutral third party for binding decision     |

### Escalation Path

- **Maximum Levels**: 3 escalation levels
- **Level 1 → Level 2**: Automatic after 48 hours without resolution
- **Level 2 → Level 3**: Automatic after 72 hours or manual escalation
- **Final Decision**: Level 3 decision is binding

---

## Correction Process

### Request Correction with Evidence

- Submit correction request via API or admin console
- Include original record ID, proposed correction, and justification
- Attach supporting evidence (receipts, logs, screenshots)
- System validates request format and completeness

### Approval Workflow

| Correction Amount | Approval Type    | Approver               |
| ----------------- | ---------------- | ---------------------- |
| < $100            | Auto-approve     | System                 |
| >= $100           | Manual approval  | Finance team           |
| >= $1,000         | Dual approval    | Finance + Management   |

### Apply Correction Deterministically

- Generate deterministic correction ID from input parameters
- Apply correction atomically to prevent partial updates
- Ensure correction is idempotent (safe to retry)
- Verify correction result matches expected outcome

### Update Ledger with Correction Entry

- Create ledger entry with correction type and amount
- Link entry to original invoice/settlement
- Include reference to approval and evidence
- Update running balances

### Recalculate Invoice/Settlement Amounts

- Recompute affected invoice totals
- Update settlement batch amounts if applicable
- Regenerate affected reports
- Notify affected parties of changes

---

## Escalation Path

| Level   | Handler              | Response Time | Authority                                    |
| ------- | -------------------- | ------------- | -------------------------------------------- |
| Level 1 | Automated System     | 24 hours      | Auto-resolve within thresholds; create alerts|
| Level 2 | Finance Team Review  | 48 hours      | Manual corrections; dispute decisions        |
| Level 3 | Management Escalation| 72 hours      | Final authority; policy exceptions           |

### Escalation Triggers

- **To Level 2**: Variance > 2%, dispute unresolved after 48h, correction >= $100
- **To Level 3**: Variance > 5%, dispute unresolved after 72h, correction >= $1,000, policy exception needed

---

## Finance Export

### Available Formats

| Format | Use Case                              |
| ------ | ------------------------------------- |
| CSV    | Spreadsheet analysis, legacy systems  |
| JSON   | API integration, programmatic access  |

### Export Types

| Export Type     | Contents                                                      |
| --------------- | ------------------------------------------------------------- |
| Reconciliation  | Full reconciliation report with all matched and variance data |
| Disputes        | All disputes with status, evidence references, resolutions    |
| Corrections     | Applied corrections with approval chain and ledger impact     |
| Payouts         | Settlement batches with provider payouts and statuses         |

### Retention Policy

- **Retention Period**: 7 years from creation date
- **Storage**: Encrypted, immutable storage
- **Access**: Audit-logged access with role-based permissions
- **Deletion**: Automated after retention period with compliance verification

---

## Roles and Responsibilities

| Role       | Responsibilities                                                                                   |
| ---------- | -------------------------------------------------------------------------------------------------- |
| System     | Execute automated reconciliation; generate reports; trigger alerts; apply auto-resolutions         |
| Provider   | Submit accurate usage data; respond to disputes within SLA; provide evidence when requested        |
| Customer   | Initiate disputes within timeframe; provide evidence; accept or escalate resolutions               |
| Finance    | Review manual corrections > threshold; resolve disputes; approve exceptions; generate exports      |
| Management | Final escalation authority; policy decisions; approve corrections >= $1,000; audit oversight       |

---

## SLA and Timelines

| Activity                  | Timeline                                    |
| ------------------------- | ------------------------------------------- |
| Reconciliation Report     | Daily by 06:00 UTC                          |
| Dispute Initial Response  | 2 business days                             |
| Correction Application    | 1 business day after approval               |
| Level 1 Escalation        | 24 hours response                           |
| Level 2 Escalation        | 48 hours response                           |
| Level 3 Escalation        | 72 hours response                           |
| Export Generation         | Within 1 hour of request                    |
| Evidence Retention        | 7 years                                     |

---

## Compliance Notes

### Audit Logging

- All reconciliation actions are logged with timestamp, actor, and outcome
- Logs are immutable and retained for 7 years
- Access to logs is role-restricted and audited

### Deterministic Corrections

- All corrections use deterministic algorithms for reproducibility
- Correction outcomes can be independently verified
- Hash of inputs and outputs stored for integrity verification

### Auditor Access

- Finance exports available in standard formats (CSV, JSON)
- Read-only access can be granted to external auditors
- Audit trail includes complete evidence chain
- Reports include reconciliation methodology and variance calculations

### Regulatory Compliance

- Supports SOC 2 Type II audit requirements
- Compatible with GAAP and IFRS reporting standards
- Maintains chain of custody for all financial records
- Supports multi-jurisdiction tax compliance exports

---

## Related Documentation

- [Invoice Lifecycle](./INVOICE_LIFECYCLE.md)
- [Reconciliation Service](./reconciliation_service.go)
- [Dispute Workflow](./dispute_workflow.go)
- [Correction Types](./correction.go)
- [Export Formats](./export.go)
