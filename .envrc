direnv_version_major=$(direnv version | cut -d "." -f1 | tr -d '\n')
direnv_version_minor=$(direnv version | cut -d "." -f2 | tr -d '\n')

if [[ $direnv_version_major -lt 2 ]] || [[ $direnv_version_major -eq 2 ]] && [[ $direnv_version_minor -lt 32 ]]; then
	echo -e "\033[31munsupported direnv version $(direnv version) < 2.32.x"
	exit 1
fi

if [[ "$(ps -p "$$" -o 'comm=')" =~ "bash" ]]; then
	if [ "${BASH_VERSINFO:-0}" -lt 4 ]; then
		echo -e "\033[31mthe environment needs BASH 4 or above" >&2
		exit 1
	fi
fi

if ! has make; then
	echo "make is not installed"
	exit 1
fi

if ! has unzip; then
	echo "unzip is not installed"
	exit 1
fi

if ! has wget; then
	echo "wget is not installed"
	exit 1
fi

if ! has curl; then
	echo "curl is not installed"
	exit 1
fi

if ! has npm; then
	echo "npm is not installed"
	exit 1
fi

if ! has jq; then
	echo "jq is not installed"
	exit 1
fi

if ! has readlink; then
	echo "readlink is not installed"
	exit 1
fi

if ! has pv; then
	echo "pv is not installed"
	exit 1
fi

if ! has lz4; then
	echo "lz4 is not installed"
	exit 1
fi

if [ -z "$GOPATH" ]; then
	GOPATH=$(go env GOPATH)
	export GOPATH
fi

VIRTENGINE_ROOT=$(pwd)
export VIRTENGINE_ROOT

dotenv

TOOLS=${VIRTENGINE_ROOT}/script/tools.sh
SEMVER=${VIRTENGINE_ROOT}/script/semver.sh

GOTOOLCHAIN=$(${TOOLS} gotoolchain)
GOTOOLCHAIN_SEMVER=$(echo "${GOTOOLCHAIN}" | sed 's/go*/v/' | tr -d '\n')

dotenv_if_exists dev.env

if [[ ${GOWORK} != "off" ]] && [[ -f go.work ]]; then
	GOWORK=${VIRTENGINE_ROOT}/go.work
else
	GOWORK=off
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
	# on MacOS disable deprecation warnings security framework
	CGO_CFLAGS=-Wno-deprecated-declarations

	export CGO_CFLAGS
fi

if [ -z "${GOARCH}" ]; then
	GOARCH=$(go env GOARCH)
	export GOARCH
fi

export SEMVER
export GOTOOLCHAIN
export GOTOOLCHAIN_SEMVER
export GOWORK

PATH_add "$VIRTENGINE_DEVCACHE_NODE_BIN"
PATH_add "$VIRTENGINE_DEVCACHE_BIN"

VIRTENGINE_DIRENV_SET=1
VIRTENGINE=$VIRTENGINE_DEVCACHE_BIN/virtengine

export VIRTENGINE_DIRENV_SET
export VIRTENGINE

# Also export VE_ aliases for Makefile compatibility
VE_DIRENV_SET=1
VE_ROOT=$VIRTENGINE_ROOT
VE_DEVCACHE=$VIRTENGINE_DEVCACHE
VE_DEVCACHE_BIN=$VIRTENGINE_DEVCACHE_BIN
VE_DEVCACHE_INCLUDE=$VIRTENGINE_DEVCACHE_INCLUDE
VE_DEVCACHE_VERSIONS=$VIRTENGINE_DEVCACHE_VERSIONS
VE_DEVCACHE_NODE_MODULES=$VIRTENGINE_DEVCACHE_NODE_MODULES
VE_RUN=$VIRTENGINE_RUN
VE_RUN_BIN=$VIRTENGINE_RUN_BIN

export VE_DIRENV_SET
export VE_ROOT
export VE_DEVCACHE
export VE_DEVCACHE_BIN
export VE_DEVCACHE_INCLUDE
export VE_DEVCACHE_VERSIONS
export VE_DEVCACHE_NODE_MODULES
export VE_RUN
export VE_RUN_BIN

# Create cache directories if they don't exist (skip if make cache fails due to missing git tags)
if git describe --tags >/dev/null 2>&1; then
    make cache
else
    echo "Warning: No git tags found. Creating cache directories manually..."
    mkdir -p "$VE_DEVCACHE"
    mkdir -p "$VE_DEVCACHE_BIN"
    mkdir -p "$VE_DEVCACHE_INCLUDE"
    mkdir -p "$VE_DEVCACHE_VERSIONS"
    mkdir -p "$VE_DEVCACHE_NODE_MODULES"
    mkdir -p "$VE_RUN_BIN"
    echo "Consider running: git tag v0.1.0"
fi
