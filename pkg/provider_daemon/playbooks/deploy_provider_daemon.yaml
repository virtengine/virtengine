---
# VirtEngine Provider Daemon Deployment Playbook
# VE-920: Ansible automation for VirtEngine infrastructure
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_provider_daemon.yaml --ask-vault-pass
#   ansible-playbook -i inventory.ini deploy_provider_daemon.yaml --vault-password-file vault.txt

- name: Deploy VirtEngine Provider Daemon
  hosts: provider_daemons
  become: true
  gather_facts: true

  vars:
    provider_user: virtengine
    provider_group: virtengine
    provider_home: /opt/virtengine-provider
    provider_bin: "{{ provider_home }}/bin"
    provider_config: "{{ provider_home }}/config"
    provider_logs: /var/log/virtengine-provider
    provider_version: "{{ provider_version | default('latest') }}"
    provider_download_url: "https://releases.virtengine.com/provider/{{ provider_version }}/provider-daemon-linux-amd64.tar.gz"

  handlers:
    - name: restart provider daemon
      systemd:
        name: virtengine-provider
        state: restarted
        daemon_reload: true

    - name: reload systemd
      systemd:
        daemon_reload: true

  tasks:
    # System Preparation
    - name: Install required packages
      tags: [install, packages]
      apt:
        name:
          - curl
          - wget
          - jq
          - ca-certificates
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    # User and Directory Setup
    - name: Create provider group
      tags: [install, user]
      group:
        name: "{{ provider_group }}"
        state: present

    - name: Create provider user
      tags: [install, user]
      user:
        name: "{{ provider_user }}"
        group: "{{ provider_group }}"
        home: "{{ provider_home }}"
        shell: /bin/bash
        system: true
        create_home: true

    - name: Create provider directories
      tags: [install, directories]
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"
        mode: '0755'
      loop:
        - "{{ provider_bin }}"
        - "{{ provider_config }}"
        - "{{ provider_logs }}"
        - "{{ provider_home }}/keys"

    - name: Set restrictive permissions on keys directory
      tags: [install, directories]
      file:
        path: "{{ provider_home }}/keys"
        mode: '0700'
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"

    # Binary Installation
    - name: Download Provider Daemon binary
      tags: [install, binary]
      get_url:
        url: "{{ provider_download_url }}"
        dest: "/tmp/provider-daemon-{{ provider_version }}.tar.gz"
        mode: '0644'

    - name: Extract Provider Daemon binary
      tags: [install, binary]
      unarchive:
        src: "/tmp/provider-daemon-{{ provider_version }}.tar.gz"
        dest: "{{ provider_bin }}"
        remote_src: true
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"

    - name: Set executable permissions
      tags: [install, binary]
      file:
        path: "{{ provider_bin }}/provider-daemon"
        mode: '0755'

    # Provider Key Configuration (Vault Encrypted)
    - name: Deploy provider key file
      tags: [configure, keys]
      copy:
        content: "{{ provider_key_content }}"
        dest: "{{ provider_home }}/keys/provider.key"
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"
        mode: '0600'
      when: provider_key_content is defined
      no_log: true  # Never log secrets

    - name: Deploy provider key from file
      tags: [configure, keys]
      copy:
        src: "{{ provider_key_file }}"
        dest: "{{ provider_home }}/keys/provider.key"
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"
        mode: '0600'
      when: provider_key_file is defined
      no_log: true

    # Provider Configuration
    - name: Create provider daemon configuration
      tags: [configure, config]
      template:
        src: provider-config.yaml.j2
        dest: "{{ provider_config }}/config.yaml"
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"
        mode: '0640'
      notify: restart provider daemon
      when: use_config_template | default(false)

    - name: Create provider daemon configuration (inline)
      tags: [configure, config]
      copy:
        dest: "{{ provider_config }}/config.yaml"
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"
        mode: '0640'
        content: |
          # VirtEngine Provider Daemon Configuration
          # Generated by Ansible

          provider:
            address: "{{ provider_address }}"
            key_file: "{{ provider_home }}/keys/provider.key"

          chain:
            rpc_endpoint: "{{ virtengine_rpc | default('http://localhost:26657') }}"
            grpc_endpoint: "{{ virtengine_grpc | default('localhost:9090') }}"
            chain_id: "{{ chain_id | default('virtengine-1') }}"

          orchestration:
            type: "{{ orchestration_type | default('kubernetes') }}"
            kubernetes:
              kubeconfig: "{{ kubeconfig_path | default('~/.kube/config') }}"
              namespace_prefix: "{{ namespace_prefix | default('ve-') }}"

          bidding:
            enabled: {{ bidding_enabled | default(true) | lower }}
            min_price:
              cpu: "{{ min_price_cpu | default('10') }}"
              memory: "{{ min_price_memory | default('5') }}"
              storage: "{{ min_price_storage | default('2') }}"

          metrics:
            enabled: {{ metrics_enabled | default(true) | lower }}
            port: {{ metrics_port | default(9100) }}

          logging:
            level: "{{ log_level | default('info') }}"
            format: "{{ log_format | default('json') }}"
            file: "{{ provider_logs }}/provider.log"
      notify: restart provider daemon
      when: not (use_config_template | default(false))

    # Kubeconfig Setup (for Kubernetes orchestration)
    - name: Deploy kubeconfig
      tags: [configure, kubernetes]
      copy:
        content: "{{ kubeconfig_content }}"
        dest: "{{ provider_home }}/.kube/config"
        owner: "{{ provider_user }}"
        group: "{{ provider_group }}"
        mode: '0600'
      when: kubeconfig_content is defined and orchestration_type | default('kubernetes') == 'kubernetes'
      no_log: true

    # Systemd Service
    - name: Create systemd service file
      tags: [service, systemd]
      copy:
        dest: /etc/systemd/system/virtengine-provider.service
        mode: '0644'
        content: |
          [Unit]
          Description=VirtEngine Provider Daemon
          After=network-online.target
          Wants=network-online.target

          [Service]
          User={{ provider_user }}
          Group={{ provider_group }}
          Type=simple
          ExecStart={{ provider_bin }}/provider-daemon run --config {{ provider_config }}/config.yaml
          Restart=always
          RestartSec=5
          LimitNOFILE=65535

          # Security hardening
          NoNewPrivileges=true
          ProtectSystem=strict
          ProtectHome=true
          ReadWritePaths={{ provider_home }} {{ provider_logs }}
          PrivateTmp=true

          # Environment
          Environment="HOME={{ provider_home }}"

          [Install]
          WantedBy=multi-user.target
      notify:
        - reload systemd
        - restart provider daemon

    - name: Enable and start Provider Daemon service
      tags: [service]
      systemd:
        name: virtengine-provider
        enabled: true
        state: started
        daemon_reload: true

    # Health Check
    - name: Wait for provider daemon to start
      tags: [verify]
      wait_for:
        port: "{{ metrics_port | default(9100) }}"
        host: 127.0.0.1
        delay: 5
        timeout: 60
      when: metrics_enabled | default(true)

    - name: Verify provider daemon health
      tags: [verify]
      uri:
        url: "http://127.0.0.1:{{ metrics_port | default(9100) }}/health"
        method: GET
        return_content: true
        status_code: [200, 204]
      register: provider_health
      until: provider_health.status in [200, 204]
      retries: 10
      delay: 5
      ignore_errors: true

    - name: Display provider status
      tags: [verify]
      debug:
        msg: "Provider Daemon is running for address {{ provider_address }}"
      when: provider_health is defined
