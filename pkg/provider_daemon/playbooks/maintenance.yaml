---
# VirtEngine System Maintenance Playbook
# VE-920: Ansible automation for VirtEngine infrastructure
#
# Usage:
#   ansible-playbook -i inventory.ini maintenance.yml --tags "update"
#   ansible-playbook -i inventory.ini maintenance.yml --tags "backup"
#   ansible-playbook -i inventory.ini maintenance.yml --tags "cleanup"

- name: VirtEngine System Maintenance
  hosts: all
  become: true
  gather_facts: true

  vars:
    backup_dir: /var/backups/virtengine
    backup_retention_days: 30
    log_retention_days: 14
    virtengine_data: /opt/virtengine/data
    provider_home: /opt/virtengine-provider

  handlers:
    - name: restart virtengine
      systemd:
        name: virtengine
        state: restarted
      when: "'virtengine_nodes' in group_names"

    - name: restart provider
      systemd:
        name: virtengine-provider
        state: restarted
      when: "'provider_daemons' in group_names"

  tasks:
    # System Updates
    - name: Update apt cache
      tags: [update, packages]
      apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Upgrade all packages
      tags: [update, packages]
      apt:
        upgrade: safe
      when: ansible_os_family == "Debian" and (full_upgrade | default(false))

    - name: Check for security updates only
      tags: [update, security]
      apt:
        upgrade: safe
        update_cache: true
      environment:
        DEBIAN_FRONTEND: noninteractive
      when: ansible_os_family == "Debian" and (security_only | default(true))
      register: apt_upgrade

    # Backup Tasks
    - name: Create backup directory
      tags: [backup]
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0700'

    - name: Create timestamp variable
      tags: [backup]
      set_fact:
        backup_timestamp: "{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}"

    - name: Backup VirtEngine node data
      tags: [backup, node]
      archive:
        path: "{{ virtengine_data }}"
        dest: "{{ backup_dir }}/virtengine-node-{{ backup_timestamp }}.tar.gz"
        format: gz
      when: "'virtengine_nodes' in group_names"

    - name: Backup provider daemon config
      tags: [backup, provider]
      archive:
        path:
          - "{{ provider_home }}/config"
        dest: "{{ backup_dir }}/provider-config-{{ backup_timestamp }}.tar.gz"
        format: gz
      when: "'provider_daemons' in group_names"

    - name: Backup portal configuration
      tags: [backup, portal]
      archive:
        path:
          - /var/www/virtengine-portal/config
          - /etc/nginx/sites-available/virtengine-portal
        dest: "{{ backup_dir }}/portal-config-{{ backup_timestamp }}.tar.gz"
        format: gz
      when: "'portal_servers' in group_names"

    # Cleanup Tasks
    - name: Remove old backups
      tags: [cleanup, backups]
      find:
        paths: "{{ backup_dir }}"
        patterns: "*.tar.gz"
        age: "{{ backup_retention_days }}d"
      register: old_backups

    - name: Delete old backup files
      tags: [cleanup, backups]
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"

    - name: Rotate VirtEngine logs
      tags: [cleanup, logs]
      find:
        paths: /var/log/virtengine
        patterns: "*.log"
        age: "{{ log_retention_days }}d"
      register: old_logs
      when: "'virtengine_nodes' in group_names"

    - name: Compress old log files
      tags: [cleanup, logs]
      command: "gzip {{ item.path }}"
      args:
        creates: "{{ item.path }}.gz"
      loop: "{{ old_logs.files | default([]) }}"
      when: old_logs.files is defined and old_logs.files | length > 0

    - name: Clean apt cache
      tags: [cleanup, packages]
      apt:
        autoclean: true
        autoremove: true
      when: ansible_os_family == "Debian"

    - name: Clean temporary files
      tags: [cleanup, temp]
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/virtengine-*.tar.gz
        - /tmp/provider-daemon-*.tar.gz
        - /tmp/portal-*.tar.gz

    # Disk Space Check
    - name: Check disk space
      tags: [monitor, disk]
      shell: df -h / | tail -1 | awk '{print $5}' | tr -d '%'
      register: disk_usage
      changed_when: false

    - name: Warn if disk space is low
      tags: [monitor, disk]
      debug:
        msg: "WARNING: Disk usage is at {{ disk_usage.stdout }}%"
      when: disk_usage.stdout | int > 80

    - name: Critical disk space alert
      tags: [monitor, disk]
      fail:
        msg: "CRITICAL: Disk usage is at {{ disk_usage.stdout }}% - immediate action required!"
      when: disk_usage.stdout | int > 95 and (fail_on_critical | default(false))

    # Service Health Checks
    - name: Check VirtEngine service status
      tags: [monitor, services]
      systemd:
        name: virtengine
      register: virtengine_service
      when: "'virtengine_nodes' in group_names"

    - name: Check Provider Daemon service status
      tags: [monitor, services]
      systemd:
        name: virtengine-provider
      register: provider_service
      when: "'provider_daemons' in group_names"

    - name: Report service statuses
      tags: [monitor, services]
      debug:
        msg: |
          Service Health Report:
          {% if virtengine_service is defined %}
          - VirtEngine Node: {{ virtengine_service.status.ActiveState | default('N/A') }}
          {% endif %}
          {% if provider_service is defined %}
          - Provider Daemon: {{ provider_service.status.ActiveState | default('N/A') }}
          {% endif %}

    # Memory and CPU Check
    - name: Get memory usage
      tags: [monitor, memory]
      shell: free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2}'
      register: memory_usage
      changed_when: false

    - name: Get CPU load average
      tags: [monitor, cpu]
      shell: uptime | awk -F'load average:' '{print $2}' | awk -F',' '{print $1}'
      register: cpu_load
      changed_when: false

    - name: System resource report
      tags: [monitor]
      debug:
        msg: |
          System Resource Report for {{ inventory_hostname }}:
          - Memory Usage: {{ memory_usage.stdout }}
          - CPU Load (1min): {{ cpu_load.stdout }}
          - Disk Usage: {{ disk_usage.stdout }}%

    # Certificate Check
    - name: Check SSL certificate expiration
      tags: [monitor, ssl]
      shell: |
        if [ -f /etc/letsencrypt/live/{{ portal_domain | default('localhost') }}/fullchain.pem ]; then
          openssl x509 -enddate -noout -in /etc/letsencrypt/live/{{ portal_domain }}/fullchain.pem | cut -d= -f2
        else
          echo "N/A"
        fi
      register: cert_expiry
      changed_when: false
      when: "'portal_servers' in group_names"

    - name: Report certificate expiration
      tags: [monitor, ssl]
      debug:
        msg: "SSL Certificate expires: {{ cert_expiry.stdout }}"
      when: "'portal_servers' in group_names and cert_expiry.stdout != 'N/A'"

    # Chain Sync Check (for nodes)
    - name: Check chain sync status
      tags: [monitor, chain]
      uri:
        url: "http://127.0.0.1:26657/status"
        method: GET
        return_content: true
      register: chain_status
      when: "'virtengine_nodes' in group_names"
      ignore_errors: true

    - name: Report chain sync status
      tags: [monitor, chain]
      debug:
        msg: |
          Chain Status:
          - Latest Block: {{ chain_status.json.result.sync_info.latest_block_height | default('N/A') }}
          - Catching Up: {{ chain_status.json.result.sync_info.catching_up | default('N/A') }}
      when: "'virtengine_nodes' in group_names and chain_status is defined and chain_status.json is defined"
