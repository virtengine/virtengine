---
# VirtEngine Node Deployment Playbook
# VE-920: Ansible automation for VirtEngine infrastructure
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_virtengine_node.yml
#   ansible-playbook -i inventory.ini deploy_virtengine_node.yml --tags "install"
#   ansible-playbook -i inventory.ini deploy_virtengine_node.yml --check

- name: Deploy VirtEngine Blockchain Node
  hosts: virtengine_nodes
  become: true
  gather_facts: true

  vars:
    virtengine_user: virtengine
    virtengine_group: virtengine
    virtengine_home: /opt/virtengine
    virtengine_bin: "{{ virtengine_home }}/bin"
    virtengine_data: "{{ virtengine_home }}/data"
    virtengine_config: "{{ virtengine_home }}/config"
    virtengine_logs: /var/log/virtengine
    virtengine_version: "{{ virtengine_version | default('latest') }}"
    virtengine_download_url: "https://releases.virtengine.io/{{ virtengine_version }}/virtengine-linux-amd64.tar.gz"

  handlers:
    - name: restart virtengine
      systemd:
        name: virtengine
        state: restarted
        daemon_reload: true

    - name: reload systemd
      systemd:
        daemon_reload: true

  tasks:
    # System Preparation
    - name: Install required packages
      tags: [install, packages]
      apt:
        name:
          - curl
          - wget
          - jq
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Install required packages (RHEL)
      tags: [install, packages]
      yum:
        name:
          - curl
          - wget
          - jq
          - ca-certificates
        state: present
      when: ansible_os_family == "RedHat"

    # User and Directory Setup
    - name: Create virtengine group
      tags: [install, user]
      group:
        name: "{{ virtengine_group }}"
        state: present

    - name: Create virtengine user
      tags: [install, user]
      user:
        name: "{{ virtengine_user }}"
        group: "{{ virtengine_group }}"
        home: "{{ virtengine_home }}"
        shell: /bin/bash
        system: true
        create_home: true

    - name: Create virtengine directories
      tags: [install, directories]
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ virtengine_user }}"
        group: "{{ virtengine_group }}"
        mode: '0755'
      loop:
        - "{{ virtengine_bin }}"
        - "{{ virtengine_data }}"
        - "{{ virtengine_config }}"
        - "{{ virtengine_logs }}"

    # Binary Installation
    - name: Download VirtEngine binary
      tags: [install, binary]
      get_url:
        url: "{{ virtengine_download_url }}"
        dest: "/tmp/virtengine-{{ virtengine_version }}.tar.gz"
        mode: '0644'

    - name: Extract VirtEngine binary
      tags: [install, binary]
      unarchive:
        src: "/tmp/virtengine-{{ virtengine_version }}.tar.gz"
        dest: "{{ virtengine_bin }}"
        remote_src: true
        owner: "{{ virtengine_user }}"
        group: "{{ virtengine_group }}"

    - name: Set executable permissions
      tags: [install, binary]
      file:
        path: "{{ virtengine_bin }}/virtengined"
        mode: '0755'

    - name: Create symlink to /usr/local/bin
      tags: [install, binary]
      file:
        src: "{{ virtengine_bin }}/virtengined"
        dest: /usr/local/bin/virtengined
        state: link

    # Node Configuration
    - name: Initialize node
      tags: [configure, init]
      command: >
        {{ virtengine_bin }}/virtengined init "{{ moniker }}"
        --chain-id "{{ chain_id }}"
        --home "{{ virtengine_data }}"
      args:
        creates: "{{ virtengine_data }}/config/genesis.json"
      become_user: "{{ virtengine_user }}"
      when: moniker is defined and chain_id is defined

    - name: Copy genesis file
      tags: [configure, genesis]
      copy:
        src: "{{ genesis_file }}"
        dest: "{{ virtengine_data }}/config/genesis.json"
        owner: "{{ virtengine_user }}"
        group: "{{ virtengine_group }}"
        mode: '0644'
      when: genesis_file is defined
      notify: restart virtengine

    - name: Configure config.toml
      tags: [configure, config]
      template:
        src: config.toml.j2
        dest: "{{ virtengine_data }}/config/config.toml"
        owner: "{{ virtengine_user }}"
        group: "{{ virtengine_group }}"
        mode: '0644'
      notify: restart virtengine
      when: configure_config_toml | default(false)

    - name: Configure app.toml
      tags: [configure, config]
      template:
        src: app.toml.j2
        dest: "{{ virtengine_data }}/config/app.toml"
        owner: "{{ virtengine_user }}"
        group: "{{ virtengine_group }}"
        mode: '0644'
      notify: restart virtengine
      when: configure_app_toml | default(false)

    - name: Set seeds in config
      tags: [configure, seeds]
      lineinfile:
        path: "{{ virtengine_data }}/config/config.toml"
        regexp: '^seeds = '
        line: 'seeds = "{{ seeds }}"'
      when: seeds is defined
      notify: restart virtengine

    - name: Set persistent peers
      tags: [configure, peers]
      lineinfile:
        path: "{{ virtengine_data }}/config/config.toml"
        regexp: '^persistent_peers = '
        line: 'persistent_peers = "{{ persistent_peers }}"'
      when: persistent_peers is defined
      notify: restart virtengine

    # Systemd Service
    - name: Create systemd service file
      tags: [service, systemd]
      template:
        src: virtengine.service.j2
        dest: /etc/systemd/system/virtengine.service
        mode: '0644'
      notify:
        - reload systemd
        - restart virtengine

    - name: Create systemd service file (inline)
      tags: [service, systemd]
      copy:
        dest: /etc/systemd/system/virtengine.service
        mode: '0644'
        content: |
          [Unit]
          Description=VirtEngine Blockchain Node
          After=network-online.target
          Wants=network-online.target

          [Service]
          User={{ virtengine_user }}
          Group={{ virtengine_group }}
          Type=simple
          ExecStart={{ virtengine_bin }}/virtengined start --home {{ virtengine_data }}
          Restart=always
          RestartSec=3
          LimitNOFILE=65535

          # Security hardening
          NoNewPrivileges=true
          ProtectSystem=strict
          ProtectHome=true
          ReadWritePaths={{ virtengine_data }} {{ virtengine_logs }}
          PrivateTmp=true

          [Install]
          WantedBy=multi-user.target
      notify:
        - reload systemd
        - restart virtengine
      when: not (virtengine_service_template is defined)

    - name: Enable and start VirtEngine service
      tags: [service]
      systemd:
        name: virtengine
        enabled: true
        state: started
        daemon_reload: true

    # Firewall Configuration
    - name: Configure firewall for P2P port
      tags: [firewall]
      ufw:
        rule: allow
        port: "{{ p2p_port | default('26656') }}"
        proto: tcp
      when: configure_firewall | default(false)

    - name: Configure firewall for RPC port
      tags: [firewall]
      ufw:
        rule: allow
        port: "{{ rpc_port | default('26657') }}"
        proto: tcp
      when: configure_firewall | default(false) and expose_rpc | default(false)

    # Health Check
    - name: Wait for node to start
      tags: [verify]
      wait_for:
        port: "{{ rpc_port | default('26657') }}"
        host: 127.0.0.1
        delay: 5
        timeout: 60

    - name: Verify node status
      tags: [verify]
      uri:
        url: "http://127.0.0.1:{{ rpc_port | default('26657') }}/status"
        method: GET
        return_content: true
      register: node_status
      until: node_status.status == 200
      retries: 10
      delay: 5

    - name: Display node info
      tags: [verify]
      debug:
        msg: "Node {{ node_status.json.result.node_info.moniker }} is running on network {{ node_status.json.result.node_info.network }}"
      when: node_status is defined and node_status.json is defined
