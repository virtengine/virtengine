---
# VirtEngine Portal Deployment Playbook
# VE-920: Ansible automation for VirtEngine infrastructure
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_portal.yaml --ask-vault-pass

- name: Deploy VirtEngine Portal
  hosts: portal_servers
  become: true
  gather_facts: true

  vars:
    portal_user: www-data
    portal_group: www-data
    portal_root: /var/www/virtengine-portal
    portal_version: "{{ portal_version | default('latest') }}"
    portal_download_url: "https://releases.virtengine.io/portal/{{ portal_version }}/portal-dist.tar.gz"
    nginx_sites_enabled: /etc/nginx/sites-enabled
    nginx_sites_available: /etc/nginx/sites-available

  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted

    - name: reload nginx
      systemd:
        name: nginx
        state: reloaded

    - name: test nginx
      command: nginx -t
      changed_when: false

  tasks:
    # System Preparation
    - name: Install Nginx
      tags: [install, nginx]
      apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    # Portal Directory Setup
    - name: Create portal directory
      tags: [install, directories]
      file:
        path: "{{ portal_root }}"
        state: directory
        owner: "{{ portal_user }}"
        group: "{{ portal_group }}"
        mode: '0755'

    # Download and Deploy Portal
    - name: Download portal distribution
      tags: [install, portal]
      get_url:
        url: "{{ portal_download_url }}"
        dest: "/tmp/portal-{{ portal_version }}.tar.gz"
        mode: '0644'

    - name: Extract portal distribution
      tags: [install, portal]
      unarchive:
        src: "/tmp/portal-{{ portal_version }}.tar.gz"
        dest: "{{ portal_root }}"
        remote_src: true
        owner: "{{ portal_user }}"
        group: "{{ portal_group }}"
        extra_opts: [--strip-components=1]

    # Portal Configuration
    - name: Create portal environment configuration
      tags: [configure, portal]
      template:
        src: portal-env.js.j2
        dest: "{{ portal_root }}/config/env.js"
        owner: "{{ portal_user }}"
        group: "{{ portal_group }}"
        mode: '0644'
      when: use_env_template | default(false)

    - name: Create portal environment configuration (inline)
      tags: [configure, portal]
      copy:
        dest: "{{ portal_root }}/config/env.js"
        owner: "{{ portal_user }}"
        group: "{{ portal_group }}"
        mode: '0644'
        content: |
          window.VIRTENGINE_CONFIG = {
            API_ENDPOINT: "{{ api_endpoint | default('https://api.virtengine.io') }}",
            RPC_ENDPOINT: "{{ rpc_endpoint | default('https://rpc.virtengine.io') }}",
            CHAIN_ID: "{{ chain_id | default('virtengine-1') }}",
            WALLET_CONNECT_PROJECT_ID: "{{ wallet_connect_project_id | default('') }}",
            ENABLE_TESTNET: {{ enable_testnet | default(false) | lower }},
          };
      when: not (use_env_template | default(false))

    # Nginx Configuration
    - name: Create Nginx site configuration
      tags: [configure, nginx]
      copy:
        dest: "{{ nginx_sites_available }}/virtengine-portal"
        mode: '0644'
        content: |
          server {
              listen 80;
              server_name {{ portal_domain }};
              server_tokens off;

              root {{ portal_root }};
              index index.html;

              # Security headers
              add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header Referrer-Policy "strict-origin-when-cross-origin" always;
              add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), interest-cohort=()" always;
              add_header X-Permitted-Cross-Domain-Policies "none" always;
              add_header Cross-Origin-Opener-Policy "same-origin" always;
              add_header Cross-Origin-Resource-Policy "same-site" always;
              add_header Content-Security-Policy "default-src 'self'; base-uri 'self'; frame-ancestors 'none'; object-src 'none'; form-action 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https: wss:; frame-src 'none'; worker-src 'self'; manifest-src 'self'; upgrade-insecure-requests; block-all-mixed-content;" always;

              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_proxied expired no-cache no-store private auth;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;

              # Static file caching
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }

              # API proxy (if needed)
              location /api/ {
                  proxy_pass {{ api_endpoint }}/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }

              # SPA routing
              location / {
                  try_files $uri $uri/ /index.html;
              }

              # Health check endpoint
              location /health {
                  access_log off;
                  return 200 'healthy';
                  add_header Content-Type text/plain;
              }
          }
      notify:
        - test nginx
        - reload nginx

    - name: Enable portal site
      tags: [configure, nginx]
      file:
        src: "{{ nginx_sites_available }}/virtengine-portal"
        dest: "{{ nginx_sites_enabled }}/virtengine-portal"
        state: link
      notify:
        - test nginx
        - reload nginx

    - name: Remove default nginx site
      tags: [configure, nginx]
      file:
        path: "{{ nginx_sites_enabled }}/default"
        state: absent
      notify:
        - test nginx
        - reload nginx
      when: remove_default_site | default(true)

    # SSL/TLS Configuration
    - name: Obtain Let's Encrypt certificate
      tags: [ssl, letsencrypt]
      command: >
        certbot --nginx -d {{ portal_domain }}
        --non-interactive --agree-tos
        --email {{ letsencrypt_email }}
        --redirect
      args:
        creates: "/etc/letsencrypt/live/{{ portal_domain }}/fullchain.pem"
      when: use_letsencrypt | default(false) and letsencrypt_email is defined
      notify: reload nginx

    - name: Deploy custom SSL certificate
      tags: [ssl, custom]
      copy:
        content: "{{ ssl_certificate_content }}"
        dest: "/etc/ssl/certs/virtengine-portal.crt"
        mode: '0644'
      when: ssl_certificate_content is defined
      notify: reload nginx

    - name: Deploy custom SSL private key
      tags: [ssl, custom]
      copy:
        content: "{{ ssl_private_key_content }}"
        dest: "/etc/ssl/private/virtengine-portal.key"
        mode: '0600'
      when: ssl_private_key_content is defined
      no_log: true
      notify: reload nginx

    # Service Management
    - name: Ensure nginx is enabled and running
      tags: [service]
      systemd:
        name: nginx
        enabled: true
        state: started

    # Verification
    - name: Verify portal is accessible
      tags: [verify]
      uri:
        url: "http://{{ portal_domain }}/health"
        method: GET
        status_code: 200
      register: portal_health
      until: portal_health.status == 200
      retries: 5
      delay: 3
      delegate_to: localhost
      become: false
      when: verify_external | default(false)

    - name: Verify portal locally
      tags: [verify]
      uri:
        url: "http://127.0.0.1/health"
        method: GET
        status_code: 200
      register: portal_local_health
      until: portal_local_health.status == 200
      retries: 5
      delay: 2

    - name: Display portal status
      tags: [verify]
      debug:
        msg: "VirtEngine Portal deployed successfully at {{ portal_domain }}"
