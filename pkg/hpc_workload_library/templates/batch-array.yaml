# Batch Array Job Template
# VE-5F: Pre-configured workload templates
#
# This template configures SLURM array jobs for parameter sweeps,
# ensemble simulations, and embarrassingly parallel tasks.

schema_version: "1.0.0"

template:
  template_id: batch-array
  name: Batch Array Job
  version: 1.0.0
  description: >
    Run parameter sweeps, ensemble simulations, or embarrassingly
    parallel tasks using SLURM array jobs. Each array task runs
    independently with a unique task ID for input partitioning.
  type: batch

  runtime:
    runtime_type: singularity
    container_image: library/ubuntu:22.04
    required_modules: []

  resources:
    min_nodes: 1
    max_nodes: 1
    default_nodes: 1
    min_cpus_per_node: 1
    max_cpus_per_node: 64
    default_cpus_per_node: 4
    min_memory_mb_per_node: 512
    max_memory_mb_per_node: 256000
    default_memory_mb_per_node: 8000
    min_runtime_minutes: 1
    max_runtime_minutes: 2880  # 48 hours per task
    default_runtime_minutes: 60
    exclusive_nodes: false

  security:
    allowed_registries:
      - library
      - docker.io
      - ghcr.io
      - quay.io
    require_image_digest: false
    allow_network_access: false
    allow_host_mounts: true
    allowed_host_paths:
      - /scratch
      - /home
      - /work
    sandbox_level: strict
    max_open_files: 16384
    max_processes: 4096
    max_file_size: 10737418240  # 10GB

  entrypoint:
    command: /bin/bash
    default_args:
      - "-c"
    working_directory: /work
    pre_run_script: "echo 'Starting array task $SLURM_ARRAY_TASK_ID of $SLURM_ARRAY_TASK_COUNT'"
    post_run_script: "echo 'Array task $SLURM_ARRAY_TASK_ID completed with exit code $?'"

  environment:
    - name: TASK_ID
      value_template: "${SLURM_ARRAY_TASK_ID}"
      description: Current array task ID (0-indexed)
    - name: TASK_COUNT
      value_template: "${SLURM_ARRAY_TASK_COUNT}"
      description: Total number of array tasks
    - name: TASK_MIN
      value_template: "${SLURM_ARRAY_TASK_MIN}"
      description: Minimum array task ID
    - name: TASK_MAX
      value_template: "${SLURM_ARRAY_TASK_MAX}"
      description: Maximum array task ID
    - name: INPUT_FILE
      value_template: "/data/input/input_${SLURM_ARRAY_TASK_ID}.dat"
      description: Task-specific input file
    - name: OUTPUT_FILE
      value_template: "/data/output/output_${SLURM_ARRAY_TASK_ID}.dat"
      description: Task-specific output file
    - name: TMPDIR
      value: /scratch/$USER/$SLURM_JOB_ID/$SLURM_ARRAY_TASK_ID
      description: Task-specific temp directory

  data_bindings:
    - name: input
      mount_path: /data/input
      data_type: input
      required: true
      read_only: true
    - name: output
      mount_path: /data/output
      data_type: output
      required: true
      read_only: false
    - name: scratch
      mount_path: /scratch
      data_type: scratch
      required: true
      read_only: false

  parameter_schema:
    - name: script
      type: string
      description: Script or command to execute for each task
      required: true
    - name: array_start
      type: int
      description: Array start index
      default: "0"
      min_value: "0"
      max_value: "100000"
    - name: array_end
      type: int
      description: Array end index
      default: "9"
      min_value: "0"
      max_value: "100000"
    - name: array_step
      type: int
      description: Array step size
      default: "1"
      min_value: "1"
      max_value: "1000"
    - name: simultaneous
      type: int
      description: Maximum simultaneous tasks (%N syntax)
      default: "0"
      min_value: "0"
      max_value: "10000"
    - name: throttle_rate
      type: int
      description: Submit rate limit (tasks per minute)
      default: "0"
      min_value: "0"
      max_value: "1000"

  approval_status: approved
  tags:
    - array
    - batch
    - parameter-sweep
    - ensemble
    - embarrassingly-parallel
