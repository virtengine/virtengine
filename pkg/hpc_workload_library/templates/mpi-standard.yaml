# MPI Standard Workload Template
# VE-5F: Pre-configured workload templates
#
# This template configures MPI-based parallel computing workloads
# using OpenMPI with Singularity containers on SLURM clusters.

schema_version: "1.0.0"

template:
  template_id: mpi-standard
  name: MPI Standard Workload
  version: 1.0.0
  description: >
    Standard MPI-based parallel computing workload using OpenMPI.
    Suitable for distributed memory parallel applications with
    multi-node communication.
  type: mpi
  
  runtime:
    runtime_type: singularity
    container_image: library/ubuntu-mpi:22.04
    mpi_implementation: openmpi
    required_modules:
      - openmpi/4.1
      - gcc/11

  resources:
    min_nodes: 1
    max_nodes: 128
    default_nodes: 4
    min_cpus_per_node: 1
    max_cpus_per_node: 128
    default_cpus_per_node: 16
    min_memory_mb_per_node: 1024
    max_memory_mb_per_node: 512000
    default_memory_mb_per_node: 32000
    min_runtime_minutes: 1
    max_runtime_minutes: 2880  # 48 hours
    default_runtime_minutes: 60
    network_required: true
    exclusive_nodes: false

  security:
    allowed_registries:
      - library
      - docker.io
      - ghcr.io
    require_image_digest: false
    allow_network_access: true
    allow_host_mounts: true
    allowed_host_paths:
      - /scratch
      - /home
      - /work
    sandbox_level: basic
    max_open_files: 65536
    max_processes: 32768

  entrypoint:
    command: mpirun
    default_args:
      - "-np"
      - "${SLURM_NTASKS}"
    working_directory: /scratch/$USER/$SLURM_JOB_ID
    use_mpirun: true
    pre_run_script: "mkdir -p /scratch/$USER/$SLURM_JOB_ID"
    post_run_script: "echo 'Job completed at $(date)'"

  environment:
    - name: OMP_NUM_THREADS
      value: "1"
      description: OpenMP threads per MPI rank
    - name: MPI_BUFFER_SIZE
      value: "20971520"
      description: MPI buffer size in bytes

  modules:
    - openmpi/4.1
    - gcc/11

  data_bindings:
    - name: input
      mount_path: /data/input
      data_type: input
      required: false
      read_only: true
    - name: output
      mount_path: /data/output
      data_type: output
      required: false
      read_only: false
    - name: scratch
      mount_path: /scratch
      data_type: scratch
      required: true
      read_only: false

  parameter_schema:
    - name: executable
      type: string
      description: Path to MPI executable
      required: true
    - name: args
      type: string
      description: Arguments to pass to executable
      required: false
    - name: tasks_per_node
      type: int
      description: MPI tasks per node
      default: "16"
      min_value: "1"
      max_value: "128"

  approval_status: approved
  tags:
    - mpi
    - parallel
    - distributed
    - hpc
