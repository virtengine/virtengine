# Singularity Container Workload Template
# VE-5F: Pre-configured workload templates
#
# This template configures custom Singularity/Apptainer container
# workloads on HPC clusters.

schema_version: "1.0.0"

template:
  template_id: singularity-container
  name: Singularity Container Workload
  version: 1.0.0
  description: >
    Run custom Singularity/Apptainer containers on HPC clusters.
    Supports Docker Hub, Singularity Library, and custom SIF files
    with configurable bindings and overlay filesystems.
  type: batch

  runtime:
    runtime_type: singularity
    container_image: library/default:latest
    required_modules:
      - singularity/3.11

  resources:
    min_nodes: 1
    max_nodes: 64
    default_nodes: 1
    min_cpus_per_node: 1
    max_cpus_per_node: 128
    default_cpus_per_node: 8
    min_memory_mb_per_node: 1024
    max_memory_mb_per_node: 512000
    default_memory_mb_per_node: 16000
    min_gpus_per_node: 0
    max_gpus_per_node: 8
    default_gpus_per_node: 0
    gpu_types:
      - nvidia-a100
      - nvidia-v100
      - nvidia-h100
      - amd-mi250
    min_runtime_minutes: 1
    max_runtime_minutes: 4320  # 72 hours
    default_runtime_minutes: 60
    network_required: false
    exclusive_nodes: false

  security:
    allowed_registries:
      - library
      - docker.io
      - ghcr.io
      - quay.io
      - nvcr.io
    require_image_digest: false
    allow_network_access: true
    allow_host_mounts: true
    allowed_host_paths:
      - /scratch
      - /home
      - /work
      - /data
      - /opt
    sandbox_level: basic
    max_open_files: 65536
    max_processes: 16384

  entrypoint:
    command: singularity
    default_args:
      - exec
    working_directory: /work
    pre_run_script: "export SINGULARITY_CACHEDIR=/scratch/$USER/.singularity && mkdir -p $SINGULARITY_CACHEDIR"
    post_run_script: "echo 'Container execution completed at $(date)'"

  environment:
    - name: SINGULARITY_BINDPATH
      value: /scratch,/home,/work
      description: Paths to bind into container
    - name: SINGULARITYENV_OMP_NUM_THREADS
      value_template: "${SLURM_CPUS_PER_TASK}"
      description: OpenMP threads

  modules:
    - singularity/3.11

  data_bindings:
    - name: input
      mount_path: /input
      data_type: input
      required: false
      read_only: true
    - name: output
      mount_path: /output
      data_type: output
      required: false
      read_only: false
    - name: overlay
      mount_path: /overlay
      data_type: scratch
      required: false
      read_only: false

  parameter_schema:
    - name: image
      type: string
      description: Container image (Docker Hub, library://, or .sif path)
      required: true
    - name: command
      type: string
      description: Command to run inside container
      required: true
    - name: bind_paths
      type: string
      description: Additional bind paths (comma separated)
      default: ""
    - name: use_gpu
      type: bool
      description: Enable GPU passthrough (--nv flag)
      default: "false"
    - name: writable_tmpfs
      type: bool
      description: Use writable tmpfs overlay
      default: "false"
    - name: fakeroot
      type: bool
      description: Run with fakeroot for user namespace
      default: "false"

  approval_status: approved
  tags:
    - singularity
    - container
    - apptainer
    - docker
    - portable
