// Package inference provides ML scoring for VEID.
//
// This file contains embedded test vectors for Go-Python conformance testing.
// These vectors are generated by ml/conformance/generate_test_vectors.py
// and must be kept in sync.
//
// Task Reference: VE-3006 - Go-Python Conformance Testing
package inference

import (
	"encoding/json"
	"os"
	"path/filepath"
)

// ============================================================================
// Test Vector Types
// ============================================================================

// TestVectorEntry represents a single conformance test case
// matching the Python-generated format
type TestVectorEntry struct {
	// Name identifies this test case
	Name string `json:"name"`

	// Description explains what this vector tests
	Description string `json:"description"`

	// Input contains the feature input values
	Input TestVectorInput `json:"input"`

	// ExpectedScore is the expected trust score (0-100)
	ExpectedScore float64 `json:"expected_score"`

	// ExpectedTier is the expected trust tier (1-4)
	ExpectedTier int `json:"expected_tier"`

	// ExpectedCodes are the expected reason codes
	ExpectedCodes []string `json:"expected_codes"`

	// ExpectedConfidence is the expected confidence value
	ExpectedConfidence float64 `json:"expected_confidence"`

	// Tolerance is the maximum allowed score difference
	Tolerance float64 `json:"tolerance"`
}

// TestVectorInput contains the input features for a test vector
type TestVectorInput struct {
	// FaceEmbedding is the 512-dimensional face embedding
	FaceEmbedding []float32 `json:"face_embedding"`

	// FaceConfidence is the face detection confidence
	FaceConfidence float32 `json:"face_confidence"`

	// DocQualityScore is the overall document quality score
	DocQualityScore float32 `json:"doc_quality_score"`

	// DocQualityFeatures contains individual document metrics
	DocQualityFeatures TestVectorDocQuality `json:"doc_quality_features"`

	// OCRConfidences maps field name to confidence score
	OCRConfidences map[string]float32 `json:"ocr_confidences"`

	// OCRFieldValidation maps field name to validation status
	OCRFieldValidation map[string]bool `json:"ocr_field_validation"`

	// ScopeTypes lists the identity scope types
	ScopeTypes []string `json:"scope_types"`

	// ScopeCount is the number of scopes
	ScopeCount int `json:"scope_count"`

	// BlockHeight is the simulated block height
	BlockHeight int64 `json:"block_height"`
}

// TestVectorDocQuality contains document quality features
type TestVectorDocQuality struct {
	Sharpness  float32 `json:"sharpness"`
	Brightness float32 `json:"brightness"`
	Contrast   float32 `json:"contrast"`
	NoiseLevel float32 `json:"noise_level"`
	BlurScore  float32 `json:"blur_score"`
}

// ============================================================================
// Predefined Test Vectors
// ============================================================================

// ConformanceTestVectors contains all embedded test vectors for Go-Python matching.
// These were generated by ml/conformance/generate_test_vectors.py with seed=42.
var ConformanceTestVectors = []TestVectorEntry{
	// Vector 1: High-quality verification with all fields passing
	{
		Name:        "high_quality_verification",
		Description: "High-quality face, document, and OCR - should produce high score",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 42, 0.1),
			FaceConfidence: 0.95,
			DocQualityScore: 0.92,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.88,
				Brightness: 0.75,
				Contrast:   0.82,
				NoiseLevel: 0.08,
				BlurScore:  0.05,
			},
			OCRConfidences: map[string]float32{
				"name":            0.95,
				"date_of_birth":   0.92,
				"document_number": 0.98,
				"expiry_date":     0.89,
				"nationality":     0.91,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   true,
				"document_number": true,
				"expiry_date":     true,
				"nationality":     true,
			},
			ScopeTypes: []string{"id_document", "selfie", "face_video"},
			ScopeCount: 3,
			BlockHeight: 1000000,
		},
		ExpectedScore:      87.5,
		ExpectedTier:       4, // Tier 4 = highest trust
		ExpectedCodes:      []string{"SUCCESS", "HIGH_CONFIDENCE"},
		ExpectedConfidence: 0.85,
		Tolerance:          1e-6,
	},

	// Vector 2: Medium-quality verification
	{
		Name:        "medium_quality_verification",
		Description: "Medium quality inputs - should produce moderate score",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 43, 0.15),
			FaceConfidence: 0.82,
			DocQualityScore: 0.75,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.70,
				Brightness: 0.68,
				Contrast:   0.72,
				NoiseLevel: 0.15,
				BlurScore:  0.12,
			},
			OCRConfidences: map[string]float32{
				"name":            0.78,
				"date_of_birth":   0.72,
				"document_number": 0.85,
				"expiry_date":     0.70,
				"nationality":     0.75,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   true,
				"document_number": true,
				"expiry_date":     false,
				"nationality":     true,
			},
			ScopeTypes: []string{"id_document", "selfie"},
			ScopeCount: 2,
			BlockHeight: 1500000,
		},
		ExpectedScore:      62.5,
		ExpectedTier:       3, // Tier 3 = moderate trust
		ExpectedCodes:      []string{"SUCCESS"},
		ExpectedConfidence: 0.625,
		Tolerance:          1e-6,
	},

	// Vector 3: Low-quality document
	{
		Name:        "low_quality_document",
		Description: "Low document quality - should produce lower score with reason codes",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 44, 0.12),
			FaceConfidence: 0.88,
			DocQualityScore: 0.45,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.35,
				Brightness: 0.50,
				Contrast:   0.40,
				NoiseLevel: 0.35,
				BlurScore:  0.40,
			},
			OCRConfidences: map[string]float32{
				"name":            0.55,
				"date_of_birth":   0.48,
				"document_number": 0.60,
				"expiry_date":     0.42,
				"nationality":     0.50,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   false,
				"document_number": true,
				"expiry_date":     false,
				"nationality":     true,
			},
			ScopeTypes: []string{"id_document"},
			ScopeCount: 1,
			BlockHeight: 2000000,
		},
		ExpectedScore:      38.5,
		ExpectedTier:       2, // Tier 2 = low trust
		ExpectedCodes:      []string{"LOW_CONFIDENCE", "LOW_DOC_QUALITY", "LOW_OCR_CONFIDENCE", "INSUFFICIENT_SCOPES"},
		ExpectedConfidence: 0.392,
		Tolerance:          1e-6,
	},

	// Vector 4: Missing face embedding
	{
		Name:        "missing_face_embedding",
		Description: "No face embedding provided - should handle gracefully",
		Input: TestVectorInput{
			FaceEmbedding:  []float32{}, // Empty embedding
			FaceConfidence: 0.0,
			DocQualityScore: 0.85,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.82,
				Brightness: 0.78,
				Contrast:   0.80,
				NoiseLevel: 0.10,
				BlurScore:  0.08,
			},
			OCRConfidences: map[string]float32{
				"name":            0.90,
				"date_of_birth":   0.88,
				"document_number": 0.92,
				"expiry_date":     0.85,
				"nationality":     0.87,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   true,
				"document_number": true,
				"expiry_date":     true,
				"nationality":     true,
			},
			ScopeTypes: []string{"id_document"},
			ScopeCount: 1,
			BlockHeight: 2500000,
		},
		ExpectedScore:      25.0,
		ExpectedTier:       1, // Tier 1 = minimal trust
		ExpectedCodes:      []string{"MISSING_FACE", "INSUFFICIENT_SCOPES"},
		ExpectedConfidence: 0.5,
		Tolerance:          1e-6,
	},

	// Vector 5: Perfect score scenario
	{
		Name:        "perfect_verification",
		Description: "All inputs at maximum quality - should produce near-perfect score",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 45, 0.08),
			FaceConfidence: 0.99,
			DocQualityScore: 0.98,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.95,
				Brightness: 0.85,
				Contrast:   0.92,
				NoiseLevel: 0.02,
				BlurScore:  0.01,
			},
			OCRConfidences: map[string]float32{
				"name":            0.99,
				"date_of_birth":   0.98,
				"document_number": 0.99,
				"expiry_date":     0.97,
				"nationality":     0.98,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   true,
				"document_number": true,
				"expiry_date":     true,
				"nationality":     true,
			},
			ScopeTypes: []string{"id_document", "selfie", "face_video", "biometric"},
			ScopeCount: 4,
			BlockHeight: 3000000,
		},
		ExpectedScore:      95.0,
		ExpectedTier:       4, // Tier 4 = highest trust
		ExpectedCodes:      []string{"SUCCESS", "HIGH_CONFIDENCE"},
		ExpectedConfidence: 0.9,
		Tolerance:          1e-6,
	},

	// Vector 6: Edge case - minimal valid input
	{
		Name:        "minimal_valid_input",
		Description: "Bare minimum valid inputs",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 46, 0.2),
			FaceConfidence: 0.50,
			DocQualityScore: 0.50,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.50,
				Brightness: 0.50,
				Contrast:   0.50,
				NoiseLevel: 0.50,
				BlurScore:  0.50,
			},
			OCRConfidences: map[string]float32{
				"name":            0.50,
				"date_of_birth":   0.50,
				"document_number": 0.50,
				"expiry_date":     0.50,
				"nationality":     0.50,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   false,
				"document_number": true,
				"expiry_date":     false,
				"nationality":     false,
			},
			ScopeTypes: []string{"id_document", "selfie"},
			ScopeCount: 2,
			BlockHeight: 500000,
		},
		ExpectedScore:      50.0,
		ExpectedTier:       2, // Tier 2 = low trust
		ExpectedCodes:      []string{"SUCCESS", "LOW_DOC_QUALITY", "LOW_OCR_CONFIDENCE"},
		ExpectedConfidence: 0.5,
		Tolerance:          1e-6,
	},

	// Vector 7: Passport document type
	{
		Name:        "passport_verification",
		Description: "Passport verification with good quality",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 47, 0.11),
			FaceConfidence: 0.91,
			DocQualityScore: 0.88,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.85,
				Brightness: 0.80,
				Contrast:   0.82,
				NoiseLevel: 0.08,
				BlurScore:  0.06,
			},
			OCRConfidences: map[string]float32{
				"name":            0.92,
				"date_of_birth":   0.89,
				"document_number": 0.95,
				"expiry_date":     0.88,
				"nationality":     0.93,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   true,
				"document_number": true,
				"expiry_date":     true,
				"nationality":     true,
			},
			ScopeTypes: []string{"id_document", "selfie", "face_video"},
			ScopeCount: 3,
			BlockHeight: 1800000,
		},
		ExpectedScore:      85.0,
		ExpectedTier:       4,
		ExpectedCodes:      []string{"SUCCESS", "HIGH_CONFIDENCE"},
		ExpectedConfidence: 0.82,
		Tolerance:          1e-6,
	},

	// Vector 8: Low face confidence
	{
		Name:        "low_face_confidence",
		Description: "Good document but low face confidence",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 48, 0.25),
			FaceConfidence: 0.55,
			DocQualityScore: 0.85,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.82,
				Brightness: 0.78,
				Contrast:   0.80,
				NoiseLevel: 0.10,
				BlurScore:  0.08,
			},
			OCRConfidences: map[string]float32{
				"name":            0.88,
				"date_of_birth":   0.85,
				"document_number": 0.90,
				"expiry_date":     0.82,
				"nationality":     0.86,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   true,
				"document_number": true,
				"expiry_date":     true,
				"nationality":     true,
			},
			ScopeTypes: []string{"id_document", "selfie"},
			ScopeCount: 2,
			BlockHeight: 2200000,
		},
		ExpectedScore:      58.0,
		ExpectedTier:       3,
		ExpectedCodes:      []string{"SUCCESS"},
		ExpectedConfidence: 0.58,
		Tolerance:          1e-6,
	},

	// Vector 9: All OCR fields failed validation
	{
		Name:        "ocr_validation_failure",
		Description: "High confidence OCR but all validations fail",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 49, 0.10),
			FaceConfidence: 0.90,
			DocQualityScore: 0.82,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.80,
				Brightness: 0.75,
				Contrast:   0.78,
				NoiseLevel: 0.12,
				BlurScore:  0.10,
			},
			OCRConfidences: map[string]float32{
				"name":            0.85,
				"date_of_birth":   0.82,
				"document_number": 0.88,
				"expiry_date":     0.80,
				"nationality":     0.83,
			},
			OCRFieldValidation: map[string]bool{
				"name":            false,
				"date_of_birth":   false,
				"document_number": false,
				"expiry_date":     false,
				"nationality":     false,
			},
			ScopeTypes: []string{"id_document", "selfie", "face_video"},
			ScopeCount: 3,
			BlockHeight: 2800000,
		},
		ExpectedScore:      45.0,
		ExpectedTier:       2,
		ExpectedCodes:      []string{"LOW_CONFIDENCE"},
		ExpectedConfidence: 0.46,
		Tolerance:          1e-6,
	},

	// Vector 10: Biometric-only verification
	{
		Name:        "biometric_only",
		Description: "Strong biometric with minimal document",
		Input: TestVectorInput{
			FaceEmbedding:  generateDeterministicEmbedding(512, 50, 0.09),
			FaceConfidence: 0.97,
			DocQualityScore: 0.60,
			DocQualityFeatures: TestVectorDocQuality{
				Sharpness:  0.55,
				Brightness: 0.60,
				Contrast:   0.58,
				NoiseLevel: 0.20,
				BlurScore:  0.18,
			},
			OCRConfidences: map[string]float32{
				"name":            0.60,
				"date_of_birth":   0.55,
				"document_number": 0.65,
				"expiry_date":     0.50,
				"nationality":     0.58,
			},
			OCRFieldValidation: map[string]bool{
				"name":            true,
				"date_of_birth":   true,
				"document_number": true,
				"expiry_date":     false,
				"nationality":     true,
			},
			ScopeTypes: []string{"biometric", "face_video"},
			ScopeCount: 2,
			BlockHeight: 3200000,
		},
		ExpectedScore:      68.0,
		ExpectedTier:       3,
		ExpectedCodes:      []string{"SUCCESS", "LOW_DOC_QUALITY"},
		ExpectedConfidence: 0.68,
		Tolerance:          1e-6,
	},
}

// ============================================================================
// Helper Functions
// ============================================================================

// generateDeterministicEmbedding creates a deterministic embedding vector
// for testing purposes. Uses a simple linear congruential generator.
func generateDeterministicEmbedding(dim int, seed int64, scale float32) []float32 {
	embedding := make([]float32, dim)

	// Simple LCG for deterministic pseudo-random values
	// Using common LCG parameters
	const (
		a = 1664525
		c = 1013904223
		m = 4294967296 // 2^32
	)

	state := uint64(seed)
	for i := 0; i < dim; i++ {
		state = (a*state + c) % m
		// Normalize to [-scale, scale]
		normalized := float32(state)/float32(m)*2*scale - scale
		embedding[i] = normalized
	}

	return embedding
}

// LoadTestVectorsFromFile loads test vectors from a JSON file
func LoadTestVectorsFromFile(path string) ([]TestVectorEntry, error) {
	data, err := os.ReadFile(path)
	if err != nil {
		return nil, err
	}

	var vectors []TestVectorEntry
	if err := json.Unmarshal(data, &vectors); err != nil {
		return nil, err
	}

	return vectors, nil
}

// SaveTestVectorsToFile saves test vectors to a JSON file
func SaveTestVectorsToFile(vectors []TestVectorEntry, path string) error {
	// Ensure directory exists
	dir := filepath.Dir(path)
	if err := os.MkdirAll(dir, 0755); err != nil {
		return err
	}

	data, err := json.MarshalIndent(vectors, "", "  ")
	if err != nil {
		return err
	}

	return os.WriteFile(path, data, 0644)
}

// ConvertToScoreInputs converts a TestVectorInput to ScoreInputs for inference
func (tvi *TestVectorInput) ConvertToScoreInputs() *ScoreInputs {
	return &ScoreInputs{
		FaceEmbedding:   tvi.FaceEmbedding,
		FaceConfidence:  tvi.FaceConfidence,
		DocQualityScore: tvi.DocQualityScore,
		DocQualityFeatures: DocQualityFeatures{
			Sharpness:  tvi.DocQualityFeatures.Sharpness,
			Brightness: tvi.DocQualityFeatures.Brightness,
			Contrast:   tvi.DocQualityFeatures.Contrast,
			NoiseLevel: tvi.DocQualityFeatures.NoiseLevel,
			BlurScore:  tvi.DocQualityFeatures.BlurScore,
		},
		OCRConfidences:     tvi.OCRConfidences,
		OCRFieldValidation: tvi.OCRFieldValidation,
		ScopeTypes:         tvi.ScopeTypes,
		ScopeCount:         tvi.ScopeCount,
		Metadata: InferenceMetadata{
			BlockHeight: tvi.BlockHeight,
		},
	}
}

// GetTestVectorCount returns the number of embedded test vectors
func GetTestVectorCount() int {
	return len(ConformanceTestVectors)
}

// GetTestVectorByName returns a test vector by name
func GetTestVectorByName(name string) (*TestVectorEntry, bool) {
	for i := range ConformanceTestVectors {
		if ConformanceTestVectors[i].Name == name {
			return &ConformanceTestVectors[i], true
		}
	}
	return nil, false
}

// ============================================================================
// Sidecar Test Vector Support
// ============================================================================

// SidecarTestVector represents a test vector for sidecar determinism testing.
type SidecarTestVector struct {
	// ID is the unique identifier for this test vector
	ID string

	// Features is the complete feature vector
	Features []float32

	// ExpectedOutputHash is the expected hash of the output
	ExpectedOutputHash string
}

// GetTestVector returns a sidecar test vector by ID.
func GetTestVector(id string) *SidecarTestVector {
	vec, ok := GetTestVectorByName(id)
	if !ok {
		return nil
	}

	// Build full feature vector from test vector input
	features := buildFullFeatureVector(vec.Input)

	return &SidecarTestVector{
		ID:                 vec.Name,
		Features:           features,
		ExpectedOutputHash: "", // Will be computed at runtime first time
	}
}

// GetDefaultTestVector returns the default test vector for determinism checks.
func GetDefaultTestVector() *SidecarTestVector {
	return GetTestVector("high_quality_verification")
}

// buildFullFeatureVector constructs a complete feature vector from test input.
func buildFullFeatureVector(input TestVectorInput) []float32 {
	features := make([]float32, TotalFeatureDim)

	// Copy face embedding (pad to FaceEmbeddingDim if needed)
	faceLen := len(input.FaceEmbedding)
	if faceLen > FaceEmbeddingDim {
		faceLen = FaceEmbeddingDim
	}
	copy(features[:faceLen], input.FaceEmbedding[:faceLen])

	// Add document quality features
	offset := FaceEmbeddingDim
	features[offset] = input.DocQualityFeatures.Sharpness
	features[offset+1] = input.DocQualityFeatures.Brightness
	features[offset+2] = input.DocQualityFeatures.Contrast
	features[offset+3] = input.DocQualityFeatures.NoiseLevel
	features[offset+4] = input.DocQualityFeatures.BlurScore

	// Add OCR features
	offset += DocQualityDim
	for i, field := range OCRFieldNames {
		if i >= 5 {
			break
		}
		features[offset+i*2] = input.OCRConfidences[field]
		if input.OCRFieldValidation[field] {
			features[offset+i*2+1] = 1.0
		} else {
			features[offset+i*2+1] = 0.0
		}
	}

	// Add metadata features
	offset += OCRFieldsDim
	features[offset] = input.FaceConfidence
	features[offset+1] = input.DocQualityScore
	features[offset+2] = float32(input.ScopeCount)
	// Remaining metadata features are zeros (padding)

	return features
}
